<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN">
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>使用 CodeIgniter 的 Model &mdash; CodeIgniter 4.5.3 中文手册|用户手册|用户指南|中文文档</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../_static/css/citheme.css" />
      <link rel="stylesheet" type="text/css" href="../_static/css/citheme_dark.css" />

  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
        <script src="../_static/translations.js"></script>
        <script src="../_static/js/citheme.js"></script>
        <script src="../_static/js/carbon.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="搜索" href="../search.html" />
    <link rel="next" title="使用实体类" href="entities.html" />
    <link rel="prev" title="数据建模" href="index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html">
            
              <img src="../_static/ci-logo-text.svg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="搜索文档" aria-label="搜索文档" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="导航菜单">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../intro/index.html">欢迎使用 CodeIgniter4</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../intro/index.html">欢迎使用 CodeIgniter4</a></li>
<li class="toctree-l2"><a class="reference internal" href="../intro/requirements.html">服务器需求</a></li>
<li class="toctree-l2"><a class="reference internal" href="../intro/credits.html">致谢</a></li>
<li class="toctree-l2"><a class="reference internal" href="../intro/psr.html">PSR 兼容性</a></li>
<li class="toctree-l2"><a class="reference internal" href="../license.html">许可协议</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../installation/index.html">安装</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../installation/installing_composer.html">Composer 安装</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation/installing_manual.html">手动安装</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation/running.html">运行你的应用程序</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation/troubleshooting.html">故障排除</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation/deployment.html">部署</a></li>
<li class="toctree-l2"><a class="reference internal" href="../changelogs/index.html">变更记录</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation/upgrading.html">从前一版本升级</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation/repositories.html">CodeIgniter 仓库</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tutorial/index.html">构建你的第一个应用程序</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../tutorial/static_pages.html">静态页面</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorial/news_section.html">新闻部分</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorial/create_news_items.html">创建新闻</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorial/conclusion.html">结束语</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../concepts/index.html">CodeIgniter4 概览</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../concepts/structure.html">应用程序结构</a></li>
<li class="toctree-l2"><a class="reference internal" href="../concepts/mvc.html">模型、视图和控制器</a></li>
<li class="toctree-l2"><a class="reference internal" href="../concepts/autoloader.html">自动加载文件</a></li>
<li class="toctree-l2"><a class="reference internal" href="../concepts/services.html">服务</a></li>
<li class="toctree-l2"><a class="reference internal" href="../concepts/factories.html">工厂</a></li>
<li class="toctree-l2"><a class="reference internal" href="../concepts/http.html">处理 HTTP 请求</a></li>
<li class="toctree-l2"><a class="reference internal" href="../concepts/security.html">安全指南</a></li>
<li class="toctree-l2"><a class="reference internal" href="../concepts/goals.html">设计与架构目标</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../general/index.html">常规主题</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../general/configuration.html">配置</a></li>
<li class="toctree-l2"><a class="reference internal" href="../general/urls.html">CodeIgniter URL</a></li>
<li class="toctree-l2"><a class="reference internal" href="../general/helpers.html">辅助函数</a></li>
<li class="toctree-l2"><a class="reference internal" href="../general/common_functions.html">全局函数和常量</a></li>
<li class="toctree-l2"><a class="reference internal" href="../general/logging.html">记录信息</a></li>
<li class="toctree-l2"><a class="reference internal" href="../general/errors.html">错误处理</a></li>
<li class="toctree-l2"><a class="reference internal" href="../general/caching.html">网页缓存</a></li>
<li class="toctree-l2"><a class="reference internal" href="../general/ajax.html">AJAX 请求</a></li>
<li class="toctree-l2"><a class="reference internal" href="../general/modules.html">代码模块</a></li>
<li class="toctree-l2"><a class="reference internal" href="../general/managing_apps.html">管理应用程序</a></li>
<li class="toctree-l2"><a class="reference internal" href="../general/environments.html">处理多个环境</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../incoming/index.html">控制器和路由</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../incoming/routing.html">URI 路由</a></li>
<li class="toctree-l2"><a class="reference internal" href="../incoming/controllers.html">控制器</a></li>
<li class="toctree-l2"><a class="reference internal" href="../incoming/filters.html">控制器过滤器</a></li>
<li class="toctree-l2"><a class="reference internal" href="../incoming/message.html">HTTP 消息</a></li>
<li class="toctree-l2"><a class="reference internal" href="../incoming/request.html">请求类</a></li>
<li class="toctree-l2"><a class="reference internal" href="../incoming/incomingrequest.html">IncomingRequest 类</a></li>
<li class="toctree-l2"><a class="reference internal" href="../incoming/content_negotiation.html">内容协商</a></li>
<li class="toctree-l2"><a class="reference internal" href="../incoming/methodspoofing.html">HTTP 方法欺骗</a></li>
<li class="toctree-l2"><a class="reference internal" href="../incoming/restful.html">RESTful 资源处理</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../outgoing/index.html">构建响应</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../outgoing/views.html">视图</a></li>
<li class="toctree-l2"><a class="reference internal" href="../outgoing/view_renderer.html">视图渲染器</a></li>
<li class="toctree-l2"><a class="reference internal" href="../outgoing/view_layouts.html">视图布局</a></li>
<li class="toctree-l2"><a class="reference internal" href="../outgoing/view_cells.html">视图单元</a></li>
<li class="toctree-l2"><a class="reference internal" href="../outgoing/view_parser.html">视图解析器</a></li>
<li class="toctree-l2"><a class="reference internal" href="../outgoing/view_decorators.html">视图装饰器</a></li>
<li class="toctree-l2"><a class="reference internal" href="../outgoing/table.html">HTML 表格类</a></li>
<li class="toctree-l2"><a class="reference internal" href="../outgoing/response.html">HTTP 响应</a></li>
<li class="toctree-l2"><a class="reference internal" href="../outgoing/api_responses.html">API 响应特性</a></li>
<li class="toctree-l2"><a class="reference internal" href="../outgoing/csp.html">内容安全策略</a></li>
<li class="toctree-l2"><a class="reference internal" href="../outgoing/localization.html">本地化</a></li>
<li class="toctree-l2"><a class="reference internal" href="../outgoing/alternative_php.html">在视图文件中使用 PHP 替代语法</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../database/index.html">使用数据库</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../database/examples.html">快速入门:使用示例</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/configuration.html">数据库配置</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/connecting.html">连接数据库</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/queries.html">运行查询</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/results.html">生成查询结果</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/helpers.html">查询辅助方法</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/query_builder.html">查询构建器类</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/transactions.html">事务</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/metadata.html">获取元数据</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/call_function.html">自定义函数调用</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/events.html">数据库事件</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/utilities.html">数据库实用工具</a></li>
</ul>
</li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">数据建模</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">使用 CodeIgniter 的 Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="entities.html">使用实体类</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../dbmgmt/index.html">管理数据库</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../dbmgmt/forge.html">数据库 Forge</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dbmgmt/migration.html">数据库迁移</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dbmgmt/seeds.html">数据库填充</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dbmgmt/db_commands.html">数据库命令</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../libraries/index.html">类库参考</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../libraries/caching.html">缓存驱动</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libraries/cookies.html">Cookie</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libraries/cors.html">跨域资源共享 (CORS)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libraries/curlrequest.html">CURLRequest 类</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libraries/email.html">Email 类</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libraries/encryption.html">加密服务</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libraries/files.html">处理文件</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libraries/file_collections.html">文件集合</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libraries/honeypot.html">蜜罐类</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libraries/images.html">图像处理类</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libraries/pagination.html">分页</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libraries/publisher.html">Publisher</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libraries/security.html">安全</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libraries/sessions.html">Session 库</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libraries/throttler.html">限速器</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libraries/time.html">时间和日期</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libraries/typography.html">排版</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libraries/uploaded_files.html">处理上传的文件</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libraries/uri.html">使用 URI</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libraries/user_agent.html">User Agent 类</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libraries/validation.html">验证</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../helpers/index.html">辅助函数</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../helpers/array_helper.html">数组辅助函数</a></li>
<li class="toctree-l2"><a class="reference internal" href="../helpers/cookie_helper.html">Cookie 辅助函数</a></li>
<li class="toctree-l2"><a class="reference internal" href="../helpers/date_helper.html">日期辅助函数</a></li>
<li class="toctree-l2"><a class="reference internal" href="../helpers/filesystem_helper.html">文件系统辅助函数</a></li>
<li class="toctree-l2"><a class="reference internal" href="../helpers/form_helper.html">表单辅助函数</a></li>
<li class="toctree-l2"><a class="reference internal" href="../helpers/html_helper.html">HTML 辅助函数</a></li>
<li class="toctree-l2"><a class="reference internal" href="../helpers/inflector_helper.html">Inflector 辅助函数</a></li>
<li class="toctree-l2"><a class="reference internal" href="../helpers/number_helper.html">数字辅助函数</a></li>
<li class="toctree-l2"><a class="reference internal" href="../helpers/security_helper.html">安全辅助函数</a></li>
<li class="toctree-l2"><a class="reference internal" href="../helpers/test_helper.html">测试辅助函数</a></li>
<li class="toctree-l2"><a class="reference internal" href="../helpers/text_helper.html">文本辅助函数</a></li>
<li class="toctree-l2"><a class="reference internal" href="../helpers/url_helper.html">URL 辅助函数</a></li>
<li class="toctree-l2"><a class="reference internal" href="../helpers/xml_helper.html">XML 辅助函数</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../testing/index.html">测试</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../testing/overview.html">入门指南</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing/database.html">数据库</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing/fabricator.html">生成数据</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing/controllers.html">测试控制器</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing/feature.html">HTTP 测试</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing/response.html">测试响应</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing/cli.html">测试 CLI 命令</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing/mocking.html">模拟</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing/benchmark.html">基准测试</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing/debugging.html">调试应用程序</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../cli/index.html">命令行使用</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../cli/cli_overview.html">CLI 概览</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cli/cli_controllers.html">通过 CLI 运行控制器</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cli/spark_commands.html">Spark 命令</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cli/cli_commands.html">创建 Spark 命令</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cli/cli_generators.html">CLI 生成器</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cli/cli_library.html">CLI 库</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cli/cli_request.html">CLIRequest 类</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../extending/index.html">扩展 CodeIgniter</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../extending/core_classes.html">创建核心系统类</a></li>
<li class="toctree-l2"><a class="reference internal" href="../extending/common.html">替换通用函数</a></li>
<li class="toctree-l2"><a class="reference internal" href="../extending/events.html">事件</a></li>
<li class="toctree-l2"><a class="reference internal" href="../extending/basecontroller.html">扩展控制器</a></li>
<li class="toctree-l2"><a class="reference internal" href="../extending/authentication.html">身份验证</a></li>
<li class="toctree-l2"><a class="reference internal" href="../extending/composer_packages.html">创建 Composer 包</a></li>
<li class="toctree-l2"><a class="reference internal" href="../extending/contributing.html">为 CodeIgniter 做贡献</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../libraries/official_packages.html">官方包</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="移动版导航菜单" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">CodeIgniter</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="页面导航">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">数据建模</a></li>
      <li class="breadcrumb-item active">使用 CodeIgniter 的 Model</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="codeigniter-model">
<h1>使用 CodeIgniter 的 Model<a class="headerlink" href="#codeigniter-model" title="此标题的永久链接"></a></h1>
<nav class="contents local" id="id1">
<ul class="simple">
<li><p><a class="reference internal" href="#id2" id="id44">模型</a></p></li>
<li><p><a class="reference internal" href="#accessing-models" id="id45">访问模型</a></p></li>
<li><p><a class="reference internal" href="#id4" id="id46">CodeIgniter 的 Model</a></p></li>
<li><p><a class="reference internal" href="#id5" id="id47">创建你的模型</a></p>
<ul>
<li><p><a class="reference internal" href="#initialize" id="id48">initialize()</a></p></li>
<li><p><a class="reference internal" href="#id6" id="id49">连接数据库</a></p></li>
<li><p><a class="reference internal" href="#id7" id="id50">配置你的模型</a></p>
<ul>
<li><p><a class="reference internal" href="#table" id="id51">$table</a></p></li>
<li><p><a class="reference internal" href="#primarykey" id="id52">$primaryKey</a></p></li>
<li><p><a class="reference internal" href="#useautoincrement" id="id53">$useAutoIncrement</a></p></li>
<li><p><a class="reference internal" href="#returntype" id="id54">$returnType</a></p></li>
<li><p><a class="reference internal" href="#usesoftdeletes" id="id55">$useSoftDeletes</a></p></li>
<li><p><a class="reference internal" href="#allowedfields" id="id56">$allowedFields</a></p></li>
<li><p><a class="reference internal" href="#allowemptyinserts" id="id57">$allowEmptyInserts</a></p></li>
<li><p><a class="reference internal" href="#updateonlychanged" id="id58">$updateOnlyChanged</a></p></li>
<li><p><a class="reference internal" href="#casts" id="id59">$casts</a></p></li>
<li><p><a class="reference internal" href="#id8" id="id60">日期</a></p></li>
<li><p><a class="reference internal" href="#id9" id="id61">验证</a></p></li>
<li><p><a class="reference internal" href="#id10" id="id62">回调</a></p></li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference internal" href="#model-field-casting" id="id63">模型字段类型转换</a></p>
<ul>
<li><p><a class="reference internal" href="#id12" id="id64">定义数据类型</a></p></li>
<li><p><a class="reference internal" href="#id13" id="id65">数据类型</a></p>
<ul>
<li><p><a class="reference internal" href="#csv" id="id66">csv</a></p></li>
<li><p><a class="reference internal" href="#datetime" id="id67">datetime</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id14" id="id68">自定义类型转换</a></p>
<ul>
<li><p><a class="reference internal" href="#id15" id="id69">创建自定义处理程序</a></p></li>
<li><p><a class="reference internal" href="#id16" id="id70">注册自定义处理程序</a></p></li>
<li><p><a class="reference internal" href="#id17" id="id71">参数</a></p></li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference internal" href="#id18" id="id72">使用数据</a></p>
<ul>
<li><p><a class="reference internal" href="#id19" id="id73">查找数据</a></p>
<ul>
<li><p><a class="reference internal" href="#find" id="id74">find()</a></p></li>
<li><p><a class="reference internal" href="#findcolumn" id="id75">findColumn()</a></p></li>
<li><p><a class="reference internal" href="#findall" id="id76">findAll()</a></p></li>
<li><p><a class="reference internal" href="#first" id="id77">first()</a></p></li>
<li><p><a class="reference internal" href="#withdeleted" id="id78">withDeleted()</a></p></li>
<li><p><a class="reference internal" href="#onlydeleted" id="id79">onlyDeleted()</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id20" id="id80">保存数据</a></p>
<ul>
<li><p><a class="reference internal" href="#insert" id="id81">insert()</a></p></li>
<li><p><a class="reference internal" href="#model-allow-empty-inserts" id="id82">allowEmptyInserts()</a></p></li>
<li><p><a class="reference internal" href="#update" id="id83">update()</a></p></li>
<li><p><a class="reference internal" href="#save" id="id84">save()</a></p></li>
<li><p><a class="reference internal" href="#model-saving-dates" id="id85">保存日期</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id23" id="id86">删除数据</a></p>
<ul>
<li><p><a class="reference internal" href="#delete" id="id87">delete()</a></p></li>
<li><p><a class="reference internal" href="#purgedeleted" id="id88">purgeDeleted()</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#in-model-validation" id="id89">模型内验证</a></p>
<ul>
<li><p><a class="reference internal" href="#id25" id="id90">验证数据</a></p></li>
<li><p><a class="reference internal" href="#id26" id="id91">设置验证规则</a></p></li>
<li><p><a class="reference internal" href="#id27" id="id92">获取验证结果</a></p></li>
<li><p><a class="reference internal" href="#model-getting-validation-errors" id="id93">获取验证错误</a></p></li>
<li><p><a class="reference internal" href="#id29" id="id94">检索验证规则</a></p></li>
<li><p><a class="reference internal" href="#id30" id="id95">验证占位符</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id31" id="id96">保护字段</a></p></li>
<li><p><a class="reference internal" href="#id32" id="id97">运行时返回类型更改</a></p>
<ul>
<li><p><a class="reference internal" href="#asarray" id="id98">asArray()</a></p></li>
<li><p><a class="reference internal" href="#asobject" id="id99">asObject()</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id33" id="id100">处理大量数据</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#model-events-callbacks" id="id101">使用查询构建器</a></p>
<ul>
<li><p><a class="reference internal" href="#id35" id="id102">获取模型表的查询构建器</a></p></li>
<li><p><a class="reference internal" href="#id36" id="id103">获取另一个表的查询构建器</a></p></li>
<li><p><a class="reference internal" href="#id37" id="id104">混合使用查询构建器和模型的方法</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#model-events" id="id105">模型事件</a></p>
<ul>
<li><p><a class="reference internal" href="#id39" id="id106">定义回调函数</a></p></li>
<li><p><a class="reference internal" href="#id40" id="id107">指定要运行的回调</a></p></li>
<li><p><a class="reference internal" href="#id41" id="id108">事件参数</a></p></li>
<li><p><a class="reference internal" href="#id42" id="id109">修改 Find* 数据</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id43" id="id110">手动创建模型</a></p></li>
</ul>
</nav>
<section id="id2">
<h2><a class="toc-backref" href="#id44" role="doc-backlink">模型</a><a class="headerlink" href="#id2" title="此标题的永久链接"></a></h2>
<p>CodeIgniter 的 Model 提供了方便的特性和额外的功能,可以使处理数据库中的 <strong>单个表</strong> 更方便。</p>
<p>它内置了对标准的数据库表交互方式大部分帮助器方法,包括查找记录、更新记录、删除记录等等。</p>
</section>
<section id="accessing-models">
<span id="id3"></span><h2><a class="toc-backref" href="#id45" role="doc-backlink">访问模型</a><a class="headerlink" href="#accessing-models" title="此标题的永久链接"></a></h2>
<p>模型通常存储在 <strong>app/Models</strong> 目录中。它们应该具有与目录位置匹配的命名空间,如 <code class="docutils literal notranslate"><span class="pre">namespace</span> <span class="pre">App\Models</span></code>。</p>
<p>你可以通过创建新实例或使用 <a class="reference internal" href="../general/common_functions.html#model" title="model"><code class="xref php php-func docutils literal notranslate"><span class="pre">model()</span></code></a> 辅助函数在类中访问模型。</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="c1">// Create a new class manually.</span>
<span class="nv">$userModel</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\App\Models\UserModel</span><span class="p">();</span>

<span class="c1">// Create a shared instance of the model.</span>
<span class="nv">$userModel</span> <span class="o">=</span> <span class="nx">model</span><span class="p">(</span><span class="s1">&#39;UserModel&#39;</span><span class="p">);</span>
<span class="c1">// or</span>
<span class="nv">$userModel</span> <span class="o">=</span> <span class="nx">model</span><span class="p">(</span><span class="s1">&#39;App\Models\UserModel&#39;</span><span class="p">);</span>
<span class="c1">// or</span>
<span class="nv">$userModel</span> <span class="o">=</span> <span class="nx">model</span><span class="p">(</span><span class="nx">\App\Models\UserModel</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>

<span class="c1">// Create a new class with the model() function.</span>
<span class="nv">$userModel</span> <span class="o">=</span> <span class="nx">model</span><span class="p">(</span><span class="s1">&#39;UserModel&#39;</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span>

<span class="c1">// Create shared instance with a supplied database connection.</span>
<span class="nv">$db</span>        <span class="o">=</span> <span class="nx">db_connect</span><span class="p">(</span><span class="s1">&#39;custom&#39;</span><span class="p">);</span>
<span class="nv">$userModel</span> <span class="o">=</span> <span class="nx">model</span><span class="p">(</span><span class="s1">&#39;UserModel&#39;</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="nv">$db</span><span class="p">);</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">model()</span></code> 内部使用 <code class="docutils literal notranslate"><span class="pre">Factories::models()</span></code>。详情参见 <a class="reference internal" href="../concepts/factories.html#factories-loading-class"><span class="std std-ref">加载类</span></a>。</p>
</section>
<section id="id4">
<h2><a class="toc-backref" href="#id46" role="doc-backlink">CodeIgniter 的 Model</a><a class="headerlink" href="#id4" title="此标题的永久链接"></a></h2>
<p>CodeIgniter 确实提供了一个模型类，该类具有一些不错的功能，包括：</p>
<ul class="simple">
<li><p>自动数据库连接</p></li>
<li><p>基本的 CRUD 方法</p></li>
<li><p><a class="reference internal" href="#in-model-validation"><span class="std std-ref">模型内验证</span></a></p></li>
<li><p><a class="reference internal" href="../libraries/pagination.html#paginating-with-models"><span class="std std-ref">自动分页</span></a></p></li>
<li><p>等等</p></li>
</ul>
<p>该类为从中构建自己的模型提供了可靠的基础,允许你快速构建应用程序的模型层。</p>
</section>
<section id="id5">
<h2><a class="toc-backref" href="#id47" role="doc-backlink">创建你的模型</a><a class="headerlink" href="#id5" title="此标题的永久链接"></a></h2>
<p>要利用 CodeIgniter 的模型,你只需创建一个扩展 <code class="docutils literal notranslate"><span class="pre">CodeIgniter\Model</span></code> 的新模型类:</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">namespace</span> <span class="nx">App\Models</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">CodeIgniter\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">UserModel</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>这个空类方便地访问数据库连接、查询构建器以及其他一些方便的方法。</p>
<section id="initialize">
<h3><a class="toc-backref" href="#id48" role="doc-backlink">initialize()</a><a class="headerlink" href="#initialize" title="此标题的永久链接"></a></h3>
<p>如果你需要在模型中进行其他初始化,可以扩展 <code class="docutils literal notranslate"><span class="pre">initialize()</span></code> 方法,它将在模型的构造函数之后立即运行。这允许你执行额外的步骤,而不需要重复构造函数参数,例如扩展其他模型:</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">namespace</span> <span class="nx">App\Models</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Modules\Authentication\Models\UserAuthModel</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">UserModel</span> <span class="k">extends</span> <span class="nx">UserAuthModel</span>
<span class="p">{</span>
    <span class="c1">// ...</span>

    <span class="sd">/**</span>
<span class="sd">     * Called during initialization. Appends</span>
<span class="sd">     * our custom field to the module&#39;s model.</span>
<span class="sd">     */</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="nf">initialize</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">allowedFields</span><span class="p">[]</span> <span class="o">=</span> <span class="s1">&#39;middlename&#39;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="id6">
<h3><a class="toc-backref" href="#id49" role="doc-backlink">连接数据库</a><a class="headerlink" href="#id6" title="此标题的永久链接"></a></h3>
<p>当首次实例化类时，如果没有将数据库连接实例传递给构造函数，并且如果你没有在模型类上设置 <code class="docutils literal notranslate"><span class="pre">$DBGroup</span></code> 属性，
它将自动连接到数据库配置中设置的默认数据库组。</p>
<p>你可以通过在类中添加 <code class="docutils literal notranslate"><span class="pre">$DBGroup</span></code> 属性来修改每个模型使用的组。
这样可以确保在模型内部，对 <code class="docutils literal notranslate"><span class="pre">$this-&gt;db</span></code> 的任何引用都通过适当的连接进行。</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">namespace</span> <span class="nx">App\Models</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">CodeIgniter\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">UserModel</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="nv">$DBGroup</span> <span class="o">=</span> <span class="s1">&#39;group_name&#39;</span><span class="p">;</span>

    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>你需要将“group_name”替换为数据库配置文件中定义的数据库组名称。</p>
</section>
<section id="id7">
<h3><a class="toc-backref" href="#id50" role="doc-backlink">配置你的模型</a><a class="headerlink" href="#id7" title="此标题的永久链接"></a></h3>
<p>模型类具有一些配置选项,可以设置这些选项以使类的方法无缝为你工作。前两个用于 CRUD 方法来确定使用哪个表以及如何查找所需记录:</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">namespace</span> <span class="nx">App\Models</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">CodeIgniter\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">UserModel</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="nv">$table</span>      <span class="o">=</span> <span class="s1">&#39;users&#39;</span><span class="p">;</span>
    <span class="k">protected</span> <span class="nv">$primaryKey</span> <span class="o">=</span> <span class="s1">&#39;id&#39;</span><span class="p">;</span>

    <span class="k">protected</span> <span class="nv">$useAutoIncrement</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>

    <span class="k">protected</span> <span class="nv">$returnType</span>     <span class="o">=</span> <span class="s1">&#39;array&#39;</span><span class="p">;</span>
    <span class="k">protected</span> <span class="nv">$useSoftDeletes</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>

    <span class="k">protected</span> <span class="nv">$allowedFields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;email&#39;</span><span class="p">];</span>

    <span class="k">protected</span> <span class="nx">bool</span> <span class="nv">$allowEmptyInserts</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
    <span class="k">protected</span> <span class="nx">bool</span> <span class="nv">$updateOnlyChanged</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>

    <span class="c1">// Dates</span>
    <span class="k">protected</span> <span class="nv">$useTimestamps</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
    <span class="k">protected</span> <span class="nv">$dateFormat</span>    <span class="o">=</span> <span class="s1">&#39;datetime&#39;</span><span class="p">;</span>
    <span class="k">protected</span> <span class="nv">$createdField</span>  <span class="o">=</span> <span class="s1">&#39;created_at&#39;</span><span class="p">;</span>
    <span class="k">protected</span> <span class="nv">$updatedField</span>  <span class="o">=</span> <span class="s1">&#39;updated_at&#39;</span><span class="p">;</span>
    <span class="k">protected</span> <span class="nv">$deletedField</span>  <span class="o">=</span> <span class="s1">&#39;deleted_at&#39;</span><span class="p">;</span>

    <span class="c1">// Validation</span>
    <span class="k">protected</span> <span class="nv">$validationRules</span>      <span class="o">=</span> <span class="p">[];</span>
    <span class="k">protected</span> <span class="nv">$validationMessages</span>   <span class="o">=</span> <span class="p">[];</span>
    <span class="k">protected</span> <span class="nv">$skipValidation</span>       <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
    <span class="k">protected</span> <span class="nv">$cleanValidationRules</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>

    <span class="c1">// Callbacks</span>
    <span class="k">protected</span> <span class="nv">$allowCallbacks</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
    <span class="k">protected</span> <span class="nv">$beforeInsert</span>   <span class="o">=</span> <span class="p">[];</span>
    <span class="k">protected</span> <span class="nv">$afterInsert</span>    <span class="o">=</span> <span class="p">[];</span>
    <span class="k">protected</span> <span class="nv">$beforeUpdate</span>   <span class="o">=</span> <span class="p">[];</span>
    <span class="k">protected</span> <span class="nv">$afterUpdate</span>    <span class="o">=</span> <span class="p">[];</span>
    <span class="k">protected</span> <span class="nv">$beforeFind</span>     <span class="o">=</span> <span class="p">[];</span>
    <span class="k">protected</span> <span class="nv">$afterFind</span>      <span class="o">=</span> <span class="p">[];</span>
    <span class="k">protected</span> <span class="nv">$beforeDelete</span>   <span class="o">=</span> <span class="p">[];</span>
    <span class="k">protected</span> <span class="nv">$afterDelete</span>    <span class="o">=</span> <span class="p">[];</span>
<span class="p">}</span>
</pre></div>
</div>
<section id="table">
<h4><a class="toc-backref" href="#id51" role="doc-backlink">$table</a><a class="headerlink" href="#table" title="此标题的永久链接"></a></h4>
<p>指定此模型主要使用的数据库表。这仅适用于内置的 CRUD 方法。在你自己的查询中不受限于只使用此表。</p>
</section>
<section id="primarykey">
<h4><a class="toc-backref" href="#id52" role="doc-backlink">$primaryKey</a><a class="headerlink" href="#primarykey" title="此标题的永久链接"></a></h4>
<p>这是唯一标识表中记录的列的名称。这不一定必须与数据库中指定的主键匹配,但与 <code class="docutils literal notranslate"><span class="pre">find()</span></code> 等方法一起使用时,用于匹配指定的值的列。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>所有模型都必须指定 primaryKey 以使所有功能正常工作。</p>
</div>
</section>
<section id="useautoincrement">
<h4><a class="toc-backref" href="#id53" role="doc-backlink">$useAutoIncrement</a><a class="headerlink" href="#useautoincrement" title="此标题的永久链接"></a></h4>
<p>指定表是否使用 <a class="reference internal" href="#primarykey">$primaryKey</a> 的自增功能。如果设置为 <code class="docutils literal notranslate"><span class="pre">false</span></code>,则你有责任为表中的每条记录提供主键值。当我们想实现 1:1 关系或在模型中使用 UUID 时,此功能可能很方便。默认值为 <code class="docutils literal notranslate"><span class="pre">true</span></code>。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>如果你将 <a class="reference internal" href="#useautoincrement">$useAutoIncrement</a> 设置为 <code class="docutils literal notranslate"><span class="pre">false</span></code>,请确保在数据库中将主键设置为 <code class="docutils literal notranslate"><span class="pre">unique</span></code>。这样可以确保模型的所有功能与以前一样工作。</p>
</div>
</section>
<section id="returntype">
<h4><a class="toc-backref" href="#id54" role="doc-backlink">$returnType</a><a class="headerlink" href="#returntype" title="此标题的永久链接"></a></h4>
<p>模型的 <strong>find*()</strong> 方法将为你减少一些工作，自动返回结果数据，而不是 Result 对象。</p>
<p>此设置允许你定义返回的数据类型。有效值为 ‘<strong>array</strong>’（默认值）、’<strong>object</strong>’ 或者可以与 Result 对象的 <code class="docutils literal notranslate"><span class="pre">getCustomResultObject()</span></code> 方法一起使用的 <strong>类的完全限定名</strong>。</p>
<p>使用类的特殊常量 <code class="docutils literal notranslate"><span class="pre">::class</span></code> 将允许大多数 IDE 自动补全名称，并使重构等功能更好地理解你的代码。</p>
</section>
<section id="usesoftdeletes">
<span id="model-use-soft-deletes"></span><h4><a class="toc-backref" href="#id55" role="doc-backlink">$useSoftDeletes</a><a class="headerlink" href="#usesoftdeletes" title="此标题的永久链接"></a></h4>
<p>如果为 true,那么任何 <code class="docutils literal notranslate"><span class="pre">delete()</span></code> 方法调用都会在数据库中设置 <code class="docutils literal notranslate"><span class="pre">deleted_at</span></code>,而不是真正删除行。这可以在数据可能在其他地方被引用时保留数据,或者可以维护一个“回收站”,其中的对象可以恢复,或者即使只是保留它作为安全轨迹的一部分。如果为 true,则 <strong>find*()</strong> 方法只返回非已删除行,除非在调用 <strong>find*()</strong> 方法之前调用 <code class="docutils literal notranslate"><span class="pre">withDeleted()</span></code> 方法。</p>
<p>这需要数据库中具有与模型的 <a class="reference internal" href="#dateformat">$dateFormat</a> 设置相应的数据类型的 DATETIME 或 INTEGER 字段。默认字段名称为 <code class="docutils literal notranslate"><span class="pre">deleted_at</span></code>,但是可以通过使用 <a class="reference internal" href="#deletedfield">$deletedField</a> 属性将其配置为你选择的任何名称。</p>
<div class="admonition important">
<p class="admonition-title">重要</p>
<p>数据库中的 <code class="docutils literal notranslate"><span class="pre">deleted_at</span></code> 字段必须是 nullable 的。</p>
</div>
</section>
<section id="allowedfields">
<span id="model-allowed-fields"></span><h4><a class="toc-backref" href="#id56" role="doc-backlink">$allowedFields</a><a class="headerlink" href="#allowedfields" title="此标题的永久链接"></a></h4>
<p>当通过 <code class="docutils literal notranslate"><span class="pre">save()</span></code>、<code class="docutils literal notranslate"><span class="pre">insert()</span></code> 或 <code class="docutils literal notranslate"><span class="pre">update()</span></code> 方法设置时,此数组应更新可以设置的字段名称。这些字段名之外的任何字段都会被丢弃。这有助于防止只从表单获取输入并将其全部抛给模型,从而导致潜在的大规模分配漏洞。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p><a class="reference internal" href="#primarykey">$primaryKey</a> 字段永远不应该是允许的字段。</p>
</div>
</section>
<section id="allowemptyinserts">
<h4><a class="toc-backref" href="#id57" role="doc-backlink">$allowEmptyInserts</a><a class="headerlink" href="#allowemptyinserts" title="此标题的永久链接"></a></h4>
<div class="versionadded">
<p><span class="versionmodified added">在 4.3.0 版本加入.</span></p>
</div>
<p>是否允许插入空数据。默认值是 <code class="docutils literal notranslate"><span class="pre">false</span></code>，这意味着如果你尝试插入空数据，将会抛出带有 “There is no data to insert.” 信息的 <code class="docutils literal notranslate"><span class="pre">DataException</span></code>。</p>
<p>你也可以通过 <a class="reference internal" href="#model-allow-empty-inserts"><span class="std std-ref">allowEmptyInserts()</span></a> 方法来改变这个设置。</p>
</section>
<section id="updateonlychanged">
<span id="model-update-only-changed"></span><h4><a class="toc-backref" href="#id58" role="doc-backlink">$updateOnlyChanged</a><a class="headerlink" href="#updateonlychanged" title="此标题的永久链接"></a></h4>
<div class="versionadded">
<p><span class="versionmodified added">在 4.5.0 版本加入.</span></p>
</div>
<p>是否仅更新 <a class="reference internal" href="entities.html"><span class="doc">Entity</span></a> 的已更改字段。默认值是 <code class="docutils literal notranslate"><span class="pre">true</span></code>，这意味着在更新到数据库时仅使用已更改的字段数据。因此，如果你尝试更新一个没有更改的 Entity，将会抛出带有 “There is no data to update.” 信息的 <code class="docutils literal notranslate"><span class="pre">DataException</span></code>。</p>
<p>将此属性设置为 <code class="docutils literal notranslate"><span class="pre">false</span></code> 将确保 Entity 的所有允许字段在任何时候都提交到数据库并进行更新。</p>
</section>
<section id="casts">
<h4><a class="toc-backref" href="#id59" role="doc-backlink">$casts</a><a class="headerlink" href="#casts" title="此标题的永久链接"></a></h4>
<div class="versionadded">
<p><span class="versionmodified added">在 4.5.0 版本加入.</span></p>
</div>
<p>这允许你将从数据库检索到的数据转换为适当的 PHP 类型。
此选项应为一个数组，其中键是字段的名称，值是数据类型。详情请参见 <a class="reference internal" href="#model-field-casting"><span class="std std-ref">模型字段类型转换</span></a>。</p>
</section>
<section id="id8">
<h4><a class="toc-backref" href="#id60" role="doc-backlink">日期</a><a class="headerlink" href="#id8" title="此标题的永久链接"></a></h4>
<section id="usetimestamps">
<h5>$useTimestamps<a class="headerlink" href="#usetimestamps" title="此标题的永久链接"></a></h5>
<p>此布尔值确定是否会向所有插入和更新自动添加当前日期。如果为 <code class="docutils literal notranslate"><span class="pre">true</span></code>,将以 <a class="reference internal" href="#dateformat">$dateFormat</a> 中指定的格式设置当前时间。这需要表中具有数据类型适当的 <strong>created_at</strong>、<strong>updated_at</strong> 和 <strong>deleted_at</strong> 列。也可参考 <a class="reference internal" href="#createdfield">$createdField</a>, <a class="reference internal" href="#updatedfield">$updatedField</a> 和 <a class="reference internal" href="#deletedfield">$deletedField</a>。</p>
</section>
<section id="dateformat">
<h5>$dateFormat<a class="headerlink" href="#dateformat" title="此标题的永久链接"></a></h5>
<p>此值与 <a class="reference internal" href="#usetimestamps">$useTimestamps</a> 和 <a class="reference internal" href="#usesoftdeletes">$useSoftDeletes</a> 一起使用,以确保插入到数据库中的是正确类型的日期值。默认情况下,这会创建 DATETIME 值,但有效选项有: <code class="docutils literal notranslate"><span class="pre">'datetime'</span></code>、 <code class="docutils literal notranslate"><span class="pre">'date'</span></code> 或 <code class="docutils literal notranslate"><span class="pre">'int'</span></code> (UNIX 时间戳)。在缺少或无效的 <a class="reference internal" href="#dateformat">$dateFormat</a> 情况下使用 <a class="reference internal" href="#usesoftdeletes">$useSoftDeletes</a> 或 <a class="reference internal" href="#usetimestamps">$useTimestamps</a> 会引发异常。</p>
</section>
<section id="createdfield">
<h5>$createdField<a class="headerlink" href="#createdfield" title="此标题的永久链接"></a></h5>
<p>指定用于数据记录创建时间戳的数据库字段。如果设置为空字符串 (<code class="docutils literal notranslate"><span class="pre">''</span></code>) 则不更新它(即使启用了 <a class="reference internal" href="#usetimestamps">$useTimestamps</a>)。</p>
</section>
<section id="updatedfield">
<h5>$updatedField<a class="headerlink" href="#updatedfield" title="此标题的永久链接"></a></h5>
<p>指定应该用于保持数据记录更新时间戳的数据库字段。如果设置为空字符串 (<code class="docutils literal notranslate"><span class="pre">''</span></code>) 则不更新它(即使启用了 <a class="reference internal" href="#usetimestamps">$useTimestamps</a>)。</p>
</section>
<section id="deletedfield">
<h5>$deletedField<a class="headerlink" href="#deletedfield" title="此标题的永久链接"></a></h5>
<p>指定用于软删除的数据库字段。参见 <a class="reference internal" href="#model-use-soft-deletes"><span class="std std-ref">$useSoftDeletes</span></a>。</p>
</section>
</section>
<section id="id9">
<h4><a class="toc-backref" href="#id61" role="doc-backlink">验证</a><a class="headerlink" href="#id9" title="此标题的永久链接"></a></h4>
<section id="validationrules">
<h5>$validationRules<a class="headerlink" href="#validationrules" title="此标题的永久链接"></a></h5>
<p>包含 <a class="reference internal" href="../libraries/validation.html#validation-array"><span class="std std-ref">如何保存规则</span></a> 中描述的验证规则数组或包含要应用的验证组名称的字符串,如同一节中所述。下面更详细地描述。</p>
</section>
<section id="validationmessages">
<h5>$validationMessages<a class="headerlink" href="#validationmessages" title="此标题的永久链接"></a></h5>
<p>包含应在验证期间使用的自定义错误消息数组,如 <a class="reference internal" href="../libraries/validation.html#validation-custom-errors"><span class="std std-ref">设置自定义错误消息</span></a> 中所述。下面更详细地描述。</p>
</section>
<section id="skipvalidation">
<h5>$skipValidation<a class="headerlink" href="#skipvalidation" title="此标题的永久链接"></a></h5>
<p>是否应跳过所有 <strong>inserts</strong> 和 <strong>updates</strong> 期间的数据验证。默认值为 <code class="docutils literal notranslate"><span class="pre">false</span></code>,这意味着数据将始终尝试验证。这主要由 <code class="docutils literal notranslate"><span class="pre">skipValidation()</span></code> 方法使用,但可以更改为 <code class="docutils literal notranslate"><span class="pre">true</span></code>,这样该模型永远不会验证。</p>
</section>
<section id="cleanvalidationrules">
<span id="clean-validation-rules"></span><h5>$cleanValidationRules<a class="headerlink" href="#cleanvalidationrules" title="此标题的永久链接"></a></h5>
<p>是否应删除在传入数据中不存在的验证规则。这在 <strong>updates</strong> 中使用。
默认值为 <code class="docutils literal notranslate"><span class="pre">true</span></code>,这意味着在验证之前,将(临时)删除传入数据中不存在字段的验证规则。
这是为了避免仅更新某些字段时的验证错误。</p>
<p>你也可以通过 <code class="docutils literal notranslate"><span class="pre">cleanRules()</span></code> 方法更改此值。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>在 v4.2.7 之前,由于一个 bug, <code class="docutils literal notranslate"><span class="pre">$cleanValidationRules</span></code> 不起作用。</p>
</div>
</section>
</section>
<section id="id10">
<h4><a class="toc-backref" href="#id62" role="doc-backlink">回调</a><a class="headerlink" href="#id10" title="此标题的永久链接"></a></h4>
<section id="allowcallbacks">
<h5>$allowCallbacks<a class="headerlink" href="#allowcallbacks" title="此标题的永久链接"></a></h5>
<p>是否应使用下面定义的回调。参考 <a class="reference internal" href="#model-events"><span class="std std-ref">模型事件</span></a>。</p>
</section>
<section id="beforeinsert">
<h5>$beforeInsert<a class="headerlink" href="#beforeinsert" title="此标题的永久链接"></a></h5>
</section>
<section id="afterinsert">
<h5>$afterInsert<a class="headerlink" href="#afterinsert" title="此标题的永久链接"></a></h5>
</section>
<section id="beforeupdate">
<h5>$beforeUpdate<a class="headerlink" href="#beforeupdate" title="此标题的永久链接"></a></h5>
</section>
<section id="afterupdate">
<h5>$afterUpdate<a class="headerlink" href="#afterupdate" title="此标题的永久链接"></a></h5>
</section>
<section id="beforefind">
<h5>$beforeFind<a class="headerlink" href="#beforefind" title="此标题的永久链接"></a></h5>
</section>
<section id="afterfind">
<h5>$afterFind<a class="headerlink" href="#afterfind" title="此标题的永久链接"></a></h5>
</section>
<section id="beforedelete">
<h5>$beforeDelete<a class="headerlink" href="#beforedelete" title="此标题的永久链接"></a></h5>
</section>
<section id="afterdelete">
<h5>$afterDelete<a class="headerlink" href="#afterdelete" title="此标题的永久链接"></a></h5>
</section>
<section id="beforeinsertbatch">
<h5>$beforeInsertBatch<a class="headerlink" href="#beforeinsertbatch" title="此标题的永久链接"></a></h5>
</section>
<section id="afterinsertbatch">
<h5>$afterInsertBatch<a class="headerlink" href="#afterinsertbatch" title="此标题的永久链接"></a></h5>
</section>
<section id="beforeupdatebatch">
<h5>$beforeUpdateBatch<a class="headerlink" href="#beforeupdatebatch" title="此标题的永久链接"></a></h5>
</section>
<section id="afterupdatebatch">
<h5>$afterUpdateBatch<a class="headerlink" href="#afterupdatebatch" title="此标题的永久链接"></a></h5>
<p>这些数组允许你指定在属性名称中指定的时间回调方法。参考 <a class="reference internal" href="#model-events"><span class="std std-ref">模型事件</span></a>。</p>
</section>
</section>
</section>
</section>
<section id="model-field-casting">
<span id="id11"></span><h2><a class="toc-backref" href="#id63" role="doc-backlink">模型字段类型转换</a><a class="headerlink" href="#model-field-casting" title="此标题的永久链接"></a></h2>
<div class="versionadded">
<p><span class="versionmodified added">在 4.5.0 版本加入.</span></p>
</div>
<p>从数据库检索数据时，整数类型的数据可能会在 PHP 中转换为字符串类型。你可能还希望将日期/时间数据转换为 PHP 中的 Time 对象。</p>
<p>模型字段类型转换允许你将从数据库检索到的数据转换为适当的 PHP 类型。</p>
<div class="admonition important">
<p class="admonition-title">重要</p>
<p>如果你在使用 <a class="reference internal" href="entities.html"><span class="doc">Entity</span></a> 时使用了此功能，请不要使用
<a class="reference internal" href="entities.html#entities-property-casting"><span class="std std-ref">Entity 属性类型转换</span></a>。同时使用这两种类型转换是无效的。</p>
<p>Entity 属性类型转换在 (1)(4) 处工作，而此类型转换在 (2)(3) 处工作:</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="nx">应用代码</span><span class="p">]</span> <span class="o">---</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">--&gt;</span> <span class="p">[</span><span class="nx">Entity</span><span class="p">]</span> <span class="o">---</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">--&gt;</span> <span class="p">[</span><span class="nx">数据库</span><span class="p">]</span>
<span class="p">[</span><span class="nx">应用代码</span><span class="p">]</span> <span class="o">&lt;--</span> <span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">---</span> <span class="p">[</span><span class="nx">Entity</span><span class="p">]</span> <span class="o">&lt;--</span> <span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">---</span> <span class="p">[</span><span class="nx">数据库</span><span class="p">]</span>
</pre></div>
</div>
<p>使用此类型转换时，Entity 将在属性中具有正确类型的 PHP 值。这种行为与之前的行为完全不同。不要期望属性中持有来自数据库的原始数据。</p>
</div>
<section id="id12">
<h3><a class="toc-backref" href="#id64" role="doc-backlink">定义数据类型</a><a class="headerlink" href="#id12" title="此标题的永久链接"></a></h3>
<p><code class="docutils literal notranslate"><span class="pre">$casts</span></code> 属性设置其定义。此选项应为一个数组，其中键是字段的名称，值是数据类型：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">namespace</span> <span class="nx">App\Models</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">CodeIgniter\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">UserModel</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="k">protected</span> <span class="nv">$casts</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;id&#39;</span>        <span class="o">=&gt;</span> <span class="s1">&#39;int&#39;</span><span class="p">,</span>
        <span class="s1">&#39;birthdate&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;?datetime&#39;</span><span class="p">,</span>
        <span class="s1">&#39;hobbies&#39;</span>   <span class="o">=&gt;</span> <span class="s1">&#39;json-array&#39;</span><span class="p">,</span>
        <span class="s1">&#39;active&#39;</span>    <span class="o">=&gt;</span> <span class="s1">&#39;int-bool&#39;</span><span class="p">,</span>
    <span class="p">];</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="id13">
<h3><a class="toc-backref" href="#id65" role="doc-backlink">数据类型</a><a class="headerlink" href="#id13" title="此标题的永久链接"></a></h3>
<p>默认提供以下类型。在类型前添加问号以标记字段为可为空，例如，<code class="docutils literal notranslate"><span class="pre">?int</span></code>，<code class="docutils literal notranslate"><span class="pre">?datetime</span></code>。</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>类型</p></th>
<th class="head"><p>PHP 类型</p></th>
<th class="head"><p>数据库字段类型</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">int</span></code></p></td>
<td><p>int</p></td>
<td><p>int 类型</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">float</span></code></p></td>
<td><p>float</p></td>
<td><p>float（数值）类型</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">bool</span></code></p></td>
<td><p>bool</p></td>
<td><p>bool/int/string 类型</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">int-bool</span></code></p></td>
<td><p>bool</p></td>
<td><p>int 类型（1 或 0）</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">array</span></code></p></td>
<td><p>array</p></td>
<td><p>string 类型（序列化）</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">csv</span></code></p></td>
<td><p>array</p></td>
<td><p>string 类型（CSV）</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">json</span></code></p></td>
<td><p>stdClass</p></td>
<td><p>json/string 类型</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">json-array</span></code></p></td>
<td><p>array</p></td>
<td><p>json/string 类型</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">datetime</span></code></p></td>
<td><p>Time</p></td>
<td><p>datetime 类型</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">timestamp</span></code></p></td>
<td><p>Time</p></td>
<td><p>int 类型（UNIX 时间戳）</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">uri</span></code></p></td>
<td><p>URI</p></td>
<td><p>string 类型</p></td>
</tr>
</tbody>
</table>
<section id="csv">
<h4><a class="toc-backref" href="#id66" role="doc-backlink">csv</a><a class="headerlink" href="#csv" title="此标题的永久链接"></a></h4>
<p>将类型转换为 <code class="docutils literal notranslate"><span class="pre">csv</span></code> 使用 PHP 的内部 <code class="docutils literal notranslate"><span class="pre">implode()</span></code> 和 <code class="docutils literal notranslate"><span class="pre">explode()</span></code> 函数，并假设所有值都是字符串安全且不含逗号。对于更复杂的数据类型转换，尝试使用 <code class="docutils literal notranslate"><span class="pre">array</span></code> 或 <code class="docutils literal notranslate"><span class="pre">json</span></code>。</p>
</section>
<section id="datetime">
<h4><a class="toc-backref" href="#id67" role="doc-backlink">datetime</a><a class="headerlink" href="#datetime" title="此标题的永久链接"></a></h4>
<p>你可以传递类似 <code class="docutils literal notranslate"><span class="pre">datetime[ms]</span></code> 的参数表示带有毫秒的日期/时间，或 <code class="docutils literal notranslate"><span class="pre">datetime[us]</span></code> 表示带有微秒的日期/时间。</p>
<p>日期时间格式在 <strong>app/Config/Database.php</strong> 文件中的 <a class="reference internal" href="../database/configuration.html#database-config-explanation-of-values"><span class="std std-ref">数据库配置</span></a> 的 <code class="docutils literal notranslate"><span class="pre">dateFormat</span></code> 数组中设置。</p>
</section>
</section>
<section id="id14">
<h3><a class="toc-backref" href="#id68" role="doc-backlink">自定义类型转换</a><a class="headerlink" href="#id14" title="此标题的永久链接"></a></h3>
<p>你可以定义自己的转换类型。</p>
<section id="id15">
<h4><a class="toc-backref" href="#id69" role="doc-backlink">创建自定义处理程序</a><a class="headerlink" href="#id15" title="此标题的永久链接"></a></h4>
<p>首先，你需要为你的类型创建一个处理程序类。假设该类位于 <strong>app/Models/Cast</strong> 目录中：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">namespace</span> <span class="nx">App\Models\Cast</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">CodeIgniter\DataCaster\Cast\BaseCast</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">InvalidArgumentException</span><span class="p">;</span>

<span class="c1">// The class must inherit the CodeIgniter\DataCaster\Cast\BaseCast class</span>
<span class="k">class</span> <span class="nc">CastBase64</span> <span class="k">extends</span> <span class="nx">BaseCast</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">get</span><span class="p">(</span>
        <span class="nx">mixed</span> <span class="nv">$value</span><span class="p">,</span>
        <span class="k">array</span> <span class="nv">$params</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="o">?</span><span class="nx">object</span> <span class="nv">$helper</span> <span class="o">=</span> <span class="k">null</span>
    <span class="p">)</span><span class="o">:</span> <span class="nx">string</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nb">is_string</span><span class="p">(</span><span class="nv">$value</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">self</span><span class="o">::</span><span class="na">invalidTypeValueError</span><span class="p">(</span><span class="nv">$value</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nv">$decoded</span> <span class="o">=</span> <span class="nb">base64_decode</span><span class="p">(</span><span class="nv">$value</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nv">$decoded</span> <span class="o">===</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">InvalidArgumentException</span><span class="p">(</span><span class="s1">&#39;Cannot decode: &#39;</span> <span class="o">.</span> <span class="nv">$value</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nv">$decoded</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">set</span><span class="p">(</span>
        <span class="nx">mixed</span> <span class="nv">$value</span><span class="p">,</span>
        <span class="k">array</span> <span class="nv">$params</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="o">?</span><span class="nx">object</span> <span class="nv">$helper</span> <span class="o">=</span> <span class="k">null</span>
    <span class="p">)</span><span class="o">:</span> <span class="nx">string</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nb">is_string</span><span class="p">(</span><span class="nv">$value</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">self</span><span class="o">::</span><span class="na">invalidTypeValueError</span><span class="p">(</span><span class="nv">$value</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nb">base64_encode</span><span class="p">(</span><span class="nv">$value</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>如果你不需要在获取或设置值时更改值，那么只需不实现相应的方法：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">namespace</span> <span class="nx">App\Models\Cast</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">CodeIgniter\DataCaster\Cast\BaseCast</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">InvalidArgumentException</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">CastBase64</span> <span class="k">extends</span> <span class="nx">BaseCast</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">get</span><span class="p">(</span>
        <span class="nx">mixed</span> <span class="nv">$value</span><span class="p">,</span>
        <span class="k">array</span> <span class="nv">$params</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="o">?</span><span class="nx">object</span> <span class="nv">$helper</span> <span class="o">=</span> <span class="k">null</span>
    <span class="p">)</span><span class="o">:</span> <span class="nx">string</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nb">is_string</span><span class="p">(</span><span class="nv">$value</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">self</span><span class="o">::</span><span class="na">invalidTypeValueError</span><span class="p">(</span><span class="nv">$value</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nv">$decoded</span> <span class="o">=</span> <span class="nb">base64_decode</span><span class="p">(</span><span class="nv">$value</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nv">$decoded</span> <span class="o">===</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">InvalidArgumentException</span><span class="p">(</span><span class="s1">&#39;Cannot decode: &#39;</span> <span class="o">.</span> <span class="nv">$value</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nv">$decoded</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="id16">
<h4><a class="toc-backref" href="#id70" role="doc-backlink">注册自定义处理程序</a><a class="headerlink" href="#id16" title="此标题的永久链接"></a></h4>
<p>现在你需要注册它：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">namespace</span> <span class="nx">App\Models</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">App\Models\Cast\CastBase64</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">CodeIgniter\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">MyModel</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="c1">// ...</span>

    <span class="c1">// Specify the type for the field</span>
    <span class="k">protected</span> <span class="k">array</span> <span class="nv">$casts</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;column1&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;base64&#39;</span><span class="p">,</span>
    <span class="p">];</span>

    <span class="c1">// Bind the type to the handler</span>
    <span class="k">protected</span> <span class="k">array</span> <span class="nv">$castHandlers</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;base64&#39;</span> <span class="o">=&gt;</span> <span class="nx">CastBase64</span><span class="o">::</span><span class="na">class</span><span class="p">,</span>
    <span class="p">];</span>

    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="id17">
<h4><a class="toc-backref" href="#id71" role="doc-backlink">参数</a><a class="headerlink" href="#id17" title="此标题的永久链接"></a></h4>
<p>在某些情况下，一种类型是不够的。在这种情况下，你可以使用附加参数。附加参数在方括号中指示，并用逗号列出，例如 <code class="docutils literal notranslate"><span class="pre">type[param1,</span> <span class="pre">param2]</span></code>。</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">namespace</span> <span class="nx">App\Models</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">App\Models\Cast\SomeHandler</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">CodeIgniter\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">MyModel</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="c1">// ...</span>

    <span class="c1">// Define a type with parameters</span>
    <span class="k">protected</span> <span class="k">array</span> <span class="nv">$casts</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;column1&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;class[App\SomeClass, param2, param3]&#39;</span><span class="p">,</span>
    <span class="p">];</span>

    <span class="c1">// Bind the type to the handler</span>
    <span class="k">protected</span> <span class="k">array</span> <span class="nv">$castHandlers</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;class&#39;</span> <span class="o">=&gt;</span> <span class="nx">SomeHandler</span><span class="o">::</span><span class="na">class</span><span class="p">,</span>
    <span class="p">];</span>

    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">namespace</span> <span class="nx">App\Models\Cast</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">CodeIgniter\DataCaster\Cast\BaseCast</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">SomeHandler</span> <span class="k">extends</span> <span class="nx">BaseCast</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">get</span><span class="p">(</span>
        <span class="nx">mixed</span> <span class="nv">$value</span><span class="p">,</span>
        <span class="k">array</span> <span class="nv">$params</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="o">?</span><span class="nx">object</span> <span class="nv">$helper</span> <span class="o">=</span> <span class="k">null</span>
    <span class="p">)</span><span class="o">:</span> <span class="nx">mixed</span> <span class="p">{</span>
        <span class="nb">var_dump</span><span class="p">(</span><span class="nv">$params</span><span class="p">);</span>
        <span class="cm">/*</span>
<span class="cm">         * Output:</span>
<span class="cm">         * array(3) {</span>
<span class="cm">         *   [0]=&gt;</span>
<span class="cm">         *   string(13) &quot;App\SomeClass&quot;</span>
<span class="cm">         *   [1]=&gt;</span>
<span class="cm">         *   string(6) &quot;param2&quot;</span>
<span class="cm">         *   [2]=&gt;</span>
<span class="cm">         *   string(6) &quot;param3&quot;</span>
<span class="cm">         * }</span>
<span class="cm">         */</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>如果类型转换类型标记为 nullable，例如 <code class="docutils literal notranslate"><span class="pre">?bool</span></code>，并且传递的值不为空，那么值为 <code class="docutils literal notranslate"><span class="pre">nullable</span></code> 的参数将传递给类型转换处理程序。如果类型转换具有预定义参数，则 <code class="docutils literal notranslate"><span class="pre">nullable</span></code> 将添加到列表的末尾。</p>
</div>
</section>
</section>
</section>
<section id="id18">
<h2><a class="toc-backref" href="#id72" role="doc-backlink">使用数据</a><a class="headerlink" href="#id18" title="此标题的永久链接"></a></h2>
<section id="id19">
<h3><a class="toc-backref" href="#id73" role="doc-backlink">查找数据</a><a class="headerlink" href="#id19" title="此标题的永久链接"></a></h3>
<p>提供了几个函数来对表执行基本的 CRUD 工作,包括 <code class="docutils literal notranslate"><span class="pre">find()</span></code>、<code class="docutils literal notranslate"><span class="pre">insert()</span></code>、<code class="docutils literal notranslate"><span class="pre">update()</span></code>、<code class="docutils literal notranslate"><span class="pre">delete()</span></code> 等等。</p>
<section id="find">
<h4><a class="toc-backref" href="#id74" role="doc-backlink">find()</a><a class="headerlink" href="#find" title="此标题的永久链接"></a></h4>
<p>在主键与作为第一参数传递的值匹配的情况下,返回单行。</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="nv">$user</span> <span class="o">=</span> <span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="nv">$user_id</span><span class="p">);</span>
</pre></div>
</div>
<p>该值以 <a class="reference internal" href="#returntype">$returnType</a> 中指定的格式返回。</p>
<p>你可以通过传递主键值数组而不是一个来指定要返回多行。</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="nv">$users</span> <span class="o">=</span> <span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]);</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>如果没有传递参数, <code class="docutils literal notranslate"><span class="pre">find()</span></code> 将返回该模型的表中的所有行,
效果与 <code class="docutils literal notranslate"><span class="pre">findAll()</span></code> 相同,尽管不太明确。</p>
</div>
</section>
<section id="findcolumn">
<h4><a class="toc-backref" href="#id75" role="doc-backlink">findColumn()</a><a class="headerlink" href="#findcolumn" title="此标题的永久链接"></a></h4>
<p>返回 null 或索引数组的列值:</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="nv">$user</span> <span class="o">=</span> <span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">findColumn</span><span class="p">(</span><span class="nv">$column_name</span><span class="p">);</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">$column_name</span></code> 应该是单个列的名称,否则你会获得 <code class="docutils literal notranslate"><span class="pre">DataException</span></code>。</p>
</section>
<section id="findall">
<h4><a class="toc-backref" href="#id76" role="doc-backlink">findAll()</a><a class="headerlink" href="#findall" title="此标题的永久链接"></a></h4>
<p>返回所有结果:</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="nv">$users</span> <span class="o">=</span> <span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">findAll</span><span class="p">();</span>
</pre></div>
</div>
<p>可以在调用此方法之前根据需要插入查询构建器命令来修改此查询:</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="nv">$users</span> <span class="o">=</span> <span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;active&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">findAll</span><span class="p">();</span>
</pre></div>
</div>
<p>你可以分别作为第一个和第二个参数传递限制和偏移值:</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="nv">$users</span> <span class="o">=</span> <span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">findAll</span><span class="p">(</span><span class="nv">$limit</span><span class="p">,</span> <span class="nv">$offset</span><span class="p">);</span>
</pre></div>
</div>
</section>
<section id="first">
<h4><a class="toc-backref" href="#id77" role="doc-backlink">first()</a><a class="headerlink" href="#first" title="此标题的永久链接"></a></h4>
<p>返回结果集中的第一行。这与查询构建器一起使用时最好。</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="nv">$user</span> <span class="o">=</span> <span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;deleted&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">first</span><span class="p">();</span>
</pre></div>
</div>
</section>
<section id="withdeleted">
<h4><a class="toc-backref" href="#id78" role="doc-backlink">withDeleted()</a><a class="headerlink" href="#withdeleted" title="此标题的永久链接"></a></h4>
<p>如果 <a class="reference internal" href="#usesoftdeletes">$useSoftDeletes</a> 为 true,则 <strong>find*()</strong> 方法不会返回任何 <code class="docutils literal notranslate"><span class="pre">deleted_at</span> <span class="pre">IS</span> <span class="pre">NOT</span> <span class="pre">NULL</span></code> 的行。
要暂时覆盖此设置,可以在调用 <strong>find*()</strong> 方法之前使用 <code class="docutils literal notranslate"><span class="pre">withDeleted()</span></code> 方法。</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="c1">// Only gets non-deleted rows (deleted = 0)</span>
<span class="nv">$activeUsers</span> <span class="o">=</span> <span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">findAll</span><span class="p">();</span>

<span class="c1">// Gets all rows</span>
<span class="nv">$allUsers</span> <span class="o">=</span> <span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">withDeleted</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">findAll</span><span class="p">();</span>
</pre></div>
</div>
</section>
<section id="onlydeleted">
<h4><a class="toc-backref" href="#id79" role="doc-backlink">onlyDeleted()</a><a class="headerlink" href="#onlydeleted" title="此标题的永久链接"></a></h4>
<p>而 <code class="docutils literal notranslate"><span class="pre">withDeleted()</span></code> 将返回已删除和未删除的行,此方法会修改下一个 <strong>find*()</strong> 方法仅返回软删除的行:</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="nv">$deletedUsers</span> <span class="o">=</span> <span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">onlyDeleted</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">findAll</span><span class="p">();</span>
</pre></div>
</div>
</section>
</section>
<section id="id20">
<h3><a class="toc-backref" href="#id80" role="doc-backlink">保存数据</a><a class="headerlink" href="#id20" title="此标题的永久链接"></a></h3>
<section id="insert">
<h4><a class="toc-backref" href="#id81" role="doc-backlink">insert()</a><a class="headerlink" href="#insert" title="此标题的永久链接"></a></h4>
<p>第一个参数是一个关联数组,用于在数据库中创建新行数据。
如果传递对象而不是数组,它将尝试将其转换为数组。</p>
<p>数组的键必须与 <a class="reference internal" href="#table">$table</a> 中的列名匹配,而数组的值是要为该键保存的值。</p>
<p>可选的第二个参数为布尔类型,如果设置为 false,该方法将返回一个布尔值,表示查询的成功或失败。</p>
<p>你可以使用 <code class="docutils literal notranslate"><span class="pre">getInsertID()</span></code> 方法检索最后插入的行的主键。</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="nv">$data</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;username&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;darth&#39;</span><span class="p">,</span>
    <span class="s1">&#39;email&#39;</span>    <span class="o">=&gt;</span> <span class="s1">&#39;d.vader@theempire.com&#39;</span><span class="p">,</span>
<span class="p">];</span>

<span class="c1">// Inserts data and returns inserted row&#39;s primary key</span>
<span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">insert</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>

<span class="c1">// Inserts data and returns true on success and false on failure</span>
<span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">insert</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span>

<span class="c1">// Returns inserted row&#39;s primary key</span>
<span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">getInsertID</span><span class="p">();</span>
</pre></div>
</div>
</section>
<section id="model-allow-empty-inserts">
<span id="id21"></span><h4><a class="toc-backref" href="#id82" role="doc-backlink">allowEmptyInserts()</a><a class="headerlink" href="#model-allow-empty-inserts" title="此标题的永久链接"></a></h4>
<div class="versionadded">
<p><span class="versionmodified added">在 4.3.0 版本加入.</span></p>
</div>
<p>你可以使用 <code class="docutils literal notranslate"><span class="pre">allowEmptyInserts()</span></code> 方法插入空数据。默认情况下,模型在你尝试插入空数据时会抛出异常。但是如果调用此方法,将不再执行检查。</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">allowEmptyInserts</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">insert</span><span class="p">([]);</span>
</pre></div>
</div>
<p>你也可以通过 <a class="reference internal" href="#allowemptyinserts">$allowEmptyInserts</a> 属性来改变这个设置。</p>
<p>你可以通过调用 <code class="docutils literal notranslate"><span class="pre">allowEmptyInserts(false)</span></code> 再次启用检查。</p>
</section>
<section id="update">
<h4><a class="toc-backref" href="#id83" role="doc-backlink">update()</a><a class="headerlink" href="#update" title="此标题的永久链接"></a></h4>
<p>更新数据库中的现有记录。第一个参数是要更新的记录的 <a class="reference internal" href="#primarykey">$primaryKey</a>。关联数组作为第二个参数传递给此方法。数组的键必须与 <a class="reference internal" href="#table">$table</a> 中的列名匹配,而数组的值是要为该键保存的值:</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="nv">$data</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;username&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;darth&#39;</span><span class="p">,</span>
    <span class="s1">&#39;email&#39;</span>    <span class="o">=&gt;</span> <span class="s1">&#39;d.vader@theempire.com&#39;</span><span class="p">,</span>
<span class="p">];</span>

<span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">update</span><span class="p">(</span><span class="nv">$id</span><span class="p">,</span> <span class="nv">$data</span><span class="p">);</span>
</pre></div>
</div>
<div class="admonition important">
<p class="admonition-title">重要</p>
<p>从 v4.3.0 开始,如果它生成没有 WHERE 子句的 SQL 语句,此方法会抛出 <code class="docutils literal notranslate"><span class="pre">DatabaseException</span></code>。
在以前的版本中,如果在没有指定 <a class="reference internal" href="#primarykey">$primaryKey</a> 的情况下调用它并生成没有 WHERE 子句的 SQL 语句,查询仍会执行,表中的所有记录都会被更新。</p>
</div>
<p>可以通过作为第一个参数传递主键数组来一次更新多条记录:</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="nv">$data</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;active&#39;</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">];</span>

<span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">update</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="nv">$data</span><span class="p">);</span>
</pre></div>
</div>
<p>当你需要更灵活的解决方案时,可以留空参数,它的作用类似于查询构建器的 update 命令,具有验证、事件等的额外优势:</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="nv">$userModel</span>
    <span class="o">-&gt;</span><span class="na">whereIn</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
    <span class="o">-&gt;</span><span class="na">set</span><span class="p">([</span><span class="s1">&#39;active&#39;</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">])</span>
    <span class="o">-&gt;</span><span class="na">update</span><span class="p">();</span>
</pre></div>
</div>
</section>
<section id="save">
<span id="model-save"></span><h4><a class="toc-backref" href="#id84" role="doc-backlink">save()</a><a class="headerlink" href="#save" title="此标题的永久链接"></a></h4>
<p>这是 <code class="docutils literal notranslate"><span class="pre">insert()</span></code> 和 <code class="docutils literal notranslate"><span class="pre">update()</span></code> 方法的包装器,可以根据是否找到与 <strong>主键</strong> 值匹配的数组键来自动处理插入或更新记录。</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="c1">// Defined as a model property</span>
<span class="nv">$primaryKey</span> <span class="o">=</span> <span class="s1">&#39;id&#39;</span><span class="p">;</span>

<span class="c1">// Does an insert()</span>
<span class="nv">$data</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;username&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;darth&#39;</span><span class="p">,</span>
    <span class="s1">&#39;email&#39;</span>    <span class="o">=&gt;</span> <span class="s1">&#39;d.vader@theempire.com&#39;</span><span class="p">,</span>
<span class="p">];</span>

<span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>

<span class="c1">// Performs an update, since the primary key, &#39;id&#39;, is found.</span>
<span class="nv">$data</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;id&#39;</span>       <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span>
    <span class="s1">&#39;username&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;darth&#39;</span><span class="p">,</span>
    <span class="s1">&#39;email&#39;</span>    <span class="o">=&gt;</span> <span class="s1">&#39;d.vader@theempire.com&#39;</span><span class="p">,</span>
<span class="p">];</span>
<span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>
</pre></div>
</div>
<p>save 方法还可以通过识别非简单对象并将其公共和受保护的值抓取到一个数组中，然后将该数组传递给适当的 insert 或 update 方法，从而使处理自定义类结果对象变得更加简单。这使你可以非常简洁地使用 Entity 类。Entity 类是表示某种对象类型的单个实例的简单类，比如用户、博客文章、工作等。这个类负责维护围绕对象本身的业务逻辑，比如以某种方式格式化元素等。它们不应该知道如何将自己保存到数据库中。最简单的情况下，它们可能看起来像这样：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">namespace</span> <span class="nx">App\Entities</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Job</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="nv">$id</span><span class="p">;</span>
    <span class="k">protected</span> <span class="nv">$name</span><span class="p">;</span>
    <span class="k">protected</span> <span class="nv">$description</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__get</span><span class="p">(</span><span class="nv">$key</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">property_exists</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="nv">$key</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$key</span><span class="p">};</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__set</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="nv">$value</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">property_exists</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="nv">$key</span><span class="p">))</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$key</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$value</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>与此配合使用的一个非常简单的模型可能如下所示:</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">namespace</span> <span class="nx">App\Models</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">CodeIgniter\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">JobModel</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="nv">$table</span>         <span class="o">=</span> <span class="s1">&#39;jobs&#39;</span><span class="p">;</span>
    <span class="k">protected</span> <span class="nv">$returnType</span>    <span class="o">=</span> <span class="nx">\App\Entities\Job</span><span class="o">::</span><span class="na">class</span><span class="p">;</span>
    <span class="k">protected</span> <span class="nv">$allowedFields</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">,</span>
    <span class="p">];</span>
<span class="p">}</span>
</pre></div>
</div>
<p>该模型使用来自 <code class="docutils literal notranslate"><span class="pre">jobs</span></code> 表的数据,并将所有结果返回为 <code class="docutils literal notranslate"><span class="pre">App\Entities\Job</span></code> 的实例。
当你需要将该记录持久化到数据库时,你需要编写自定义方法,或者使用模型的 <code class="docutils literal notranslate"><span class="pre">save()</span></code> 方法检查类、获取任何公共和私有属性,并将它们保存到数据库:</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="c1">// Retrieve a Job instance</span>
<span class="nv">$job</span> <span class="o">=</span> <span class="nv">$model</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="mi">15</span><span class="p">);</span>

<span class="c1">// Make some changes</span>
<span class="nv">$job</span><span class="o">-&gt;</span><span class="na">name</span> <span class="o">=</span> <span class="s1">&#39;Foobar&#39;</span><span class="p">;</span>

<span class="c1">// Save the changes</span>
<span class="nv">$model</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">(</span><span class="nv">$job</span><span class="p">);</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>如果你发现自己频繁使用实体,CodeIgniter 提供了一个内置的 <a class="reference internal" href="entities.html"><span class="doc">实体类</span></a>,
它提供了使开发实体更简单的几个方便的功能。</p>
</div>
</section>
<section id="model-saving-dates">
<span id="id22"></span><h4><a class="toc-backref" href="#id85" role="doc-backlink">保存日期</a><a class="headerlink" href="#model-saving-dates" title="此标题的永久链接"></a></h4>
<div class="versionadded">
<p><span class="versionmodified added">在 4.5.0 版本加入.</span></p>
</div>
<p>在保存数据时，如果你传递 <a class="reference internal" href="../libraries/time.html"><span class="doc">Time</span></a> 实例，它们会根据
<a class="reference internal" href="../database/configuration.html#database-config-explanation-of-values"><span class="std std-ref">数据库配置</span></a> 中 <code class="docutils literal notranslate"><span class="pre">dateFormat['datetime']</span></code> 和 <code class="docutils literal notranslate"><span class="pre">dateFormat['date']</span></code> 定义的格式转换为字符串。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>在 v4.5.0 之前，日期/时间格式在 Model 类中是硬编码为 <code class="docutils literal notranslate"><span class="pre">Y-m-d</span> <span class="pre">H:i:s</span></code> 和 <code class="docutils literal notranslate"><span class="pre">Y-m-d</span></code>。</p>
</div>
</section>
</section>
<section id="id23">
<h3><a class="toc-backref" href="#id86" role="doc-backlink">删除数据</a><a class="headerlink" href="#id23" title="此标题的永久链接"></a></h3>
<section id="delete">
<h4><a class="toc-backref" href="#id87" role="doc-backlink">delete()</a><a class="headerlink" href="#delete" title="此标题的永久链接"></a></h4>
<p>以主键值作为第一个参数,从模型的表中删除匹配的记录:</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">delete</span><span class="p">(</span><span class="mi">12</span><span class="p">);</span>
</pre></div>
</div>
<p>如果模型的 <a class="reference internal" href="#usesoftdeletes">$useSoftDeletes</a> 值为 true,这将更新行以将 <code class="docutils literal notranslate"><span class="pre">deleted_at</span></code> 设置为当前日期和时间。你可以通过将第二个参数设置为 true 来强制永久删除。</p>
<p>可以作为第一个参数传递主键数组,以一次删除多条记录:</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">delete</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]);</span>
</pre></div>
</div>
<p>如果没有传递参数,将像查询构建器的 delete 方法一样操作,需要事先进行 where 调用:</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">delete</span><span class="p">();</span>
</pre></div>
</div>
</section>
<section id="purgedeleted">
<h4><a class="toc-backref" href="#id88" role="doc-backlink">purgeDeleted()</a><a class="headerlink" href="#purgedeleted" title="此标题的永久链接"></a></h4>
<p>通过永久删除所有 ‘deleted_at IS NOT NULL’ 的行来清理数据库表。</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">purgeDeleted</span><span class="p">();</span>
</pre></div>
</div>
</section>
</section>
<section id="in-model-validation">
<span id="id24"></span><h3><a class="toc-backref" href="#id89" role="doc-backlink">模型内验证</a><a class="headerlink" href="#in-model-validation" title="此标题的永久链接"></a></h3>
<section id="id25">
<h4><a class="toc-backref" href="#id90" role="doc-backlink">验证数据</a><a class="headerlink" href="#id25" title="此标题的永久链接"></a></h4>
<p>对于许多人来说，在模型中验证数据是确保数据保持单一标准而不重复代码的首选方式。Model 类提供了一种方法，可以在使用 <code class="docutils literal notranslate"><span class="pre">insert()</span></code>、<code class="docutils literal notranslate"><span class="pre">update()</span></code> 或 <code class="docutils literal notranslate"><span class="pre">save()</span></code> 方法保存到数据库之前自动验证所有数据。</p>
<div class="admonition important">
<p class="admonition-title">重要</p>
<p>当你更新数据时，默认情况下，模型类中的验证只会验证提供的字段。这是为了避免在仅更新某些字段时出现验证错误。</p>
<p>然而，这意味着在更新期间并不会检查你设置的所有验证规则。因此，不完整的数据可能会通过验证。</p>
<p>例如，<code class="docutils literal notranslate"><span class="pre">required*</span></code> 规则或需要其他字段值的 <code class="docutils literal notranslate"><span class="pre">is_unique</span></code> 规则可能不会按预期工作。</p>
<p>为了避免这种问题，可以通过配置更改此行为。详情请参见 <a class="reference internal" href="#clean-validation-rules"><span class="std std-ref">$cleanValidationRules</span></a>。</p>
</div>
</section>
<section id="id26">
<h4><a class="toc-backref" href="#id91" role="doc-backlink">设置验证规则</a><a class="headerlink" href="#id26" title="此标题的永久链接"></a></h4>
<p>第一步是用将应用的字段和规则填充 <a class="reference internal" href="#validationrules">$validationRules</a> 类属性。如果你有要使用的自定义错误消息,请将其放入 <a class="reference internal" href="#validationmessages">$validationMessages</a> 数组中:</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">namespace</span> <span class="nx">App\Models</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">CodeIgniter\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">UserModel</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="c1">// ...</span>

    <span class="k">protected</span> <span class="nv">$validationRules</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;username&#39;</span>     <span class="o">=&gt;</span> <span class="s1">&#39;required|max_length[30]|alpha_numeric_space|min_length[3]&#39;</span><span class="p">,</span>
        <span class="s1">&#39;email&#39;</span>        <span class="o">=&gt;</span> <span class="s1">&#39;required|max_length[254]|valid_email|is_unique[users.email]&#39;</span><span class="p">,</span>
        <span class="s1">&#39;password&#39;</span>     <span class="o">=&gt;</span> <span class="s1">&#39;required|max_length[255]|min_length[8]&#39;</span><span class="p">,</span>
        <span class="s1">&#39;pass_confirm&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;required_with[password]|max_length[255]|matches[password]&#39;</span><span class="p">,</span>
    <span class="p">];</span>
    <span class="k">protected</span> <span class="nv">$validationMessages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;email&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s1">&#39;is_unique&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Sorry. That email has already been taken. Please choose another.&#39;</span><span class="p">,</span>
        <span class="p">],</span>
    <span class="p">];</span>
<span class="p">}</span>
</pre></div>
</div>
<p>如果你更喜欢在验证配置文件中组织你的规则和错误消息，你可以这样做，并将 <a class="reference internal" href="#validationrules">$validationRules</a> 设置为你创建的验证规则组的名称：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">namespace</span> <span class="nx">App\Models</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">CodeIgniter\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">UserModel</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="c1">// ...</span>

    <span class="k">protected</span> <span class="nv">$validationRules</span> <span class="o">=</span> <span class="s1">&#39;users&#39;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>向字段设置验证规则的另一种方法是使用函数:</p>
<span class="target" id="namespace-CodeIgniter"></span><dl class="php class">
<dt class="sig sig-object php" id="CodeIgniter\Model">
<em class="property"><span class="pre">class</span> </em><span class="sig-prename descclassname"><span class="pre">CodeIgniter\</span></span><span class="sig-name descname"><span class="pre">Model</span></span><a class="headerlink" href="#CodeIgniter\Model" title="永久链接至目标"></a></dt>
<dd></dd></dl>

<dl class="php method">
<dt class="sig sig-object php" id="CodeIgniter\Model::setValidationRule">
<span class="sig-prename descclassname"><span class="pre">CodeIgniter\Model::</span></span><span class="sig-name descname"><span class="pre">setValidationRule</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="pre">$field</span></em>, <em class="sig-param"><span class="pre">$fieldRules</span></em><span class="sig-paren">)</span><a class="headerlink" href="#CodeIgniter\Model::setValidationRule" title="永久链接至目标"></a></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">参数<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>$field</strong> (<span><code class="xref php php-obj docutils literal notranslate"><span class="pre">string</span></code></span>) – </p></li>
<li><p><strong>$fieldRules</strong> (<span><code class="xref php php-obj docutils literal notranslate"><span class="pre">array</span></code></span>) – </p></li>
</ul>
</dd>
</dl>
<p>此函数将设置字段验证规则。</p>
<p>使用示例:</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="nv">$fieldName</span>  <span class="o">=</span> <span class="s1">&#39;username&#39;</span><span class="p">;</span>
<span class="nv">$fieldRules</span> <span class="o">=</span> <span class="s1">&#39;required|max_length[30]|alpha_numeric_space|min_length[3]&#39;</span><span class="p">;</span>

<span class="nv">$model</span><span class="o">-&gt;</span><span class="na">setValidationRule</span><span class="p">(</span><span class="nv">$fieldName</span><span class="p">,</span> <span class="nv">$fieldRules</span><span class="p">);</span>
</pre></div>
</div>
</dd></dl>

<dl class="php method">
<dt class="sig sig-object php" id="CodeIgniter\Model::setValidationRules">
<span class="sig-prename descclassname"><span class="pre">CodeIgniter\Model::</span></span><span class="sig-name descname"><span class="pre">setValidationRules</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="pre">$validationRules</span></em><span class="sig-paren">)</span><a class="headerlink" href="#CodeIgniter\Model::setValidationRules" title="永久链接至目标"></a></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">参数<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>$validationRules</strong> (<span><code class="xref php php-obj docutils literal notranslate"><span class="pre">array</span></code></span>) – </p></li>
</ul>
</dd>
</dl>
<p>此函数将设置验证规则。</p>
<p>使用示例:</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="nv">$validationRules</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;username&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;required|max_length[30]|alpha_numeric_space|min_length[3]&#39;</span><span class="p">,</span>
    <span class="s1">&#39;email&#39;</span>    <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="s1">&#39;rules&#39;</span>  <span class="o">=&gt;</span> <span class="s1">&#39;required|max_length[254]|valid_email|is_unique[users.email]&#39;</span><span class="p">,</span>
        <span class="s1">&#39;errors&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s1">&#39;required&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;We really need your email.&#39;</span><span class="p">,</span>
        <span class="p">],</span>
    <span class="p">],</span>
<span class="p">];</span>
<span class="nv">$model</span><span class="o">-&gt;</span><span class="na">setValidationRules</span><span class="p">(</span><span class="nv">$validationRules</span><span class="p">);</span>
</pre></div>
</div>
</dd></dl>

<p>向字段设置验证消息的另一种方法是使用函数:</p>
<dl class="php method">
<dt class="sig sig-object php" id="CodeIgniter\Model::setValidationMessage">
<span class="sig-prename descclassname"><span class="pre">CodeIgniter\Model::</span></span><span class="sig-name descname"><span class="pre">setValidationMessage</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="pre">$field</span></em>, <em class="sig-param"><span class="pre">$fieldMessages</span></em><span class="sig-paren">)</span><a class="headerlink" href="#CodeIgniter\Model::setValidationMessage" title="永久链接至目标"></a></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">参数<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>$field</strong> (<span><code class="xref php php-obj docutils literal notranslate"><span class="pre">string</span></code></span>) – </p></li>
<li><p><strong>$fieldMessages</strong> (<span><code class="xref php php-obj docutils literal notranslate"><span class="pre">array</span></code></span>) – </p></li>
</ul>
</dd>
</dl>
<p>此函数将设置字段的错误消息。</p>
<p>使用示例:</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="nv">$fieldName</span>              <span class="o">=</span> <span class="s1">&#39;name&#39;</span><span class="p">;</span>
<span class="nv">$fieldValidationMessage</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;required&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Your name is required here&#39;</span><span class="p">,</span>
<span class="p">];</span>
<span class="nv">$model</span><span class="o">-&gt;</span><span class="na">setValidationMessage</span><span class="p">(</span><span class="nv">$fieldName</span><span class="p">,</span> <span class="nv">$fieldValidationMessage</span><span class="p">);</span>
</pre></div>
</div>
</dd></dl>

<dl class="php method">
<dt class="sig sig-object php" id="CodeIgniter\Model::setValidationMessages">
<span class="sig-prename descclassname"><span class="pre">CodeIgniter\Model::</span></span><span class="sig-name descname"><span class="pre">setValidationMessages</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="pre">$validationMessages</span></em><span class="sig-paren">)</span><a class="headerlink" href="#CodeIgniter\Model::setValidationMessages" title="永久链接至目标"></a></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">参数<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>$validationMessages</strong> (<span><code class="xref php php-obj docutils literal notranslate"><span class="pre">array</span></code></span>) – </p></li>
</ul>
</dd>
</dl>
<p>此函数将设置字段的错误消息。</p>
<p>使用示例:</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="nv">$fieldValidationMessage</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="s1">&#39;required&#39;</span>   <span class="o">=&gt;</span> <span class="s1">&#39;Your baby name is missing.&#39;</span><span class="p">,</span>
        <span class="s1">&#39;min_length&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Too short, man!&#39;</span><span class="p">,</span>
    <span class="p">],</span>
<span class="p">];</span>
<span class="nv">$model</span><span class="o">-&gt;</span><span class="na">setValidationMessages</span><span class="p">(</span><span class="nv">$fieldValidationMessage</span><span class="p">);</span>
</pre></div>
</div>
</dd></dl>

</section>
<section id="id27">
<h4><a class="toc-backref" href="#id92" role="doc-backlink">获取验证结果</a><a class="headerlink" href="#id27" title="此标题的永久链接"></a></h4>
<p>现在，每当你调用 <code class="docutils literal notranslate"><span class="pre">insert()</span></code>、<code class="docutils literal notranslate"><span class="pre">update()</span></code> 或 <code class="docutils literal notranslate"><span class="pre">save()</span></code> 方法时，数据将被验证。如果验证失败，模型将返回布尔值 <strong>false</strong>。</p>
</section>
<section id="model-getting-validation-errors">
<span id="id28"></span><h4><a class="toc-backref" href="#id93" role="doc-backlink">获取验证错误</a><a class="headerlink" href="#model-getting-validation-errors" title="此标题的永久链接"></a></h4>
<p>你可以使用 <code class="docutils literal notranslate"><span class="pre">errors()</span></code> 方法来检索验证错误：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">if</span> <span class="p">(</span><span class="nv">$model</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">(</span><span class="nv">$data</span><span class="p">)</span> <span class="o">===</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">view</span><span class="p">(</span><span class="s1">&#39;updateUser&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;errors&#39;</span> <span class="o">=&gt;</span> <span class="nv">$model</span><span class="o">-&gt;</span><span class="na">errors</span><span class="p">()]);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>这会返回一个包含字段名称及其关联错误的数组,可以用来显示表单顶部的所有错误,或单独显示它们:</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$errors</span><span class="p">))</span><span class="o">:</span> <span class="cp">?&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;alert alert-danger&quot;</span><span class="p">&gt;</span>
    <span class="cp">&lt;?php</span> <span class="k">foreach</span> <span class="p">(</span><span class="nv">$errors</span> <span class="k">as</span> <span class="nv">$field</span> <span class="o">=&gt;</span> <span class="nv">$error</span><span class="p">)</span><span class="o">:</span> <span class="cp">?&gt;</span>
        <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span><span class="cp">&lt;?</span><span class="o">=</span> <span class="nx">esc</span><span class="p">(</span><span class="nv">$error</span><span class="p">)</span> <span class="cp">?&gt;</span><span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
    <span class="cp">&lt;?php</span> <span class="k">endforeach</span> <span class="cp">?&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">endif</span> <span class="cp">?&gt;</span>
</pre></div>
</div>
</section>
<section id="id29">
<h4><a class="toc-backref" href="#id94" role="doc-backlink">检索验证规则</a><a class="headerlink" href="#id29" title="此标题的永久链接"></a></h4>
<p>你可以通过访问其 <code class="docutils literal notranslate"><span class="pre">validationRules</span></code> 属性来检索模型的验证规则:</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="nv">$rules</span> <span class="o">=</span> <span class="nv">$model</span><span class="o">-&gt;</span><span class="na">validationRules</span><span class="p">;</span>
</pre></div>
</div>
<p>你还可以只检索这些规则的一个子集,通过直接调用访问器方法并带上选项:</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="nv">$rules</span> <span class="o">=</span> <span class="nv">$model</span><span class="o">-&gt;</span><span class="na">getValidationRules</span><span class="p">(</span><span class="nv">$options</span><span class="p">);</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">$options</span></code> 参数是一个包含一个元素的关联数组,其关键字是 <code class="docutils literal notranslate"><span class="pre">'except'</span></code> 或 <code class="docutils literal notranslate"><span class="pre">'only'</span></code>,值是一个感兴趣的字段名数组:</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="c1">// get the rules for all but the &quot;username&quot; field</span>
<span class="nv">$rules</span> <span class="o">=</span> <span class="nv">$model</span><span class="o">-&gt;</span><span class="na">getValidationRules</span><span class="p">([</span><span class="s1">&#39;except&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]]);</span>
<span class="c1">// get the rules for only the &quot;city&quot; and &quot;state&quot; fields</span>
<span class="nv">$rules</span> <span class="o">=</span> <span class="nv">$model</span><span class="o">-&gt;</span><span class="na">getValidationRules</span><span class="p">([</span><span class="s1">&#39;only&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;city&#39;</span><span class="p">,</span> <span class="s1">&#39;state&#39;</span><span class="p">]]);</span>
</pre></div>
</div>
</section>
<section id="id30">
<h4><a class="toc-backref" href="#id95" role="doc-backlink">验证占位符</a><a class="headerlink" href="#id30" title="此标题的永久链接"></a></h4>
<p>模型提供了一个简单的方法,根据传入的数据替换规则的一部分。这听起来相当模糊,但在使用 <code class="docutils literal notranslate"><span class="pre">is_unique</span></code> 验证规则时特别方便。占位符只是传入的数据(或数组键)周围的字段名称,用大括号括起来。它将被匹配的传入字段的 <strong>值</strong> 替换。一个示例应该可以澄清这一点:</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">namespace</span> <span class="nx">App\Models</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">CodeIgniter\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">MyModel</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="c1">// ...</span>

    <span class="k">protected</span> <span class="nv">$validationRules</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;id&#39;</span>    <span class="o">=&gt;</span> <span class="s1">&#39;max_length[19]|is_natural_no_zero&#39;</span><span class="p">,</span>
        <span class="s1">&#39;email&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;required|max_length[254]|valid_email|is_unique[users.email,id,{id}]&#39;</span><span class="p">,</span>
    <span class="p">];</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>自 v4.3.5 起，你必须为占位符字段（<code class="docutils literal notranslate"><span class="pre">id</span></code>）设置验证规则。</p>
</div>
<p>在这组规则中,它说明电子邮件地址在数据库中应该是唯一的,除了具有与占位符的值匹配的 id 的行。假设表单 POST 数据如下:</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="nv">$_POST</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;id&#39;</span>    <span class="o">=&gt;</span> <span class="mi">4</span><span class="p">,</span>
    <span class="s1">&#39;email&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;foo@example.com&#39;</span><span class="p">,</span>
<span class="p">];</span>
</pre></div>
</div>
<p>那么 <code class="docutils literal notranslate"><span class="pre">{id}</span></code> 占位符会被数字 <strong>4</strong> 替换,得到这条修改后的规则:</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">namespace</span> <span class="nx">App\Models</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">CodeIgniter\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">MyModel</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="c1">// ...</span>

    <span class="k">protected</span> <span class="nv">$validationRules</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;id&#39;</span>    <span class="o">=&gt;</span> <span class="s1">&#39;max_length[19]|is_natural_no_zero&#39;</span><span class="p">,</span>
        <span class="s1">&#39;email&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;required|max_length[254]|valid_email|is_unique[users.email,id,4]&#39;</span><span class="p">,</span>
    <span class="p">];</span>
<span class="p">}</span>
</pre></div>
</div>
<p>所以在验证电子邮件唯一性时,它会忽略数据库中 <code class="docutils literal notranslate"><span class="pre">id=4</span></code> 的行。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>自 v4.3.5 起，如果占位符（<code class="docutils literal notranslate"><span class="pre">id</span></code>）的值未通过验证，占位符将不会被替换。</p>
</div>
<p>这也可以用于在运行时创建更动态的规则,只要你注意传入的动态键不与你的表单数据冲突即可。</p>
</section>
</section>
<section id="id31">
<h3><a class="toc-backref" href="#id96" role="doc-backlink">保护字段</a><a class="headerlink" href="#id31" title="此标题的永久链接"></a></h3>
<p>为了帮助防止大规模分配攻击,模型类 <strong>要求</strong> 你列出可以在插入和更新期间更改的所有字段名称在 <a class="reference internal" href="#allowedfields">$allowedFields</a> 类属性中。除这些字段外提供的任何数据在插入数据库之前都将被删除。这对确保时间戳或主键不被更改非常有用。</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">namespace</span> <span class="nx">App\Models</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">CodeIgniter\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">MyModel</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="c1">// ...</span>

    <span class="k">protected</span> <span class="nv">$allowedFields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;email&#39;</span><span class="p">,</span> <span class="s1">&#39;address&#39;</span><span class="p">];</span>
<span class="p">}</span>
</pre></div>
</div>
<p>有时,你会发现有时需要能够更改这些元素。这通常发生在测试、迁移或种子期间。在这种情况下,可以打开或关闭保护:</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="nv">$model</span><span class="o">-&gt;</span><span class="na">protect</span><span class="p">(</span><span class="k">false</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="na">insert</span><span class="p">(</span><span class="nv">$data</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="na">protect</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
</pre></div>
</div>
</section>
<section id="id32">
<h3><a class="toc-backref" href="#id97" role="doc-backlink">运行时返回类型更改</a><a class="headerlink" href="#id32" title="此标题的永久链接"></a></h3>
<p>你可以将 <code class="docutils literal notranslate"><span class="pre">find*()</span></code> 方法返回的数据格式指定为类属性 <a class="reference internal" href="#returntype">$returnType</a>。但是,有时你可能希望以不同的格式返回数据。模型提供了允许你做到这一点的方法。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>这些方法仅更改下一个 <strong>find*()</strong> 方法调用的返回类型。之后,它将重置为默认值。</p>
</div>
<section id="asarray">
<h4><a class="toc-backref" href="#id98" role="doc-backlink">asArray()</a><a class="headerlink" href="#asarray" title="此标题的永久链接"></a></h4>
<p>将下一个 <strong>find*()</strong> 方法的数据作为关联数组返回:</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="nv">$users</span> <span class="o">=</span> <span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">asArray</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="s1">&#39;active&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">findAll</span><span class="p">();</span>
</pre></div>
</div>
</section>
<section id="asobject">
<h4><a class="toc-backref" href="#id99" role="doc-backlink">asObject()</a><a class="headerlink" href="#asobject" title="此标题的永久链接"></a></h4>
<p>将下一个 <strong>find*()</strong> 方法的数据作为标准对象或自定义类实例返回:</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="c1">// Return as standard objects</span>
<span class="nv">$users</span> <span class="o">=</span> <span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">asObject</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="s1">&#39;active&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">findAll</span><span class="p">();</span>

<span class="c1">// Return as custom class instances</span>
<span class="nv">$users</span> <span class="o">=</span> <span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">asObject</span><span class="p">(</span><span class="s1">&#39;User&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="s1">&#39;active&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">findAll</span><span class="p">();</span>
</pre></div>
</div>
</section>
</section>
<section id="id33">
<h3><a class="toc-backref" href="#id100" role="doc-backlink">处理大量数据</a><a class="headerlink" href="#id33" title="此标题的永久链接"></a></h3>
<p>有时,你需要处理大量数据,存在耗尽内存的风险。为了简化这一点,你可以使用 chunk() 方法获取较小的块,然后对其执行操作。第一个参数是要在单个块中检索的行数。第二个参数是一个闭包,将为每一行数据调用。</p>
<p>这最适合在定时任务、数据导出或其他大型任务期间使用。</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">chunk</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="k">static</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$data</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// do something.</span>
    <span class="c1">// $data is a single row of data.</span>
<span class="p">});</span>
</pre></div>
</div>
</section>
</section>
<section id="model-events-callbacks">
<span id="id34"></span><h2><a class="toc-backref" href="#id101" role="doc-backlink">使用查询构建器</a><a class="headerlink" href="#model-events-callbacks" title="此标题的永久链接"></a></h2>
<section id="id35">
<h3><a class="toc-backref" href="#id102" role="doc-backlink">获取模型表的查询构建器</a><a class="headerlink" href="#id35" title="此标题的永久链接"></a></h3>
<p>CodeIgniter 模型对该模型的数据库连接有一个查询构建器实例。
你可以在任何需要时访问 <strong>共享</strong> 的查询构建器实例:</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="nv">$builder</span> <span class="o">=</span> <span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">builder</span><span class="p">();</span>
</pre></div>
</div>
<p>此构建器已经使用模型的 <a class="reference internal" href="#table">$table</a> 设置。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>一旦你获取查询构建器实例,你就可以调用查询构建器的方法。
但是,由于查询构建器不是模型,你无法调用模型的方法。</p>
</div>
</section>
<section id="id36">
<h3><a class="toc-backref" href="#id103" role="doc-backlink">获取另一个表的查询构建器</a><a class="headerlink" href="#id36" title="此标题的永久链接"></a></h3>
<p>如果你需要访问另一个表,你可以获取查询构建器的另一个实例。
将表名称作为参数传递,但要注意这 <strong>不会</strong> 返回共享实例:</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="nv">$groupBuilder</span> <span class="o">=</span> <span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">builder</span><span class="p">(</span><span class="s1">&#39;groups&#39;</span><span class="p">);</span>
</pre></div>
</div>
</section>
<section id="id37">
<h3><a class="toc-backref" href="#id104" role="doc-backlink">混合使用查询构建器和模型的方法</a><a class="headerlink" href="#id37" title="此标题的永久链接"></a></h3>
<p>你还可以在同一链式调用中使用查询构建器方法和模型的 CRUD 方法,这允许非常优雅地使用:</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="nv">$users</span> <span class="o">=</span> <span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="s1">&#39;active&#39;</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="na">orderBy</span><span class="p">(</span><span class="s1">&#39;last_login&#39;</span><span class="p">,</span> <span class="s1">&#39;asc&#39;</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="na">findAll</span><span class="p">();</span>
</pre></div>
</div>
<p>在这种情况下,它在模型持有的共享查询构建器实例上操作。</p>
<div class="admonition important">
<p class="admonition-title">重要</p>
<p>模型不为查询构建器提供完美的接口。
模型和查询构建器是具有不同目的的单独类。
它们不应该期望返回相同的数据。</p>
</div>
<p>如果查询构建器返回结果,它将原封不动地返回。
在这种情况下,结果可能与模型方法返回的不同,可能不是预期的。不会触发模型的事件。</p>
<p>为了防止意外行为,请不要在方法链的末尾使用查询构建器方法并指定模型的方法。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>你也可以无缝访问模型的数据库连接:</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="nv">$user_name</span> <span class="o">=</span> <span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">escape</span><span class="p">(</span><span class="nv">$name</span><span class="p">);</span>
</pre></div>
</div>
</div>
</section>
</section>
<section id="model-events">
<span id="id38"></span><h2><a class="toc-backref" href="#id105" role="doc-backlink">模型事件</a><a class="headerlink" href="#model-events" title="此标题的永久链接"></a></h2>
<p>在模型执行的几个点上,你可以指定多个回调方法来运行。这些方法可以用于规范化数据、散列密码、保存相关实体等等。</p>
<p>可以影响以下模型执行点,每个都通过一个类属性:</p>
<ul class="simple">
<li><p><a class="reference internal" href="#beforeinsert">$beforeInsert</a>, <a class="reference internal" href="#afterinsert">$afterInsert</a></p></li>
<li><p><a class="reference internal" href="#beforeupdate">$beforeUpdate</a>, <a class="reference internal" href="#afterupdate">$afterUpdate</a></p></li>
<li><p><a class="reference internal" href="#beforefind">$beforeFind</a>, <a class="reference internal" href="#afterfind">$afterFind</a></p></li>
<li><p><a class="reference internal" href="#beforedelete">$beforeDelete</a>, <a class="reference internal" href="#afterdelete">$afterDelete</a></p></li>
<li><p><a class="reference internal" href="#beforeinsertbatch">$beforeInsertBatch</a>, <a class="reference internal" href="#afterinsertbatch">$afterInsertBatch</a></p></li>
<li><p><a class="reference internal" href="#beforeupdatebatch">$beforeUpdateBatch</a>, <a class="reference internal" href="#afterupdatebatch">$afterUpdateBatch</a></p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p><code class="docutils literal notranslate"><span class="pre">$beforeInsertBatch</span></code>、<code class="docutils literal notranslate"><span class="pre">$afterInsertBatch</span></code>、<code class="docutils literal notranslate"><span class="pre">$beforeUpdateBatch</span></code> 和
<code class="docutils literal notranslate"><span class="pre">$afterUpdateBatch</span></code> 可以从 v4.3.0 开始使用。</p>
</div>
<section id="id39">
<h3><a class="toc-backref" href="#id106" role="doc-backlink">定义回调函数</a><a class="headerlink" href="#id39" title="此标题的永久链接"></a></h3>
<p>你可以通过在模型中创建一个新的类方法来指定回调函数。</p>
<p>这个类方法总是会接收一个 <code class="docutils literal notranslate"><span class="pre">$data</span></code> 数组作为唯一的参数。</p>
<p><code class="docutils literal notranslate"><span class="pre">$data</span></code> 数组的具体内容会因事件而异，但总是会包含一个名为 <code class="docutils literal notranslate"><span class="pre">data</span></code> 的键，该键包含传递给原始方法的主要数据。在 <strong>insert*()</strong> 或 <strong>update*()</strong> 方法的情况下，这将是正在插入到数据库中的键/值对。主要的 <code class="docutils literal notranslate"><span class="pre">$data</span></code> 数组也会包含传递给方法的其他值，并在 <a class="reference internal" href="#id41">事件参数</a> 中详细说明。</p>
<p>回调方法必须返回原始的 <code class="docutils literal notranslate"><span class="pre">$data</span></code> 数组，以便其他回调函数获取完整信息。</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">namespace</span> <span class="nx">App\Models</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">CodeIgniter\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">MyModel</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="c1">// ...</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="nf">hashPassword</span><span class="p">(</span><span class="k">array</span> <span class="nv">$data</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;password&#39;</span><span class="p">]))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nv">$data</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nv">$data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;password_hash&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">password_hash</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;password&#39;</span><span class="p">],</span> <span class="nx">PASSWORD_DEFAULT</span><span class="p">);</span>
        <span class="nb">unset</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;password&#39;</span><span class="p">]);</span>

        <span class="k">return</span> <span class="nv">$data</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="id40">
<h3><a class="toc-backref" href="#id107" role="doc-backlink">指定要运行的回调</a><a class="headerlink" href="#id40" title="此标题的永久链接"></a></h3>
<p>你可以通过将方法名称添加到适当的类属性(<a class="reference internal" href="#beforeinsert">$beforeInsert</a>, <a class="reference internal" href="#afterupdate">$afterUpdate</a> 等)来指定运行回调时机。可以向单个事件添加多个回调,并且它们将一个接一个地处理。你可以在多个事件中使用相同的回调:</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">namespace</span> <span class="nx">App\Models</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">CodeIgniter\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">MyModel</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="c1">// ...</span>

    <span class="k">protected</span> <span class="nv">$beforeInsert</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;hashPassword&#39;</span><span class="p">];</span>
    <span class="k">protected</span> <span class="nv">$beforeUpdate</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;hashPassword&#39;</span><span class="p">];</span>

    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>此外,每个模型可以通过设置其 <a class="reference internal" href="#allowcallbacks">$allowCallbacks</a> 属性在类级别允许(默认)或拒绝回调。</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">namespace</span> <span class="nx">App\Models</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">CodeIgniter\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">MyModel</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="c1">// ...</span>

    <span class="k">protected</span> <span class="nv">$allowCallbacks</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>

    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>你也可以使用 <code class="docutils literal notranslate"><span class="pre">allowCallbacks()</span></code> 方法针对单个模型调用暂时更改此设置:</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="nv">$model</span><span class="o">-&gt;</span><span class="na">allowCallbacks</span><span class="p">(</span><span class="k">false</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="c1">// No callbacks triggered</span>
<span class="nv">$model</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="c1">// Callbacks subject to original property value</span>
</pre></div>
</div>
</section>
<section id="id41">
<h3><a class="toc-backref" href="#id108" role="doc-backlink">事件参数</a><a class="headerlink" href="#id41" title="此标题的永久链接"></a></h3>
<p>由于传递给每个回调的确切数据各不相同,因此这里详细介绍了传递给每个事件的 <code class="docutils literal notranslate"><span class="pre">$data</span></code> 参数中的内容:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>事件</p></th>
<th class="head"><p>$data 内容</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>beforeInsert</p></td>
<td><p><strong>data</strong> = 正在插入的键/值对。如果将对象或 Entity 类传递给
<code class="docutils literal notranslate"><span class="pre">insert()</span></code> 方法，它首先会被转换为数组。</p></td>
</tr>
<tr class="row-odd"><td><p>afterInsert</p></td>
<td><p><strong>id</strong> = 新行的主键，如果失败则为 0。
<strong>data</strong> = 正在插入的键/值对。
<strong>result</strong> = 通过查询构建器使用的 <code class="docutils literal notranslate"><span class="pre">insert()</span></code> 方法的结果。</p></td>
</tr>
<tr class="row-even"><td><p>beforeUpdate</p></td>
<td><p><strong>id</strong> = 正在更新的行的主键数组。
<strong>data</strong> = 正在更新的键/值对。如果将对象或 Entity 类传递给
<code class="docutils literal notranslate"><span class="pre">update()</span></code> 方法，它首先会被转换为数组。</p></td>
</tr>
<tr class="row-odd"><td><p>afterUpdate</p></td>
<td><p><strong>id</strong> = 正在更新的行的主键数组。
<strong>data</strong> = 正在更新的键/值对。
<strong>result</strong> = 通过查询构建器使用的 <code class="docutils literal notranslate"><span class="pre">update()</span></code> 方法的结果。</p></td>
</tr>
<tr class="row-even"><td><p>beforeFind</p></td>
<td><p>调用 <strong>method</strong> 的名称，是否请求了 <strong>singleton</strong>，以及以下附加字段：</p></td>
</tr>
<tr class="row-odd"><td><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">first()</span></code></p></li>
</ul>
</td>
<td><p>没有附加字段</p></td>
</tr>
<tr class="row-even"><td><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">find()</span></code></p></li>
</ul>
</td>
<td><p><strong>id</strong> = 正在搜索的行的主键。</p></td>
</tr>
<tr class="row-odd"><td><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">findAll()</span></code></p></li>
</ul>
</td>
<td><p><strong>limit</strong> = 要查找的行数。
<strong>offset</strong> = 在搜索过程中要跳过的行数。</p></td>
</tr>
<tr class="row-even"><td><p>afterFind</p></td>
<td><p>与 <strong>beforeFind</strong> 相同，但包括找到的行的数据结果，如果没有找到结果则为 null。</p></td>
</tr>
<tr class="row-odd"><td><p>beforeDelete</p></td>
<td><p><strong>id</strong> = 被传递给 <code class="docutils literal notranslate"><span class="pre">delete()</span></code> 方法的行的主键。
<strong>purge</strong> = 是否应硬删除软删除的行的布尔值。</p></td>
</tr>
<tr class="row-even"><td><p>afterDelete</p></td>
<td><p><strong>id</strong> = 被传递给 <code class="docutils literal notranslate"><span class="pre">delete()</span></code> 方法的行的主键。
<strong>purge</strong> = 是否应硬删除软删除的行的布尔值。
<strong>result</strong> = 在查询构建器上调用 <code class="docutils literal notranslate"><span class="pre">delete()</span></code> 的结果。
<strong>data</strong> = 未使用。</p></td>
</tr>
<tr class="row-odd"><td><p>beforeInsertBatch</p></td>
<td><p><strong>data</strong> = 正在插入的值的关联数组。如果将对象或 Entity 类传递给
<code class="docutils literal notranslate"><span class="pre">insertBatch()</span></code> 方法，它首先会被转换为数组。</p></td>
</tr>
<tr class="row-even"><td><p>afterInsertBatch</p></td>
<td><p><strong>data</strong> = 正在插入的值的关联数组。
<strong>result</strong> = 通过查询构建器使用的 <code class="docutils literal notranslate"><span class="pre">insertBatch()</span></code> 方法的结果。</p></td>
</tr>
<tr class="row-odd"><td><p>beforeUpdateBatch</p></td>
<td><p><strong>data</strong> = 正在更新的值的关联数组。如果将对象或 Entity 类传递给
<code class="docutils literal notranslate"><span class="pre">updateBatch()</span></code> 方法，它首先会被转换为数组。</p></td>
</tr>
<tr class="row-even"><td><p>afterUpdateBatch</p></td>
<td><p><strong>data</strong> = 正在更新的键/值对。
<strong>result</strong> = 通过查询构建器使用的 <code class="docutils literal notranslate"><span class="pre">updateBatch()</span></code> 方法的结果。</p></td>
</tr>
</tbody>
</table>
</section>
<section id="id42">
<h3><a class="toc-backref" href="#id109" role="doc-backlink">修改 Find* 数据</a><a class="headerlink" href="#id42" title="此标题的永久链接"></a></h3>
<p><code class="docutils literal notranslate"><span class="pre">beforeFind</span></code> 和 <code class="docutils literal notranslate"><span class="pre">afterFind</span></code> 方法都可以返回修改后的数据集以覆盖正常的模型响应。 对于 <code class="docutils literal notranslate"><span class="pre">afterFind</span></code> 返回数组中对 <code class="docutils literal notranslate"><span class="pre">data</span></code> 所做的任何更改都将自动传递回调用上下文。 为了使 <code class="docutils literal notranslate"><span class="pre">beforeFind</span></code> 拦截查找工作流,它还必须返回一个额外的布尔值 <code class="docutils literal notranslate"><span class="pre">returnData</span></code>:</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">namespace</span> <span class="nx">App\Models</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">CodeIgniter\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">MyModel</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="c1">// ...</span>

    <span class="k">protected</span> <span class="nv">$beforeFind</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;checkCache&#39;</span><span class="p">];</span>

    <span class="c1">// ...</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="nf">checkCache</span><span class="p">(</span><span class="k">array</span> <span class="nv">$data</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// Check if the requested item is already in our cache</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$item</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getCachedItem</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]))</span> <span class="p">{</span>
            <span class="nv">$data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>       <span class="o">=</span> <span class="nv">$item</span><span class="p">;</span>
            <span class="nv">$data</span><span class="p">[</span><span class="s1">&#39;returnData&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>

            <span class="k">return</span> <span class="nv">$data</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// ...</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="id43">
<h2><a class="toc-backref" href="#id110" role="doc-backlink">手动创建模型</a><a class="headerlink" href="#id43" title="此标题的永久链接"></a></h2>
<p>你不需要扩展任何特殊类就可以为应用程序创建模型。你所需要的只是获取数据库连接的一个实例,就可以开始了。这允许你绕过 CodeIgniter 模型提供的开箱即用的功能,并创建一个完全自定义的体验。</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">namespace</span> <span class="nx">App\Models</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">CodeIgniter\Database\ConnectionInterface</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">UserModel</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="nv">$db</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nx">ConnectionInterface</span> <span class="nv">$db</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">db</span> <span class="o">=</span> <span class="nv">$db</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="页脚">
        <a href="index.html" class="btn btn-neutral float-left" title="数据建模" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> 上一页</a>
        <a href="entities.html" class="btn btn-neutral float-right" title="使用实体类" accesskey="n" rel="next">下一页 <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2019-2024 CodeIgniter 基金会.
      <span class="lastupdated">最后更新于 2024-07-11.
      </span></p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用的 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a> 开发.
  
<jinja2.runtime.BlockReference object at 0x7fc05bbb1e50>

<div style="margin-top: 16px;">
  <p>由 <a href="https://codeigniter.org.cn">CodeIgniter 中国开发者社区</a>翻译并制作</p>
  <p style="margin-bottom: 0;">
    <a href="https://github.com/CodeIgniter-Chinese/codeigniter4-user-guide" target="_blank">Github 简体中文翻译</a>
    ·
    <a href="https://codeigniter-chinese.github.io/codeigniter4-user-guide/codeigniter_user_guide.zip">离线版压缩包下载</a>
    ·
    <a href="https://codeigniter-chinese.github.io/codeigniter4-user-guide/CodeIgniter.pdf">PDF 版下载</a>
  </p>
</div>


</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(false);
      });
  </script> 

</body>
</html>