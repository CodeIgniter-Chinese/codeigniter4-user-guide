<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN">
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>使用 CodeIgniter 的模型 &mdash; CodeIgniter 4.6.0 中文手册|用户手册|用户指南|中文文档</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../_static/css/citheme.css" />
      <link rel="stylesheet" type="text/css" href="../_static/css/citheme_dark.css" />

  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
        <script src="../_static/translations.js"></script>
        <script src="../_static/js/citheme.js"></script>
        <script src="../_static/js/carbon.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="搜索" href="../search.html" />
    <link rel="next" title="使用实体类" href="entities.html" />
    <link rel="prev" title="数据建模" href="index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html">
            
              <img src="../_static/ci-logo-text.svg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="搜索文档" aria-label="搜索文档" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="导航菜单">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../intro/index.html">欢迎使用 CodeIgniter4</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../intro/index.html">欢迎使用 CodeIgniter4</a></li>
<li class="toctree-l2"><a class="reference internal" href="../intro/requirements.html">服务器要求</a></li>
<li class="toctree-l2"><a class="reference internal" href="../intro/credits.html">致谢</a></li>
<li class="toctree-l2"><a class="reference internal" href="../intro/psr.html">PSR 兼容性</a></li>
<li class="toctree-l2"><a class="reference internal" href="../license.html">许可协议</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../installation/index.html">安装</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../installation/installing_composer.html">Composer 安装</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation/installing_manual.html">手动安装</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation/running.html">运行你的应用程序</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation/troubleshooting.html">故障排除</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation/deployment.html">部署</a></li>
<li class="toctree-l2"><a class="reference internal" href="../changelogs/index.html">变更记录</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation/upgrading.html">从前一版本升级</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation/repositories.html">CodeIgniter 仓库</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tutorial/index.html">构建你的第一个应用程序</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../tutorial/static_pages.html">静态页面</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorial/news_section.html">新闻部分</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorial/create_news_items.html">创建新闻</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorial/conclusion.html">结束语</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../concepts/index.html">CodeIgniter4 概览</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../concepts/structure.html">应用程序结构</a></li>
<li class="toctree-l2"><a class="reference internal" href="../concepts/mvc.html">模型、视图和控制器</a></li>
<li class="toctree-l2"><a class="reference internal" href="../concepts/autoloader.html">自动加载文件</a></li>
<li class="toctree-l2"><a class="reference internal" href="../concepts/services.html">服务</a></li>
<li class="toctree-l2"><a class="reference internal" href="../concepts/factories.html">工厂</a></li>
<li class="toctree-l2"><a class="reference internal" href="../concepts/http.html">处理 HTTP 请求</a></li>
<li class="toctree-l2"><a class="reference internal" href="../concepts/security.html">安全指南</a></li>
<li class="toctree-l2"><a class="reference internal" href="../concepts/goals.html">设计与架构目标</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../general/index.html">常规主题</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../general/configuration.html">配置</a></li>
<li class="toctree-l2"><a class="reference internal" href="../general/urls.html">CodeIgniter URL</a></li>
<li class="toctree-l2"><a class="reference internal" href="../general/helpers.html">辅助函数</a></li>
<li class="toctree-l2"><a class="reference internal" href="../general/common_functions.html">全局函数和常量</a></li>
<li class="toctree-l2"><a class="reference internal" href="../general/logging.html">记录信息</a></li>
<li class="toctree-l2"><a class="reference internal" href="../general/errors.html">错误处理</a></li>
<li class="toctree-l2"><a class="reference internal" href="../general/caching.html">网页缓存</a></li>
<li class="toctree-l2"><a class="reference internal" href="../general/ajax.html">AJAX 请求</a></li>
<li class="toctree-l2"><a class="reference internal" href="../general/modules.html">代码模块</a></li>
<li class="toctree-l2"><a class="reference internal" href="../general/managing_apps.html">管理应用程序</a></li>
<li class="toctree-l2"><a class="reference internal" href="../general/environments.html">处理多个环境</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../incoming/index.html">控制器和路由</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../incoming/routing.html">URI 路由</a></li>
<li class="toctree-l2"><a class="reference internal" href="../incoming/controllers.html">控制器</a></li>
<li class="toctree-l2"><a class="reference internal" href="../incoming/filters.html">控制器过滤器</a></li>
<li class="toctree-l2"><a class="reference internal" href="../incoming/auto_routing_improved.html">自动路由（改进版）</a></li>
<li class="toctree-l2"><a class="reference internal" href="../incoming/message.html">HTTP 消息</a></li>
<li class="toctree-l2"><a class="reference internal" href="../incoming/request.html">请求类</a></li>
<li class="toctree-l2"><a class="reference internal" href="../incoming/incomingrequest.html">IncomingRequest 类</a></li>
<li class="toctree-l2"><a class="reference internal" href="../incoming/content_negotiation.html">内容协商</a></li>
<li class="toctree-l2"><a class="reference internal" href="../incoming/methodspoofing.html">HTTP 方法欺骗</a></li>
<li class="toctree-l2"><a class="reference internal" href="../incoming/restful.html">RESTful 资源处理</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../outgoing/index.html">构建响应</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../outgoing/views.html">视图</a></li>
<li class="toctree-l2"><a class="reference internal" href="../outgoing/view_renderer.html">视图渲染器</a></li>
<li class="toctree-l2"><a class="reference internal" href="../outgoing/view_layouts.html">视图布局</a></li>
<li class="toctree-l2"><a class="reference internal" href="../outgoing/view_cells.html">视图单元</a></li>
<li class="toctree-l2"><a class="reference internal" href="../outgoing/view_parser.html">视图解析器</a></li>
<li class="toctree-l2"><a class="reference internal" href="../outgoing/view_decorators.html">视图装饰器</a></li>
<li class="toctree-l2"><a class="reference internal" href="../outgoing/table.html">HTML 表格类</a></li>
<li class="toctree-l2"><a class="reference internal" href="../outgoing/response.html">HTTP 响应</a></li>
<li class="toctree-l2"><a class="reference internal" href="../outgoing/api_responses.html">API 响应特性</a></li>
<li class="toctree-l2"><a class="reference internal" href="../outgoing/csp.html">内容安全策略</a></li>
<li class="toctree-l2"><a class="reference internal" href="../outgoing/localization.html">本地化</a></li>
<li class="toctree-l2"><a class="reference internal" href="../outgoing/alternative_php.html">在视图文件中使用 PHP 替代语法</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../database/index.html">使用数据库</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../database/examples.html">快速入门:使用示例</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/configuration.html">数据库配置</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/connecting.html">连接数据库</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/queries.html">运行查询</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/results.html">生成查询结果</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/helpers.html">查询辅助方法</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/query_builder.html">查询构建器类</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/transactions.html">事务</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/metadata.html">获取元数据</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/call_function.html">自定义函数调用</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/events.html">数据库事件</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database/utilities.html">数据库实用工具</a></li>
</ul>
</li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">数据建模</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">使用 CodeIgniter 的模型</a></li>
<li class="toctree-l2"><a class="reference internal" href="entities.html">使用实体类</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../dbmgmt/index.html">管理数据库</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../dbmgmt/forge.html">数据库 Forge</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dbmgmt/migration.html">数据库迁移</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dbmgmt/seeds.html">数据库填充</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dbmgmt/db_commands.html">数据库命令</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../libraries/index.html">类库参考</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../libraries/caching.html">缓存驱动</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libraries/cookies.html">Cookie</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libraries/cors.html">跨域资源共享 (CORS)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libraries/curlrequest.html">CURLRequest 类</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libraries/email.html">Email 类</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libraries/encryption.html">加密服务</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libraries/files.html">文件处理</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libraries/file_collections.html">文件集合</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libraries/honeypot.html">蜜罐类</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libraries/images.html">图像处理类</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libraries/pagination.html">分页</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libraries/publisher.html">Publisher</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libraries/security.html">安全</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libraries/sessions.html">Session 库</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libraries/throttler.html">限速器</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libraries/time.html">时间与日期</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libraries/typography.html">排版</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libraries/uploaded_files.html">处理上传的文件</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libraries/uri.html">使用 URI</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libraries/user_agent.html">User Agent 类</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libraries/validation.html">数据验证</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../helpers/index.html">辅助函数</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../helpers/array_helper.html">数组辅助函数</a></li>
<li class="toctree-l2"><a class="reference internal" href="../helpers/cookie_helper.html">Cookie 辅助函数</a></li>
<li class="toctree-l2"><a class="reference internal" href="../helpers/date_helper.html">日期辅助函数</a></li>
<li class="toctree-l2"><a class="reference internal" href="../helpers/filesystem_helper.html">文件系统辅助函数</a></li>
<li class="toctree-l2"><a class="reference internal" href="../helpers/form_helper.html">表单辅助函数</a></li>
<li class="toctree-l2"><a class="reference internal" href="../helpers/html_helper.html">HTML 辅助函数</a></li>
<li class="toctree-l2"><a class="reference internal" href="../helpers/inflector_helper.html">Inflector 辅助函数</a></li>
<li class="toctree-l2"><a class="reference internal" href="../helpers/number_helper.html">数字辅助函数</a></li>
<li class="toctree-l2"><a class="reference internal" href="../helpers/security_helper.html">安全辅助函数</a></li>
<li class="toctree-l2"><a class="reference internal" href="../helpers/test_helper.html">测试辅助函数</a></li>
<li class="toctree-l2"><a class="reference internal" href="../helpers/text_helper.html">文本辅助函数</a></li>
<li class="toctree-l2"><a class="reference internal" href="../helpers/url_helper.html">URL 辅助函数</a></li>
<li class="toctree-l2"><a class="reference internal" href="../helpers/xml_helper.html">XML 辅助函数</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../testing/index.html">测试</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../testing/overview.html">入门指南</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing/database.html">数据库</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing/fabricator.html">生成数据</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing/controllers.html">测试控制器</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing/feature.html">HTTP 测试</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing/response.html">测试响应</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing/cli.html">测试 CLI 命令</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing/mocking.html">模拟</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing/benchmark.html">基准测试</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing/debugging.html">调试应用程序</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../cli/index.html">命令行使用</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../cli/cli_overview.html">CLI 概览</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cli/cli_controllers.html">通过 CLI 运行控制器</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cli/spark_commands.html">Spark 命令</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cli/cli_commands.html">创建 Spark 命令</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cli/cli_generators.html">CLI 生成器</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cli/cli_library.html">CLI 库</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cli/cli_request.html">CLIRequest 类</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../extending/index.html">扩展 CodeIgniter</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../extending/core_classes.html">创建核心系统类</a></li>
<li class="toctree-l2"><a class="reference internal" href="../extending/common.html">替换通用函数</a></li>
<li class="toctree-l2"><a class="reference internal" href="../extending/events.html">事件</a></li>
<li class="toctree-l2"><a class="reference internal" href="../extending/basecontroller.html">扩展控制器</a></li>
<li class="toctree-l2"><a class="reference internal" href="../extending/authentication.html">身份验证</a></li>
<li class="toctree-l2"><a class="reference internal" href="../extending/composer_packages.html">创建 Composer 包</a></li>
<li class="toctree-l2"><a class="reference internal" href="../extending/contributing.html">为 CodeIgniter 做贡献</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../libraries/official_packages.html">官方包</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="移动版导航菜单" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">CodeIgniter</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="页面导航">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">数据建模</a></li>
      <li class="breadcrumb-item active">使用 CodeIgniter 的模型</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="codeigniter">
<h1>使用 CodeIgniter 的模型<a class="headerlink" href="#codeigniter" title="此标题的永久链接"></a></h1>
<nav class="contents local" id="id1">
<ul class="simple">
<li><p><a class="reference internal" href="#id2" id="id44">模型</a></p></li>
<li><p><a class="reference internal" href="#accessing-models" id="id45">访问模型</a></p></li>
<li><p><a class="reference internal" href="#id4" id="id46">CodeIgniter 的模型</a></p></li>
<li><p><a class="reference internal" href="#id5" id="id47">创建模型</a></p>
<ul>
<li><p><a class="reference internal" href="#initialize" id="id48">initialize()</a></p></li>
<li><p><a class="reference internal" href="#id6" id="id49">连接数据库</a></p></li>
<li><p><a class="reference internal" href="#id7" id="id50">配置模型</a></p>
<ul>
<li><p><a class="reference internal" href="#table" id="id51">$table</a></p></li>
<li><p><a class="reference internal" href="#primarykey" id="id52">$primaryKey</a></p></li>
<li><p><a class="reference internal" href="#useautoincrement" id="id53">$useAutoIncrement</a></p></li>
<li><p><a class="reference internal" href="#returntype" id="id54">$returnType</a></p></li>
<li><p><a class="reference internal" href="#usesoftdeletes" id="id55">$useSoftDeletes</a></p></li>
<li><p><a class="reference internal" href="#allowedfields" id="id56">$allowedFields</a></p></li>
<li><p><a class="reference internal" href="#allowemptyinserts" id="id57">$allowEmptyInserts</a></p></li>
<li><p><a class="reference internal" href="#updateonlychanged" id="id58">$updateOnlyChanged</a></p></li>
<li><p><a class="reference internal" href="#casts" id="id59">$casts</a></p></li>
<li><p><a class="reference internal" href="#id8" id="id60">日期配置</a></p></li>
<li><p><a class="reference internal" href="#id9" id="id61">验证</a></p></li>
<li><p><a class="reference internal" href="#id10" id="id62">回调</a></p></li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference internal" href="#model-field-casting" id="id63">模型字段类型转换</a></p>
<ul>
<li><p><a class="reference internal" href="#id12" id="id64">定义数据类型</a></p></li>
<li><p><a class="reference internal" href="#id13" id="id65">数据类型</a></p>
<ul>
<li><p><a class="reference internal" href="#csv" id="id66">csv</a></p></li>
<li><p><a class="reference internal" href="#datetime" id="id67">datetime</a></p></li>
<li><p><a class="reference internal" href="#timestamp" id="id68">timestamp</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id14" id="id69">自定义类型转换</a></p>
<ul>
<li><p><a class="reference internal" href="#id15" id="id70">创建自定义处理器</a></p></li>
<li><p><a class="reference internal" href="#id16" id="id71">注册自定义处理器</a></p></li>
<li><p><a class="reference internal" href="#id17" id="id72">参数</a></p></li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference internal" href="#id18" id="id73">处理数据</a></p>
<ul>
<li><p><a class="reference internal" href="#id19" id="id74">查找数据</a></p>
<ul>
<li><p><a class="reference internal" href="#find" id="id75">find()</a></p></li>
<li><p><a class="reference internal" href="#findcolumn" id="id76">findColumn()</a></p></li>
<li><p><a class="reference internal" href="#findall" id="id77">findAll()</a></p></li>
<li><p><a class="reference internal" href="#first" id="id78">first()</a></p></li>
<li><p><a class="reference internal" href="#withdeleted" id="id79">withDeleted()</a></p></li>
<li><p><a class="reference internal" href="#onlydeleted" id="id80">onlyDeleted()</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id20" id="id81">保存数据</a></p>
<ul>
<li><p><a class="reference internal" href="#insert" id="id82">insert()</a></p></li>
<li><p><a class="reference internal" href="#model-allow-empty-inserts" id="id83">allowEmptyInserts()</a></p></li>
<li><p><a class="reference internal" href="#update" id="id84">update()</a></p></li>
<li><p><a class="reference internal" href="#save" id="id85">save()</a></p></li>
<li><p><a class="reference internal" href="#model-saving-dates" id="id86">保存日期</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id23" id="id87">删除数据</a></p>
<ul>
<li><p><a class="reference internal" href="#delete" id="id88">delete()</a></p></li>
<li><p><a class="reference internal" href="#purgedeleted" id="id89">purgeDeleted()</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#in-model-validation" id="id90">模型内验证</a></p>
<ul>
<li><p><a class="reference internal" href="#id25" id="id91">验证数据</a></p></li>
<li><p><a class="reference internal" href="#model-setting-validation-rules" id="id92">设置验证规则</a></p></li>
<li><p><a class="reference internal" href="#id27" id="id93">获取验证结果</a></p></li>
<li><p><a class="reference internal" href="#model-getting-validation-errors" id="id94">获取验证错误</a></p></li>
<li><p><a class="reference internal" href="#id29" id="id95">检索验证规则</a></p></li>
<li><p><a class="reference internal" href="#id30" id="id96">验证占位符</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id31" id="id97">保护字段</a></p></li>
<li><p><a class="reference internal" href="#id32" id="id98">运行时返回类型变更</a></p>
<ul>
<li><p><a class="reference internal" href="#asarray" id="id99">asArray()</a></p></li>
<li><p><a class="reference internal" href="#asobject" id="id100">asObject()</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id33" id="id101">处理大量数据</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#model-events-callbacks" id="id102">使用查询构建器</a></p>
<ul>
<li><p><a class="reference internal" href="#id35" id="id103">获取模型的查询构建器</a></p></li>
<li><p><a class="reference internal" href="#id36" id="id104">获取其他表的查询构建器</a></p></li>
<li><p><a class="reference internal" href="#id37" id="id105">混合使用查询构建器和模型方法</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#model-events" id="id106">模型事件</a></p>
<ul>
<li><p><a class="reference internal" href="#id39" id="id107">定义回调</a></p></li>
<li><p><a class="reference internal" href="#id40" id="id108">指定运行的回调</a></p></li>
<li><p><a class="reference internal" href="#id41" id="id109">事件参数</a></p></li>
<li><p><a class="reference internal" href="#id42" id="id110">修改 Find* 数据</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id43" id="id111">手动创建模型</a></p></li>
</ul>
</nav>
<section id="id2">
<h2><a class="toc-backref" href="#id44" role="doc-backlink">模型</a><a class="headerlink" href="#id2" title="此标题的永久链接"></a></h2>
<p>CodeIgniter 的模型提供了便捷功能和额外特性，使得在数据库中操作 <strong>单张表</strong> 更加方便。</p>
<p>它内置了常用数据库表交互的辅助函数，包括查找记录、更新记录、删除记录等标准操作。</p>
</section>
<section id="accessing-models">
<span id="id3"></span><h2><a class="toc-backref" href="#id45" role="doc-backlink">访问模型</a><a class="headerlink" href="#accessing-models" title="此标题的永久链接"></a></h2>
<p>模型通常存储在 <strong>app/Models</strong> 目录中，其命名空间应与目录位置匹配，例如 <code class="docutils literal notranslate"><span class="pre">namespace</span> <span class="pre">App\Models</span></code>。</p>
<p>可以通过创建新实例或使用 <a class="reference internal" href="../general/common_functions.html#model" title="model"><code class="xref php php-func docutils literal notranslate"><span class="pre">model()</span></code></a> 辅助函数在类中访问模型：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="c1">// Create a new class manually.</span>
<span class="nv">$userModel</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\App\Models\UserModel</span><span class="p">();</span>

<span class="c1">// Create a shared instance of the model.</span>
<span class="nv">$userModel</span> <span class="o">=</span> <span class="nx">model</span><span class="p">(</span><span class="s1">&#39;UserModel&#39;</span><span class="p">);</span>
<span class="c1">// or</span>
<span class="nv">$userModel</span> <span class="o">=</span> <span class="nx">model</span><span class="p">(</span><span class="s1">&#39;App\Models\UserModel&#39;</span><span class="p">);</span>
<span class="c1">// or</span>
<span class="nv">$userModel</span> <span class="o">=</span> <span class="nx">model</span><span class="p">(</span><span class="nx">\App\Models\UserModel</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>

<span class="c1">// Create a new class with the model() function.</span>
<span class="nv">$userModel</span> <span class="o">=</span> <span class="nx">model</span><span class="p">(</span><span class="s1">&#39;UserModel&#39;</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span>

<span class="c1">// Create shared instance with a supplied database connection.</span>
<span class="nv">$db</span>        <span class="o">=</span> <span class="nx">db_connect</span><span class="p">(</span><span class="s1">&#39;custom&#39;</span><span class="p">);</span>
<span class="nv">$userModel</span> <span class="o">=</span> <span class="nx">model</span><span class="p">(</span><span class="s1">&#39;UserModel&#39;</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="nv">$db</span><span class="p">);</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">model()</span></code> 内部使用 <code class="docutils literal notranslate"><span class="pre">Factories::models()</span></code>。有关第一个参数的详细信息，请参阅 <a class="reference internal" href="../concepts/factories.html#factories-loading-class"><span class="std std-ref">加载类</span></a>。</p>
</section>
<section id="id4">
<h2><a class="toc-backref" href="#id46" role="doc-backlink">CodeIgniter 的模型</a><a class="headerlink" href="#id4" title="此标题的永久链接"></a></h2>
<p>CodeIgniter 提供的模型类包含以下特性：</p>
<ul class="simple">
<li><p>自动数据库连接</p></li>
<li><p>基础 CRUD 方法</p></li>
<li><p><a class="reference internal" href="#in-model-validation"><span class="std std-ref">模型内验证</span></a></p></li>
<li><p><a class="reference internal" href="../libraries/pagination.html#paginating-with-models"><span class="std std-ref">自动分页</span></a></p></li>
<li><p>及其他功能</p></li>
</ul>
<p>该类为构建自定义模型提供了坚实基础，可快速构建应用程序的模型层。</p>
</section>
<section id="id5">
<h2><a class="toc-backref" href="#id47" role="doc-backlink">创建模型</a><a class="headerlink" href="#id5" title="此标题的永久链接"></a></h2>
<p>要使用 CodeIgniter 的模型，只需新建继承自 <code class="docutils literal notranslate"><span class="pre">CodeIgniter\Model</span></code> 的模型类：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">namespace</span> <span class="nx">App\Models</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">CodeIgniter\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">UserModel</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>这个空类提供了对数据库连接、查询构建器和多个便捷方法的访问。</p>
<section id="initialize">
<h3><a class="toc-backref" href="#id48" role="doc-backlink">initialize()</a><a class="headerlink" href="#initialize" title="此标题的永久链接"></a></h3>
<p>如需在模型中进行额外设置，可扩展 <code class="docutils literal notranslate"><span class="pre">initialize()</span></code> 方法。该方法会在模型构造函数之后立即执行，避免重复构造函数参数，例如扩展其他模型：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">namespace</span> <span class="nx">App\Models</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Modules\Authentication\Models\UserAuthModel</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">UserModel</span> <span class="k">extends</span> <span class="nx">UserAuthModel</span>
<span class="p">{</span>
    <span class="c1">// ...</span>

    <span class="sd">/**</span>
<span class="sd">     * Called during initialization. Appends</span>
<span class="sd">     * our custom field to the module&#39;s model.</span>
<span class="sd">     */</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="nf">initialize</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">allowedFields</span><span class="p">[]</span> <span class="o">=</span> <span class="s1">&#39;middlename&#39;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="id6">
<h3><a class="toc-backref" href="#id49" role="doc-backlink">连接数据库</a><a class="headerlink" href="#id6" title="此标题的永久链接"></a></h3>
<p>当类首次实例化时，如果没有数据库连接实例传递给构造函数，且未在模型类中设置 <code class="docutils literal notranslate"><span class="pre">$DBGroup</span></code> 属性，模型会自动连接到数据库配置中设置的默认组。</p>
<p>通过添加 <code class="docutils literal notranslate"><span class="pre">$DBGroup</span></code> 属性可修改每个模型使用的数据库组，确保模型中所有 <code class="docutils literal notranslate"><span class="pre">$this-&gt;db</span></code> 引用都通过正确的连接进行：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">namespace</span> <span class="nx">App\Models</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">CodeIgniter\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">UserModel</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="nv">$DBGroup</span> <span class="o">=</span> <span class="s1">&#39;group_name&#39;</span><span class="p">;</span>

    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>将 “group_name” 替换为数据库配置文件中定义的数据库组名称。</p>
</section>
<section id="id7">
<h3><a class="toc-backref" href="#id50" role="doc-backlink">配置模型</a><a class="headerlink" href="#id7" title="此标题的永久链接"></a></h3>
<p>模型类提供以下配置选项，使类方法能无缝工作：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">namespace</span> <span class="nx">App\Models</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">CodeIgniter\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">UserModel</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="nv">$table</span>      <span class="o">=</span> <span class="s1">&#39;users&#39;</span><span class="p">;</span>
    <span class="k">protected</span> <span class="nv">$primaryKey</span> <span class="o">=</span> <span class="s1">&#39;id&#39;</span><span class="p">;</span>

    <span class="k">protected</span> <span class="nv">$useAutoIncrement</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>

    <span class="k">protected</span> <span class="nv">$returnType</span>     <span class="o">=</span> <span class="s1">&#39;array&#39;</span><span class="p">;</span>
    <span class="k">protected</span> <span class="nv">$useSoftDeletes</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>

    <span class="k">protected</span> <span class="nv">$allowedFields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;email&#39;</span><span class="p">];</span>

    <span class="k">protected</span> <span class="nx">bool</span> <span class="nv">$allowEmptyInserts</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
    <span class="k">protected</span> <span class="nx">bool</span> <span class="nv">$updateOnlyChanged</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>

    <span class="c1">// Dates</span>
    <span class="k">protected</span> <span class="nv">$useTimestamps</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
    <span class="k">protected</span> <span class="nv">$dateFormat</span>    <span class="o">=</span> <span class="s1">&#39;datetime&#39;</span><span class="p">;</span>
    <span class="k">protected</span> <span class="nv">$createdField</span>  <span class="o">=</span> <span class="s1">&#39;created_at&#39;</span><span class="p">;</span>
    <span class="k">protected</span> <span class="nv">$updatedField</span>  <span class="o">=</span> <span class="s1">&#39;updated_at&#39;</span><span class="p">;</span>
    <span class="k">protected</span> <span class="nv">$deletedField</span>  <span class="o">=</span> <span class="s1">&#39;deleted_at&#39;</span><span class="p">;</span>

    <span class="c1">// Validation</span>
    <span class="k">protected</span> <span class="nv">$validationRules</span>      <span class="o">=</span> <span class="p">[];</span>
    <span class="k">protected</span> <span class="nv">$validationMessages</span>   <span class="o">=</span> <span class="p">[];</span>
    <span class="k">protected</span> <span class="nv">$skipValidation</span>       <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
    <span class="k">protected</span> <span class="nv">$cleanValidationRules</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>

    <span class="c1">// Callbacks</span>
    <span class="k">protected</span> <span class="nv">$allowCallbacks</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
    <span class="k">protected</span> <span class="nv">$beforeInsert</span>   <span class="o">=</span> <span class="p">[];</span>
    <span class="k">protected</span> <span class="nv">$afterInsert</span>    <span class="o">=</span> <span class="p">[];</span>
    <span class="k">protected</span> <span class="nv">$beforeUpdate</span>   <span class="o">=</span> <span class="p">[];</span>
    <span class="k">protected</span> <span class="nv">$afterUpdate</span>    <span class="o">=</span> <span class="p">[];</span>
    <span class="k">protected</span> <span class="nv">$beforeFind</span>     <span class="o">=</span> <span class="p">[];</span>
    <span class="k">protected</span> <span class="nv">$afterFind</span>      <span class="o">=</span> <span class="p">[];</span>
    <span class="k">protected</span> <span class="nv">$beforeDelete</span>   <span class="o">=</span> <span class="p">[];</span>
    <span class="k">protected</span> <span class="nv">$afterDelete</span>    <span class="o">=</span> <span class="p">[];</span>
<span class="p">}</span>
</pre></div>
</div>
<section id="table">
<h4><a class="toc-backref" href="#id51" role="doc-backlink">$table</a><a class="headerlink" href="#table" title="此标题的永久链接"></a></h4>
<p>指定模型主要操作的数据表。仅适用于内置 CRUD 方法，自定义查询不受限制。</p>
</section>
<section id="primarykey">
<h4><a class="toc-backref" href="#id52" role="doc-backlink">$primaryKey</a><a class="headerlink" href="#primarykey" title="此标题的永久链接"></a></h4>
<p>指定表中唯一标识记录的列名。不必与数据库主键完全匹配，但需与 <code class="docutils literal notranslate"><span class="pre">find()</span></code> 等方法使用的匹配列一致。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>所有模型必须指定 primaryKey 以确保功能正常。</p>
</div>
</section>
<section id="useautoincrement">
<h4><a class="toc-backref" href="#id53" role="doc-backlink">$useAutoIncrement</a><a class="headerlink" href="#useautoincrement" title="此标题的永久链接"></a></h4>
<p>指定表是否对 <a class="reference internal" href="#primarykey">$primaryKey</a> 使用自增特性。设为 <code class="docutils literal notranslate"><span class="pre">false</span></code> 时需手动提供主键值，适用于 1:1 关系或 UUID 场景。默认值为 <code class="docutils literal notranslate"><span class="pre">true</span></code>。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>当 <a class="reference internal" href="#useautoincrement">$useAutoIncrement</a> 设为 <code class="docutils literal notranslate"><span class="pre">false</span></code> 时，请确保数据库主键设为 <code class="docutils literal notranslate"><span class="pre">unique</span></code>，以保证模型功能正常。</p>
</div>
</section>
<section id="returntype">
<h4><a class="toc-backref" href="#id54" role="doc-backlink">$returnType</a><a class="headerlink" href="#returntype" title="此标题的永久链接"></a></h4>
<p>模型的 <strong>find*()</strong> 方法将自动返回结果数据，而非 Result 对象。</p>
<p>此设置允许你定义返回的数据类型，有效值为 ‘<strong>array</strong>’（默认）、’<strong>object</strong>’ 或可与 Result 对象的 <code class="docutils literal notranslate"><span class="pre">getCustomResultObject()</span></code> 方法配合使用的 <strong>类的完全限定名称</strong>。</p>
<p>使用类的特殊 <code class="docutils literal notranslate"><span class="pre">::class</span></code> 常量，可使大多数 IDE 实现自动补全，并支持重构等功能以更好地理解你的代码。</p>
</section>
<section id="usesoftdeletes">
<span id="model-use-soft-deletes"></span><h4><a class="toc-backref" href="#id55" role="doc-backlink">$useSoftDeletes</a><a class="headerlink" href="#usesoftdeletes" title="此标题的永久链接"></a></h4>
<p>若设为 <code class="docutils literal notranslate"><span class="pre">true</span></code>，任何 <code class="docutils literal notranslate"><span class="pre">delete()</span></code> 方法调用都会在数据库中设置 <code class="docutils literal notranslate"><span class="pre">deleted_at</span></code> 字段值，而非实际删除行。这可以保留可能被其他位置引用的数据，维护可恢复对象的「回收站」，或简单地将其作为安全审计轨迹的一部分。当启用时，<strong>find*()</strong> 方法默认仅返回未删除行，除非在调用 <strong>find*()</strong> 方法前先调用 <code class="docutils literal notranslate"><span class="pre">withDeleted()</span></code> 方法。</p>
<p>根据模型的 <a class="reference internal" href="#dateformat">$dateFormat</a> 设置，数据库需要包含 DATETIME 或 INTEGER 类型的字段。默认字段名为 <code class="docutils literal notranslate"><span class="pre">deleted_at</span></code>，但可通过 <a class="reference internal" href="#deletedfield">$deletedField</a> 属性配置为任意名称。</p>
<div class="admonition important">
<p class="admonition-title">重要</p>
<p>数据库中的 <code class="docutils literal notranslate"><span class="pre">deleted_at</span></code> 字段必须可为空。</p>
</div>
</section>
<section id="allowedfields">
<span id="model-allowed-fields"></span><h4><a class="toc-backref" href="#id56" role="doc-backlink">$allowedFields</a><a class="headerlink" href="#allowedfields" title="此标题的永久链接"></a></h4>
<p>定义可通过 <code class="docutils literal notranslate"><span class="pre">save()</span></code>、<code class="docutils literal notranslate"><span class="pre">insert()</span></code> 或 <code class="docutils literal notranslate"><span class="pre">update()</span></code> 方法设置的字段名列表，防止大规模赋值漏洞。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p><a class="reference internal" href="#primarykey">$primaryKey</a> 字段不应包含在允许字段中。</p>
</div>
</section>
<section id="allowemptyinserts">
<h4><a class="toc-backref" href="#id57" role="doc-backlink">$allowEmptyInserts</a><a class="headerlink" href="#allowemptyinserts" title="此标题的永久链接"></a></h4>
<div class="versionadded">
<p><span class="versionmodified added">在 4.3.0 版本加入.</span></p>
</div>
<p>是否允许插入空数据。默认值是 <code class="docutils literal notranslate"><span class="pre">false</span></code>，这意味着如果你尝试插入空数据，将会抛出带有 “There is no data to insert.” 信息的 <code class="docutils literal notranslate"><span class="pre">DataException</span></code>。</p>
<p>你也可以通过 <a class="reference internal" href="#model-allow-empty-inserts"><span class="std std-ref">allowEmptyInserts()</span></a> 方法来改变这个设置。</p>
</section>
<section id="updateonlychanged">
<span id="model-update-only-changed"></span><h4><a class="toc-backref" href="#id58" role="doc-backlink">$updateOnlyChanged</a><a class="headerlink" href="#updateonlychanged" title="此标题的永久链接"></a></h4>
<div class="versionadded">
<p><span class="versionmodified added">在 4.5.0 版本加入.</span></p>
</div>
<p>是否仅更新 <a class="reference internal" href="entities.html"><span class="doc">Entity</span></a> 的已更改字段。默认值是 <code class="docutils literal notranslate"><span class="pre">true</span></code>，这意味着在更新到数据库时仅使用已更改的字段数据。因此，如果你尝试更新一个没有更改的 Entity，将会抛出带有 “There is no data to update.” 信息的 <code class="docutils literal notranslate"><span class="pre">DataException</span></code>。</p>
<p>将此属性设置为 <code class="docutils literal notranslate"><span class="pre">false</span></code> 将确保 Entity 的所有允许字段在任何时候都提交到数据库并进行更新。</p>
</section>
<section id="casts">
<h4><a class="toc-backref" href="#id59" role="doc-backlink">$casts</a><a class="headerlink" href="#casts" title="此标题的永久链接"></a></h4>
<div class="versionadded">
<p><span class="versionmodified added">在 4.5.0 版本加入.</span></p>
</div>
<p>该功能允许你将从数据库检索的数据转换为适当的 PHP 类型。此选项应为数组格式，其中键名对应字段名称，键值对应数据类型。详细信息请参阅 <a class="reference internal" href="#model-field-casting"><span class="std std-ref">模型字段类型转换</span></a>。</p>
</section>
<section id="id8">
<h4><a class="toc-backref" href="#id60" role="doc-backlink">日期配置</a><a class="headerlink" href="#id8" title="此标题的永久链接"></a></h4>
<section id="usetimestamps">
<h5>$useTimestamps<a class="headerlink" href="#usetimestamps" title="此标题的永久链接"></a></h5>
<p>这个布尔值决定了是否自动将当前日期添加到所有插入和更新操作中。如果为 <code class="docutils literal notranslate"><span class="pre">true</span></code>，将按照 <a class="reference internal" href="#dateformat">$dateFormat</a> 指定的格式设置当前时间。这要求表中存在适当数据类型的 <strong>created_at</strong>、<strong>updated_at</strong> 和 <strong>deleted_at</strong> 列。另请参阅 <a class="reference internal" href="#createdfield">$createdField</a>、<a class="reference internal" href="#updatedfield">$updatedField</a> 和 <a class="reference internal" href="#deletedfield">$deletedField</a>。</p>
</section>
<section id="dateformat">
<h5>$dateFormat<a class="headerlink" href="#dateformat" title="此标题的永久链接"></a></h5>
<p>该值配合 <a class="reference internal" href="#usetimestamps">$useTimestamps</a> 和 <a class="reference internal" href="#usesoftdeletes">$useSoftDeletes</a> 使用，确保正确类型的日期值被插入数据库。默认情况下会生成 DATETIME 值，但有效选项包括：<code class="docutils literal notranslate"><span class="pre">'datetime'</span></code>、<code class="docutils literal notranslate"><span class="pre">'date'</span></code> 或 <code class="docutils literal notranslate"><span class="pre">'int'</span></code> （UNIX 时间戳）。如果与无效或缺失的 <a class="reference internal" href="#dateformat">$dateFormat</a> 一起使用 <a class="reference internal" href="#usesoftdeletes">$useSoftDeletes</a> 或 <a class="reference internal" href="#usetimestamps">$useTimestamps</a> 将会引发异常。</p>
</section>
<section id="createdfield">
<h5>$createdField<a class="headerlink" href="#createdfield" title="此标题的永久链接"></a></h5>
<p>指定用于记录数据创建时间戳的数据库字段。设置为空字符串 (<code class="docutils literal notranslate"><span class="pre">''</span></code>) 可避免更新该字段（即使启用了 <a class="reference internal" href="#usetimestamps">$useTimestamps</a>）。</p>
</section>
<section id="updatedfield">
<h5>$updatedField<a class="headerlink" href="#updatedfield" title="此标题的永久链接"></a></h5>
<p>指定用于记录数据更新时间戳的数据库字段。设置为空字符串 (<code class="docutils literal notranslate"><span class="pre">''</span></code>) 可避免更新该字段（即使启用了 <a class="reference internal" href="#usetimestamps">$useTimestamps</a>）。</p>
</section>
<section id="deletedfield">
<h5>$deletedField<a class="headerlink" href="#deletedfield" title="此标题的永久链接"></a></h5>
<p>指定用于软删除操作的数据库字段。详见 <a class="reference internal" href="#model-use-soft-deletes"><span class="std std-ref">$useSoftDeletes</span></a>。</p>
</section>
</section>
<section id="id9">
<h4><a class="toc-backref" href="#id61" role="doc-backlink">验证</a><a class="headerlink" href="#id9" title="此标题的永久链接"></a></h4>
<section id="validationrules">
<h5>$validationRules<a class="headerlink" href="#validationrules" title="此标题的永久链接"></a></h5>
<p>包含一个验证规则数组（如 <a class="reference internal" href="../libraries/validation.html#validation-array"><span class="std std-ref">如何保存规则</span></a> 所述）或一个验证组名称的字符串（如相同章节所述）。另请参阅 <a class="reference internal" href="#model-setting-validation-rules"><span class="std std-ref">设置验证规则</span></a>。</p>
</section>
<section id="validationmessages">
<h5>$validationMessages<a class="headerlink" href="#validationmessages" title="此标题的永久链接"></a></h5>
<p>包含一个自定义错误消息数组，用于验证过程中（如 <a class="reference internal" href="../libraries/validation.html#validation-custom-errors"><span class="std std-ref">设置自定义错误信息</span></a> 所述）。另请参阅 <a class="reference internal" href="#model-setting-validation-rules"><span class="std std-ref">设置验证规则</span></a>。</p>
</section>
<section id="skipvalidation">
<h5>$skipValidation<a class="headerlink" href="#skipvalidation" title="此标题的永久链接"></a></h5>
<p>是否在所有 <strong>插入</strong> 和 <strong>更新</strong> 操作中跳过验证。默认值为 <code class="docutils literal notranslate"><span class="pre">false</span></code>，表示始终尝试验证数据。这主要由 <code class="docutils literal notranslate"><span class="pre">skipValidation()</span></code> 方法使用，但可更改为 <code class="docutils literal notranslate"><span class="pre">true</span></code> 以使模型永不验证。</p>
</section>
<section id="cleanvalidationrules">
<span id="clean-validation-rules"></span><h5>$cleanValidationRules<a class="headerlink" href="#cleanvalidationrules" title="此标题的永久链接"></a></h5>
<p>是否移除传入数据中不存在的验证规则。这用于 <strong>更新</strong> 操作。默认值为 <code class="docutils literal notranslate"><span class="pre">true</span></code>，表示在验证前会（临时）移除传入数据中不存在字段的验证规则，以避免在仅更新部分字段时出现验证错误。</p>
<p>也可以通过 <code class="docutils literal notranslate"><span class="pre">cleanRules()</span></code> 方法更改此值。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>在 v4.2.7 之前，由于存在 bug，<code class="docutils literal notranslate"><span class="pre">$cleanValidationRules</span></code> 无法正常工作。</p>
</div>
</section>
</section>
<section id="id10">
<h4><a class="toc-backref" href="#id62" role="doc-backlink">回调</a><a class="headerlink" href="#id10" title="此标题的永久链接"></a></h4>
<section id="allowcallbacks">
<h5>$allowCallbacks<a class="headerlink" href="#allowcallbacks" title="此标题的永久链接"></a></h5>
<p>是否使用下面定义的回调。详见 <a class="reference internal" href="#model-events"><span class="std std-ref">模型事件</span></a>。</p>
</section>
<section id="beforeinsert">
<h5>$beforeInsert<a class="headerlink" href="#beforeinsert" title="此标题的永久链接"></a></h5>
</section>
<section id="afterinsert">
<h5>$afterInsert<a class="headerlink" href="#afterinsert" title="此标题的永久链接"></a></h5>
</section>
<section id="beforeupdate">
<h5>$beforeUpdate<a class="headerlink" href="#beforeupdate" title="此标题的永久链接"></a></h5>
</section>
<section id="afterupdate">
<h5>$afterUpdate<a class="headerlink" href="#afterupdate" title="此标题的永久链接"></a></h5>
</section>
<section id="beforefind">
<h5>$beforeFind<a class="headerlink" href="#beforefind" title="此标题的永久链接"></a></h5>
</section>
<section id="afterfind">
<h5>$afterFind<a class="headerlink" href="#afterfind" title="此标题的永久链接"></a></h5>
</section>
<section id="beforedelete">
<h5>$beforeDelete<a class="headerlink" href="#beforedelete" title="此标题的永久链接"></a></h5>
</section>
<section id="afterdelete">
<h5>$afterDelete<a class="headerlink" href="#afterdelete" title="此标题的永久链接"></a></h5>
</section>
<section id="beforeinsertbatch">
<h5>$beforeInsertBatch<a class="headerlink" href="#beforeinsertbatch" title="此标题的永久链接"></a></h5>
</section>
<section id="afterinsertbatch">
<h5>$afterInsertBatch<a class="headerlink" href="#afterinsertbatch" title="此标题的永久链接"></a></h5>
</section>
<section id="beforeupdatebatch">
<h5>$beforeUpdateBatch<a class="headerlink" href="#beforeupdatebatch" title="此标题的永久链接"></a></h5>
</section>
<section id="afterupdatebatch">
<h5>$afterUpdateBatch<a class="headerlink" href="#afterupdatebatch" title="此标题的永久链接"></a></h5>
<p>这些数组允许你指定在属性名指定时间点运行的回调方法。详见 <a class="reference internal" href="#model-events"><span class="std std-ref">模型事件</span></a>。</p>
</section>
</section>
</section>
</section>
<section id="model-field-casting">
<span id="id11"></span><h2><a class="toc-backref" href="#id63" role="doc-backlink">模型字段类型转换</a><a class="headerlink" href="#model-field-casting" title="此标题的永久链接"></a></h2>
<div class="versionadded">
<p><span class="versionmodified added">在 4.5.0 版本加入.</span></p>
</div>
<p>从数据库检索数据时，整数类型的数据可能在 PHP 中被转换为字符串类型。你可能希望将日期/时间数据转换为 PHP 的 Time 对象。</p>
<p>模型字段类型转换允许你将从数据库检索的数据转换为适当的 PHP 类型。</p>
<div class="admonition important">
<p class="admonition-title">重要</p>
<p>如果将此功能与 <a class="reference internal" href="entities.html"><span class="doc">实体</span></a> 一起使用，请勿同时使用 <a class="reference internal" href="entities.html#entities-property-casting"><span class="std std-ref">实体属性类型转换</span></a>。同时使用两种类型转换将无法正常工作。</p>
<p>实体属性类型转换作用于 (1)(4)，而此类型转换作用于 (2)(3):</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="nx">应用代码</span><span class="p">]</span> <span class="o">---</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">--&gt;</span> <span class="p">[</span><span class="nx">实体</span><span class="p">]</span> <span class="o">---</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">--&gt;</span> <span class="p">[</span><span class="nx">数据库</span><span class="p">]</span>
<span class="p">[</span><span class="nx">应用代码</span><span class="p">]</span> <span class="o">&lt;--</span> <span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">---</span> <span class="p">[</span><span class="nx">实体</span><span class="p">]</span> <span class="o">&lt;--</span> <span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">---</span> <span class="p">[</span><span class="nx">数据库</span><span class="p">]</span>
</pre></div>
</div>
<p>使用此类型转换时，实体将在属性中持有正确类型的 PHP 值。此行为与之前的行为完全不同。不要期望属性持有数据库的原始数据。</p>
</div>
<section id="id12">
<h3><a class="toc-backref" href="#id64" role="doc-backlink">定义数据类型</a><a class="headerlink" href="#id12" title="此标题的永久链接"></a></h3>
<p><code class="docutils literal notranslate"><span class="pre">$casts</span></code> 属性设置其定义。此选项应为数组，其中键是字段名称，值是数据类型：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">namespace</span> <span class="nx">App\Models</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">CodeIgniter\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">UserModel</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="k">protected</span> <span class="k">array</span> <span class="nv">$casts</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;id&#39;</span>        <span class="o">=&gt;</span> <span class="s1">&#39;int&#39;</span><span class="p">,</span>
        <span class="s1">&#39;birthdate&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;?datetime&#39;</span><span class="p">,</span>
        <span class="s1">&#39;hobbies&#39;</span>   <span class="o">=&gt;</span> <span class="s1">&#39;json-array&#39;</span><span class="p">,</span>
        <span class="s1">&#39;active&#39;</span>    <span class="o">=&gt;</span> <span class="s1">&#39;int-bool&#39;</span><span class="p">,</span>
    <span class="p">];</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="id13">
<h3><a class="toc-backref" href="#id65" role="doc-backlink">数据类型</a><a class="headerlink" href="#id13" title="此标题的永久链接"></a></h3>
<p>默认提供以下类型。在类型前添加问号可将字段标记为可空，例如 <code class="docutils literal notranslate"><span class="pre">?int</span></code>、<code class="docutils literal notranslate"><span class="pre">?datetime</span></code>。</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>类型</p></th>
<th class="head"><p>PHP 类型</p></th>
<th class="head"><p>数据库字段类型</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">int</span></code></p></td>
<td><p>int</p></td>
<td><p>int 类型</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">float</span></code></p></td>
<td><p>float</p></td>
<td><p>float（数值）类型</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">bool</span></code></p></td>
<td><p>bool</p></td>
<td><p>bool/int/string 类型</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">int-bool</span></code></p></td>
<td><p>bool</p></td>
<td><p>int 类型（1 或 0）</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">array</span></code></p></td>
<td><p>array</p></td>
<td><p>string 类型（序列化）</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">csv</span></code></p></td>
<td><p>array</p></td>
<td><p>string 类型（CSV）</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">json</span></code></p></td>
<td><p>stdClass</p></td>
<td><p>json/string 类型</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">json-array</span></code></p></td>
<td><p>array</p></td>
<td><p>json/string 类型</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">datetime</span></code></p></td>
<td><p>Time</p></td>
<td><p>datetime 类型</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">timestamp</span></code></p></td>
<td><p>Time</p></td>
<td><p>int 类型（UNIX 时间戳）</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">uri</span></code></p></td>
<td><p>URI</p></td>
<td><p>string 类型</p></td>
</tr>
</tbody>
</table>
<section id="csv">
<h4><a class="toc-backref" href="#id66" role="doc-backlink">csv</a><a class="headerlink" href="#csv" title="此标题的永久链接"></a></h4>
<p>使用 <code class="docutils literal notranslate"><span class="pre">csv</span></code> 类型转换时，使用 PHP 内置的 <code class="docutils literal notranslate"><span class="pre">implode()</span></code> 和 <code class="docutils literal notranslate"><span class="pre">explode()</span></code> 函数，并假定所有值都是字符串安全且不含逗号。对于更复杂的数据转换，请尝试 <code class="docutils literal notranslate"><span class="pre">array</span></code> 或 <code class="docutils literal notranslate"><span class="pre">json</span></code>。</p>
</section>
<section id="datetime">
<h4><a class="toc-backref" href="#id67" role="doc-backlink">datetime</a><a class="headerlink" href="#datetime" title="此标题的永久链接"></a></h4>
<p>你可以传递类似 <code class="docutils literal notranslate"><span class="pre">datetime[ms]</span></code> 的参数表示带毫秒的日期/时间，或 <code class="docutils literal notranslate"><span class="pre">datetime[us]</span></code> 表示带微秒的日期/时间。</p>
<p>日期时间格式在 <a class="reference internal" href="../database/configuration.html#database-config-explanation-of-values"><span class="std std-ref">数据库配置</span></a> 的 <code class="docutils literal notranslate"><span class="pre">dateFormat</span></code> 数组中设置，位于 <strong>app/Config/Database.php</strong> 文件。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>当使用 <code class="docutils literal notranslate"><span class="pre">ms</span></code> 或 <code class="docutils literal notranslate"><span class="pre">us</span></code> 作为参数时，<strong>模型</strong> 会处理 Time 的秒的小数部分。但 <strong>查询构建器</strong> 不会。因此在将 Time 传递给查询构建器的方法（如 <code class="docutils literal notranslate"><span class="pre">where()</span></code>）时，仍需使用 <code class="docutils literal notranslate"><span class="pre">format()</span></code> 方法：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="nv">$model</span> <span class="o">=</span> <span class="nx">model</span><span class="p">(</span><span class="s1">&#39;SomeModel&#39;</span><span class="p">);</span>

<span class="nv">$now</span> <span class="o">=</span> <span class="nx">\CodeIgniter\I18n\Time</span><span class="o">::</span><span class="na">now</span><span class="p">();</span>

<span class="c1">// The following code passes the microseconds to Query Builder.</span>
<span class="nv">$model</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;my_dt_field&#39;</span><span class="p">,</span> <span class="nv">$now</span><span class="o">-&gt;</span><span class="na">format</span><span class="p">(</span><span class="s1">&#39;Y-m-d H:i:s.u&#39;</span><span class="p">))</span><span class="o">-&gt;</span><span class="na">findAll</span><span class="p">();</span>
<span class="c1">// Generates: SELECT * FROM `my_table` WHERE `my_dt_field` = &#39;2024-07-28 18:57:58.900326&#39;</span>

<span class="c1">// But the following code loses the microseconds.</span>
<span class="nv">$model</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;my_dt_field&#39;</span><span class="p">,</span> <span class="nv">$now</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">findAll</span><span class="p">();</span>
<span class="c1">// Generates: SELECT * FROM `my_table` WHERE `my_dt_field` = &#39;2024-07-28 18:57:58&#39;</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>在 v4.6.0 之前，由于存在 bug，无法使用 <code class="docutils literal notranslate"><span class="pre">ms</span></code> 或 <code class="docutils literal notranslate"><span class="pre">us</span></code> 作为参数，因为 Time 的秒的小数部分会丢失。</p>
</div>
</section>
<section id="timestamp">
<h4><a class="toc-backref" href="#id68" role="doc-backlink">timestamp</a><a class="headerlink" href="#timestamp" title="此标题的永久链接"></a></h4>
<p>创建的 <code class="docutils literal notranslate"><span class="pre">Time</span></code> 实例的时区将是默认时区（应用的时区），而非 UTC。</p>
</section>
</section>
<section id="id14">
<h3><a class="toc-backref" href="#id69" role="doc-backlink">自定义类型转换</a><a class="headerlink" href="#id14" title="此标题的永久链接"></a></h3>
<p>你可以定义自己的转换类型。</p>
<section id="id15">
<h4><a class="toc-backref" href="#id70" role="doc-backlink">创建自定义处理器</a><a class="headerlink" href="#id15" title="此标题的永久链接"></a></h4>
<p>首先需要为你的类型创建一个处理器类。假设类位于 <strong>app/Models/Cast</strong> 目录：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">namespace</span> <span class="nx">App\Models\Cast</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">CodeIgniter\DataCaster\Cast\BaseCast</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">InvalidArgumentException</span><span class="p">;</span>

<span class="c1">// The class must inherit the CodeIgniter\DataCaster\Cast\BaseCast class</span>
<span class="k">class</span> <span class="nc">CastBase64</span> <span class="k">extends</span> <span class="nx">BaseCast</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">get</span><span class="p">(</span>
        <span class="nx">mixed</span> <span class="nv">$value</span><span class="p">,</span>
        <span class="k">array</span> <span class="nv">$params</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="o">?</span><span class="nx">object</span> <span class="nv">$helper</span> <span class="o">=</span> <span class="k">null</span><span class="p">,</span>
    <span class="p">)</span><span class="o">:</span> <span class="nx">string</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nb">is_string</span><span class="p">(</span><span class="nv">$value</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">self</span><span class="o">::</span><span class="na">invalidTypeValueError</span><span class="p">(</span><span class="nv">$value</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nv">$decoded</span> <span class="o">=</span> <span class="nb">base64_decode</span><span class="p">(</span><span class="nv">$value</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nv">$decoded</span> <span class="o">===</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">InvalidArgumentException</span><span class="p">(</span><span class="s1">&#39;Cannot decode: &#39;</span> <span class="o">.</span> <span class="nv">$value</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nv">$decoded</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">set</span><span class="p">(</span>
        <span class="nx">mixed</span> <span class="nv">$value</span><span class="p">,</span>
        <span class="k">array</span> <span class="nv">$params</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="o">?</span><span class="nx">object</span> <span class="nv">$helper</span> <span class="o">=</span> <span class="k">null</span><span class="p">,</span>
    <span class="p">)</span><span class="o">:</span> <span class="nx">string</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nb">is_string</span><span class="p">(</span><span class="nv">$value</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">self</span><span class="o">::</span><span class="na">invalidTypeValueError</span><span class="p">(</span><span class="nv">$value</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nb">base64_encode</span><span class="p">(</span><span class="nv">$value</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>如果不需要在获取或设置值时更改值，只需不实现相应方法：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">namespace</span> <span class="nx">App\Models\Cast</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">CodeIgniter\DataCaster\Cast\BaseCast</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">InvalidArgumentException</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">CastBase64</span> <span class="k">extends</span> <span class="nx">BaseCast</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">get</span><span class="p">(</span>
        <span class="nx">mixed</span> <span class="nv">$value</span><span class="p">,</span>
        <span class="k">array</span> <span class="nv">$params</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="o">?</span><span class="nx">object</span> <span class="nv">$helper</span> <span class="o">=</span> <span class="k">null</span><span class="p">,</span>
    <span class="p">)</span><span class="o">:</span> <span class="nx">string</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nb">is_string</span><span class="p">(</span><span class="nv">$value</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">self</span><span class="o">::</span><span class="na">invalidTypeValueError</span><span class="p">(</span><span class="nv">$value</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nv">$decoded</span> <span class="o">=</span> <span class="nb">base64_decode</span><span class="p">(</span><span class="nv">$value</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nv">$decoded</span> <span class="o">===</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">InvalidArgumentException</span><span class="p">(</span><span class="s1">&#39;Cannot decode: &#39;</span> <span class="o">.</span> <span class="nv">$value</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nv">$decoded</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="id16">
<h4><a class="toc-backref" href="#id71" role="doc-backlink">注册自定义处理器</a><a class="headerlink" href="#id16" title="此标题的永久链接"></a></h4>
<p>现在需要注册它：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">namespace</span> <span class="nx">App\Models</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">App\Models\Cast\CastBase64</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">CodeIgniter\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">MyModel</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="c1">// ...</span>

    <span class="c1">// Specify the type for the field</span>
    <span class="k">protected</span> <span class="k">array</span> <span class="nv">$casts</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;column1&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;base64&#39;</span><span class="p">,</span>
    <span class="p">];</span>

    <span class="c1">// Bind the type to the handler</span>
    <span class="k">protected</span> <span class="k">array</span> <span class="nv">$castHandlers</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;base64&#39;</span> <span class="o">=&gt;</span> <span class="nx">CastBase64</span><span class="o">::</span><span class="na">class</span><span class="p">,</span>
    <span class="p">];</span>

    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="id17">
<h4><a class="toc-backref" href="#id72" role="doc-backlink">参数</a><a class="headerlink" href="#id17" title="此标题的永久链接"></a></h4>
<p>在某些情况下，单一类型可能不够。此时可以使用附加参数。附加参数用方括号表示，并用逗号分隔，例如 <code class="docutils literal notranslate"><span class="pre">type[param1,</span> <span class="pre">param2]</span></code>。</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">namespace</span> <span class="nx">App\Models</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">App\Models\Cast\SomeHandler</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">CodeIgniter\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">MyModel</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="c1">// ...</span>

    <span class="c1">// Define a type with parameters</span>
    <span class="k">protected</span> <span class="k">array</span> <span class="nv">$casts</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;column1&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;class[App\SomeClass, param2, param3]&#39;</span><span class="p">,</span>
    <span class="p">];</span>

    <span class="c1">// Bind the type to the handler</span>
    <span class="k">protected</span> <span class="k">array</span> <span class="nv">$castHandlers</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;class&#39;</span> <span class="o">=&gt;</span> <span class="nx">SomeHandler</span><span class="o">::</span><span class="na">class</span><span class="p">,</span>
    <span class="p">];</span>

    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">namespace</span> <span class="nx">App\Models\Cast</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">CodeIgniter\DataCaster\Cast\BaseCast</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">SomeHandler</span> <span class="k">extends</span> <span class="nx">BaseCast</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">get</span><span class="p">(</span>
        <span class="nx">mixed</span> <span class="nv">$value</span><span class="p">,</span>
        <span class="k">array</span> <span class="nv">$params</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="o">?</span><span class="nx">object</span> <span class="nv">$helper</span> <span class="o">=</span> <span class="k">null</span><span class="p">,</span>
    <span class="p">)</span><span class="o">:</span> <span class="nx">mixed</span> <span class="p">{</span>
        <span class="nb">var_dump</span><span class="p">(</span><span class="nv">$params</span><span class="p">);</span>
        <span class="cm">/*</span>
<span class="cm">         * Output:</span>
<span class="cm">         * array(3) {</span>
<span class="cm">         *   [0]=&gt;</span>
<span class="cm">         *   string(13) &quot;App\SomeClass&quot;</span>
<span class="cm">         *   [1]=&gt;</span>
<span class="cm">         *   string(6) &quot;param2&quot;</span>
<span class="cm">         *   [2]=&gt;</span>
<span class="cm">         *   string(6) &quot;param3&quot;</span>
<span class="cm">         * }</span>
<span class="cm">         */</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>如果类型标记为可空（如 <code class="docutils literal notranslate"><span class="pre">?bool</span></code>）且传递的值不为 null，则会将带有 <code class="docutils literal notranslate"><span class="pre">nullable</span></code> 值的参数传递给类型转换处理器。如果类型转换已有预定义参数，则 <code class="docutils literal notranslate"><span class="pre">nullable</span></code> 将添加到列表末尾。</p>
</div>
</section>
</section>
</section>
<section id="id18">
<h2><a class="toc-backref" href="#id73" role="doc-backlink">处理数据</a><a class="headerlink" href="#id18" title="此标题的永久链接"></a></h2>
<section id="id19">
<h3><a class="toc-backref" href="#id74" role="doc-backlink">查找数据</a><a class="headerlink" href="#id19" title="此标题的永久链接"></a></h3>
<p>提供了多个函数用于对表执行基本的 CRUD 操作，包括 <code class="docutils literal notranslate"><span class="pre">find()</span></code>、<code class="docutils literal notranslate"><span class="pre">insert()</span></code>、<code class="docutils literal notranslate"><span class="pre">update()</span></code>、<code class="docutils literal notranslate"><span class="pre">delete()</span></code> 等。</p>
<section id="find">
<h4><a class="toc-backref" href="#id75" role="doc-backlink">find()</a><a class="headerlink" href="#find" title="此标题的永久链接"></a></h4>
<p>返回主键与第一个参数匹配的单行数据：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="nv">$user</span> <span class="o">=</span> <span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="nv">$userId</span><span class="p">);</span>
</pre></div>
</div>
<p>返回值格式由 <a class="reference internal" href="#returntype">$returnType</a> 指定。</p>
<p>通过传递主键值数组（而非单个值）可返回多行数据：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="nv">$users</span> <span class="o">=</span> <span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]);</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>如果不传递参数，<code class="docutils literal notranslate"><span class="pre">find()</span></code> 将返回模型表中的所有行，实际上等同于 <code class="docutils literal notranslate"><span class="pre">findAll()</span></code>，但不够明确。</p>
</div>
</section>
<section id="findcolumn">
<h4><a class="toc-backref" href="#id76" role="doc-backlink">findColumn()</a><a class="headerlink" href="#findcolumn" title="此标题的永久链接"></a></h4>
<p>返回 null 或列值的索引数组：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="nv">$user</span> <span class="o">=</span> <span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">findColumn</span><span class="p">(</span><span class="nv">$columnName</span><span class="p">);</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">$column_name</span></code> 应为单个字段名，否则将抛出 <code class="docutils literal notranslate"><span class="pre">DataException</span></code>。</p>
</section>
<section id="findall">
<h4><a class="toc-backref" href="#id77" role="doc-backlink">findAll()</a><a class="headerlink" href="#findall" title="此标题的永久链接"></a></h4>
<p>返回所有结果：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="nv">$users</span> <span class="o">=</span> <span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">findAll</span><span class="p">();</span>
</pre></div>
</div>
<p>可在调用此方法前插入查询构建器命令来修改查询：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="nv">$users</span> <span class="o">=</span> <span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;active&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">findAll</span><span class="p">();</span>
</pre></div>
</div>
<p>可分别传递限制和偏移值作为第一和第二个参数：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="nv">$users</span> <span class="o">=</span> <span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">findAll</span><span class="p">(</span><span class="nv">$limit</span><span class="p">,</span> <span class="nv">$offset</span><span class="p">);</span>
</pre></div>
</div>
</section>
<section id="first">
<h4><a class="toc-backref" href="#id78" role="doc-backlink">first()</a><a class="headerlink" href="#first" title="此标题的永久链接"></a></h4>
<p>返回结果集中的第一行。最好与查询构建器结合使用。</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="nv">$user</span> <span class="o">=</span> <span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;deleted&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">first</span><span class="p">();</span>
</pre></div>
</div>
</section>
<section id="withdeleted">
<h4><a class="toc-backref" href="#id79" role="doc-backlink">withDeleted()</a><a class="headerlink" href="#withdeleted" title="此标题的永久链接"></a></h4>
<p>如果 <a class="reference internal" href="#usesoftdeletes">$useSoftDeletes</a> 为 true，则 <strong>find*()</strong> 方法不会返回 <code class="docutils literal notranslate"><span class="pre">deleted_at</span> <span class="pre">IS</span> <span class="pre">NOT</span> <span class="pre">NULL</span></code> 的行。要临时覆盖此行为，可在调用 <strong>find*()</strong> 方法前使用 <code class="docutils literal notranslate"><span class="pre">withDeleted()</span></code> 方法。</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="c1">// Only gets non-deleted rows (deleted = 0)</span>
<span class="nv">$activeUsers</span> <span class="o">=</span> <span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">findAll</span><span class="p">();</span>

<span class="c1">// Gets all rows</span>
<span class="nv">$allUsers</span> <span class="o">=</span> <span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">withDeleted</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">findAll</span><span class="p">();</span>
</pre></div>
</div>
</section>
<section id="onlydeleted">
<h4><a class="toc-backref" href="#id80" role="doc-backlink">onlyDeleted()</a><a class="headerlink" href="#onlydeleted" title="此标题的永久链接"></a></h4>
<p><code class="docutils literal notranslate"><span class="pre">withDeleted()</span></code> 会返回已删除和未删除的行，而此方法会修改后续的 <strong>find*()</strong> 方法仅返回软删除的行：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="nv">$deletedUsers</span> <span class="o">=</span> <span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">onlyDeleted</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">findAll</span><span class="p">();</span>
</pre></div>
</div>
</section>
</section>
<section id="id20">
<h3><a class="toc-backref" href="#id81" role="doc-backlink">保存数据</a><a class="headerlink" href="#id20" title="此标题的永久链接"></a></h3>
<section id="insert">
<h4><a class="toc-backref" href="#id82" role="doc-backlink">insert()</a><a class="headerlink" href="#insert" title="此标题的永久链接"></a></h4>
<p>第一个参数是关联数组，用于在数据库中创建新行数据。如果传递对象而非数组，将尝试将其转换为数组。</p>
<p>数组的键必须与 <a class="reference internal" href="#table">$table</a> 中的列名匹配，数组的值是要保存的值。</p>
<p>可选的第二个参数为布尔类型，若设为 false，方法将返回布尔值表示查询成功与否。</p>
<p>可使用 <code class="docutils literal notranslate"><span class="pre">getInsertID()</span></code> 方法获取最后插入行的主键。</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="nv">$data</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;username&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;darth&#39;</span><span class="p">,</span>
    <span class="s1">&#39;email&#39;</span>    <span class="o">=&gt;</span> <span class="s1">&#39;d.vader@theempire.com&#39;</span><span class="p">,</span>
<span class="p">];</span>

<span class="c1">// Inserts data and returns inserted row&#39;s primary key</span>
<span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">insert</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>

<span class="c1">// Inserts data and returns true on success and false on failure</span>
<span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">insert</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span>

<span class="c1">// Returns inserted row&#39;s primary key</span>
<span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">getInsertID</span><span class="p">();</span>
</pre></div>
</div>
</section>
<section id="model-allow-empty-inserts">
<span id="id21"></span><h4><a class="toc-backref" href="#id83" role="doc-backlink">allowEmptyInserts()</a><a class="headerlink" href="#model-allow-empty-inserts" title="此标题的永久链接"></a></h4>
<div class="versionadded">
<p><span class="versionmodified added">在 4.3.0 版本加入.</span></p>
</div>
<p>可使用 <code class="docutils literal notranslate"><span class="pre">allowEmptyInserts()</span></code> 方法插入空数据。默认情况下，模型在尝试插入空数据时会抛出异常。但调用此方法后，将不再执行检查。</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">allowEmptyInserts</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">insert</span><span class="p">([]);</span>
</pre></div>
</div>
<p>也可通过 <a class="reference internal" href="#allowemptyinserts">$allowEmptyInserts</a> 属性更改此设置。</p>
<p>通过调用 <code class="docutils literal notranslate"><span class="pre">allowEmptyInserts(false)</span></code> 可重新启用检查。</p>
</section>
<section id="update">
<h4><a class="toc-backref" href="#id84" role="doc-backlink">update()</a><a class="headerlink" href="#update" title="此标题的永久链接"></a></h4>
<p>更新数据库中的现有记录。第一个参数是要更新记录的 <a class="reference internal" href="#primarykey">$primaryKey</a>。第二个参数是包含数据的关联数组。数组的键必须与 <a class="reference internal" href="#table">$table</a> 中的列名匹配，数组的值则是要保存的对应值：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="nv">$data</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;username&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;darth&#39;</span><span class="p">,</span>
    <span class="s1">&#39;email&#39;</span>    <span class="o">=&gt;</span> <span class="s1">&#39;d.vader@theempire.com&#39;</span><span class="p">,</span>
<span class="p">];</span>

<span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">update</span><span class="p">(</span><span class="nv">$id</span><span class="p">,</span> <span class="nv">$data</span><span class="p">);</span>
</pre></div>
</div>
<div class="admonition important">
<p class="admonition-title">重要</p>
<p>自 v4.3.0 起，如果生成的 SQL 语句没有 WHERE 子句，此方法会抛出 <code class="docutils literal notranslate"><span class="pre">DatabaseException</span></code>。在早期版本中，如果调用时未指定 <a class="reference internal" href="#primarykey">$primaryKey</a> 且生成的 SQL 语句没有 WHERE 子句，查询仍会执行并更新表中的所有记录。</p>
</div>
<p>通过将主键数组作为第一个参数传递，可以在一次调用中更新多条记录：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="nv">$data</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;active&#39;</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">];</span>

<span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">update</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="nv">$data</span><span class="p">);</span>
</pre></div>
</div>
<p>当需要更灵活的解决方案时，可以留空参数，此时其功能类似于查询构建器的 update 命令，并额外具备验证、事件等优势：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="nv">$userModel</span>
    <span class="o">-&gt;</span><span class="na">whereIn</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
    <span class="o">-&gt;</span><span class="na">set</span><span class="p">([</span><span class="s1">&#39;active&#39;</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">])</span>
    <span class="o">-&gt;</span><span class="na">update</span><span class="p">();</span>
</pre></div>
</div>
</section>
<section id="save">
<span id="model-save"></span><h4><a class="toc-backref" href="#id85" role="doc-backlink">save()</a><a class="headerlink" href="#save" title="此标题的永久链接"></a></h4>
<p>这是对 <code class="docutils literal notranslate"><span class="pre">insert()</span></code> 和 <code class="docutils literal notranslate"><span class="pre">update()</span></code> 方法的封装，根据是否找到匹配 <strong>主键</strong> 值的数组键来自动处理记录的插入或更新：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="c1">// Defined as a model property</span>
<span class="nv">$primaryKey</span> <span class="o">=</span> <span class="s1">&#39;id&#39;</span><span class="p">;</span>

<span class="c1">// Does an insert()</span>
<span class="nv">$data</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;username&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;darth&#39;</span><span class="p">,</span>
    <span class="s1">&#39;email&#39;</span>    <span class="o">=&gt;</span> <span class="s1">&#39;d.vader@theempire.com&#39;</span><span class="p">,</span>
<span class="p">];</span>

<span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>

<span class="c1">// Performs an update, since the primary key, &#39;id&#39;, is found.</span>
<span class="nv">$data</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;id&#39;</span>       <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span>
    <span class="s1">&#39;username&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;darth&#39;</span><span class="p">,</span>
    <span class="s1">&#39;email&#39;</span>    <span class="o">=&gt;</span> <span class="s1">&#39;d.vader@theempire.com&#39;</span><span class="p">,</span>
<span class="p">];</span>
<span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>
</pre></div>
</div>
<p>save 方法还能通过识别非简单对象并将其公共和受保护值提取到数组，简化与自定义类结果对象的交互。这使得你可以非常简洁地使用实体类。实体类是表示单个对象类型实例的简单类（如用户、博客文章、任务等），负责维护围绕对象本身的业务逻辑（如特定格式的元素处理等），不应了解如何保存到数据库。最简单的实体类可能如下所示：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">namespace</span> <span class="nx">App\Entities</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Job</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="nv">$id</span><span class="p">;</span>
    <span class="k">protected</span> <span class="nv">$name</span><span class="p">;</span>
    <span class="k">protected</span> <span class="nv">$description</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__get</span><span class="p">(</span><span class="nv">$key</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">property_exists</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="nv">$key</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$key</span><span class="p">};</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__set</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="nv">$value</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">property_exists</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="nv">$key</span><span class="p">))</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$key</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$value</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>与之配合的简单模型可能如下：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">namespace</span> <span class="nx">App\Models</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">CodeIgniter\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">JobModel</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="nv">$table</span>         <span class="o">=</span> <span class="s1">&#39;jobs&#39;</span><span class="p">;</span>
    <span class="k">protected</span> <span class="nv">$returnType</span>    <span class="o">=</span> <span class="nx">\App\Entities\Job</span><span class="o">::</span><span class="na">class</span><span class="p">;</span>
    <span class="k">protected</span> <span class="nv">$allowedFields</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">,</span>
    <span class="p">];</span>
<span class="p">}</span>
</pre></div>
</div>
<p>此模型处理来自 <code class="docutils literal notranslate"><span class="pre">jobs</span></code> 表的数据，并将所有结果作为 <code class="docutils literal notranslate"><span class="pre">App\Entities\Job</span></code> 实例返回。当需要将记录持久化到数据库时，你可以编写自定义方法，或使用模型的 <code class="docutils literal notranslate"><span class="pre">save()</span></code> 方法来检查类、提取公共和私有属性并保存到数据库：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="c1">// Retrieve a Job instance</span>
<span class="nv">$job</span> <span class="o">=</span> <span class="nv">$model</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="mi">15</span><span class="p">);</span>

<span class="c1">// Make some changes</span>
<span class="nv">$job</span><span class="o">-&gt;</span><span class="na">name</span> <span class="o">=</span> <span class="s1">&#39;Foobar&#39;</span><span class="p">;</span>

<span class="c1">// Save the changes</span>
<span class="nv">$model</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">(</span><span class="nv">$job</span><span class="p">);</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>如果你需要频繁使用实体类，CodeIgniter 提供了内置的 <a class="reference internal" href="entities.html"><span class="doc">实体类</span></a>，其中包含多个便捷功能可简化实体开发。</p>
</div>
</section>
<section id="model-saving-dates">
<span id="id22"></span><h4><a class="toc-backref" href="#id86" role="doc-backlink">保存日期</a><a class="headerlink" href="#model-saving-dates" title="此标题的永久链接"></a></h4>
<div class="versionadded">
<p><span class="versionmodified added">在 4.5.0 版本加入.</span></p>
</div>
<p>保存数据时，如果传递 <a class="reference internal" href="../libraries/time.html"><span class="doc">Time</span></a> 实例，它们会被转换为字符串格式。转换使用的格式定义在 <a class="reference internal" href="../database/configuration.html#database-config-explanation-of-values"><span class="std std-ref">数据库配置</span></a> 的 <code class="docutils literal notranslate"><span class="pre">dateFormat['datetime']</span></code> 和 <code class="docutils literal notranslate"><span class="pre">dateFormat['date']</span></code> 中。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>在 v4.5.0 之前，Model 类中日期/时间格式硬编码为 <code class="docutils literal notranslate"><span class="pre">Y-m-d</span> <span class="pre">H:i:s</span></code> 和 <code class="docutils literal notranslate"><span class="pre">Y-m-d</span></code>。</p>
</div>
</section>
</section>
<section id="id23">
<h3><a class="toc-backref" href="#id87" role="doc-backlink">删除数据</a><a class="headerlink" href="#id23" title="此标题的永久链接"></a></h3>
<section id="delete">
<h4><a class="toc-backref" href="#id88" role="doc-backlink">delete()</a><a class="headerlink" href="#delete" title="此标题的永久链接"></a></h4>
<p>以主键值作为第一个参数，从模型表中删除匹配记录：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">delete</span><span class="p">(</span><span class="mi">12</span><span class="p">);</span>
</pre></div>
</div>
<p>如果模型的 <a class="reference internal" href="#usesoftdeletes">$useSoftDeletes</a> 值为 true，此操作会将行的 <code class="docutils literal notranslate"><span class="pre">deleted_at</span></code> 设为当前日期时间。通过将第二个参数设为 true 可强制永久删除。</p>
<p>传递主键数组作为第一个参数可批量删除多条记录：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">delete</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]);</span>
</pre></div>
</div>
<p>不传递参数时，其行为类似于 查询构建器 的 delete 方法，需要预先调用 where 条件：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">delete</span><span class="p">();</span>
</pre></div>
</div>
</section>
<section id="purgedeleted">
<h4><a class="toc-backref" href="#id89" role="doc-backlink">purgeDeleted()</a><a class="headerlink" href="#purgedeleted" title="此标题的永久链接"></a></h4>
<p>通过永久删除所有 ‘deleted_at IS NOT NULL’ 的行来清理数据库表：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">purgeDeleted</span><span class="p">();</span>
</pre></div>
</div>
</section>
</section>
<section id="in-model-validation">
<span id="id24"></span><h3><a class="toc-backref" href="#id90" role="doc-backlink">模型内验证</a><a class="headerlink" href="#in-model-validation" title="此标题的永久链接"></a></h3>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>模型内验证在数据存储到数据库之前执行。在此之前数据尚未验证。在验证前处理用户输入数据可能引入安全漏洞。</p>
</div>
<section id="id25">
<h4><a class="toc-backref" href="#id91" role="doc-backlink">验证数据</a><a class="headerlink" href="#id25" title="此标题的永久链接"></a></h4>
<p>Model 类提供在通过 <code class="docutils literal notranslate"><span class="pre">insert()</span></code>、<code class="docutils literal notranslate"><span class="pre">update()</span></code> 或 <code class="docutils literal notranslate"><span class="pre">save()</span></code> 方法保存到数据库前自动验证数据的功能。</p>
<div class="admonition important">
<p class="admonition-title">重要</p>
<p>更新数据时，默认情况下模型类中的验证仅验证提供的字段，以避免在更新部分字段时出现验证错误。</p>
<p>这意味着并非所有设置的验证规则都会在更新时检查。因此不完整数据可能通过验证。</p>
<p>例如，需要其他字段值的 <code class="docutils literal notranslate"><span class="pre">required*</span></code> 规则或 <code class="docutils literal notranslate"><span class="pre">is_unique</span></code> 规则可能无法按预期工作。</p>
<p>为避免此类问题，可通过配置更改此行为。详见 <a class="reference internal" href="#clean-validation-rules"><span class="std std-ref">$cleanValidationRules</span></a>。</p>
</div>
</section>
<section id="model-setting-validation-rules">
<span id="id26"></span><h4><a class="toc-backref" href="#id92" role="doc-backlink">设置验证规则</a><a class="headerlink" href="#model-setting-validation-rules" title="此标题的永久链接"></a></h4>
<p>第一步是在 <a class="reference internal" href="#validationrules">$validationRules</a> 类属性中填写要应用的字段和规则。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>内置验证规则列表参见 <a class="reference internal" href="../libraries/validation.html#validation-available-rules"><span class="std std-ref">可用规则</span></a>。</p>
</div>
<p>如果有自定义错误信息，可将其放入 <a class="reference internal" href="#validationmessages">$validationMessages</a> 数组：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">namespace</span> <span class="nx">App\Models</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">CodeIgniter\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">UserModel</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="c1">// ...</span>

    <span class="k">protected</span> <span class="nv">$validationRules</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;username&#39;</span>     <span class="o">=&gt;</span> <span class="s1">&#39;required|max_length[30]|alpha_numeric_space|min_length[3]&#39;</span><span class="p">,</span>
        <span class="s1">&#39;email&#39;</span>        <span class="o">=&gt;</span> <span class="s1">&#39;required|max_length[254]|valid_email|is_unique[users.email]&#39;</span><span class="p">,</span>
        <span class="s1">&#39;password&#39;</span>     <span class="o">=&gt;</span> <span class="s1">&#39;required|max_length[255]|min_length[8]&#39;</span><span class="p">,</span>
        <span class="s1">&#39;pass_confirm&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;required_with[password]|max_length[255]|matches[password]&#39;</span><span class="p">,</span>
    <span class="p">];</span>
    <span class="k">protected</span> <span class="nv">$validationMessages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;email&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s1">&#39;is_unique&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Sorry. That email has already been taken. Please choose another.&#39;</span><span class="p">,</span>
        <span class="p">],</span>
    <span class="p">];</span>
<span class="p">}</span>
</pre></div>
</div>
<p>如果更愿意在 <a class="reference internal" href="../libraries/validation.html#saving-validation-rules-to-config-file"><span class="std std-ref">验证配置文件</span></a> 中组织规则和错误信息，可创建验证规则组并将 <a class="reference internal" href="#validationrules">$validationRules</a> 设为组名：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">namespace</span> <span class="nx">App\Models</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">CodeIgniter\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">UserModel</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="c1">// ...</span>

    <span class="k">protected</span> <span class="nv">$validationRules</span> <span class="o">=</span> <span class="s1">&#39;users&#39;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>也可以通过函数设置字段验证规则：</p>
<span class="target" id="namespace-CodeIgniter"></span><dl class="php class">
<dt class="sig sig-object php" id="CodeIgniter\Model">
<em class="property"><span class="pre">class</span> </em><span class="sig-prename descclassname"><span class="pre">CodeIgniter\</span></span><span class="sig-name descname"><span class="pre">Model</span></span><a class="headerlink" href="#CodeIgniter\Model" title="永久链接至目标"></a></dt>
<dd></dd></dl>

<dl class="php method">
<dt class="sig sig-object php" id="CodeIgniter\Model::setValidationRule">
<span class="sig-prename descclassname"><span class="pre">CodeIgniter\Model::</span></span><span class="sig-name descname"><span class="pre">setValidationRule</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="pre">$field</span></em>, <em class="sig-param"><span class="pre">$fieldRules</span></em><span class="sig-paren">)</span><a class="headerlink" href="#CodeIgniter\Model::setValidationRule" title="永久链接至目标"></a></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">参数<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>$field</strong> (<span><code class="xref php php-obj docutils literal notranslate"><span class="pre">string</span></code></span>) – </p></li>
<li><p><strong>$fieldRules</strong> (<span><code class="xref php php-obj docutils literal notranslate"><span class="pre">array</span></code></span>) – </p></li>
</ul>
</dd>
</dl>
<p>此函数设置字段验证规则。</p>
<p>使用示例：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="nv">$fieldName</span>  <span class="o">=</span> <span class="s1">&#39;username&#39;</span><span class="p">;</span>
<span class="nv">$fieldRules</span> <span class="o">=</span> <span class="s1">&#39;required|max_length[30]|alpha_numeric_space|min_length[3]&#39;</span><span class="p">;</span>

<span class="nv">$model</span><span class="o">-&gt;</span><span class="na">setValidationRule</span><span class="p">(</span><span class="nv">$fieldName</span><span class="p">,</span> <span class="nv">$fieldRules</span><span class="p">);</span>
</pre></div>
</div>
</dd></dl>

<dl class="php method">
<dt class="sig sig-object php" id="CodeIgniter\Model::setValidationRules">
<span class="sig-prename descclassname"><span class="pre">CodeIgniter\Model::</span></span><span class="sig-name descname"><span class="pre">setValidationRules</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="pre">$validationRules</span></em><span class="sig-paren">)</span><a class="headerlink" href="#CodeIgniter\Model::setValidationRules" title="永久链接至目标"></a></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">参数<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>$validationRules</strong> (<span><code class="xref php php-obj docutils literal notranslate"><span class="pre">array</span></code></span>) – </p></li>
</ul>
</dd>
</dl>
<p>此函数设置验证规则。</p>
<p>使用示例：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="nv">$validationRules</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;username&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;required|max_length[30]|alpha_numeric_space|min_length[3]&#39;</span><span class="p">,</span>
    <span class="s1">&#39;email&#39;</span>    <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="s1">&#39;rules&#39;</span>  <span class="o">=&gt;</span> <span class="s1">&#39;required|max_length[254]|valid_email|is_unique[users.email]&#39;</span><span class="p">,</span>
        <span class="s1">&#39;errors&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s1">&#39;required&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;We really need your email.&#39;</span><span class="p">,</span>
        <span class="p">],</span>
    <span class="p">],</span>
<span class="p">];</span>
<span class="nv">$model</span><span class="o">-&gt;</span><span class="na">setValidationRules</span><span class="p">(</span><span class="nv">$validationRules</span><span class="p">);</span>
</pre></div>
</div>
</dd></dl>

<p>通过函数设置字段验证信息：</p>
<dl class="php method">
<dt class="sig sig-object php" id="CodeIgniter\Model::setValidationMessage">
<span class="sig-prename descclassname"><span class="pre">CodeIgniter\Model::</span></span><span class="sig-name descname"><span class="pre">setValidationMessage</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="pre">$field</span></em>, <em class="sig-param"><span class="pre">$fieldMessages</span></em><span class="sig-paren">)</span><a class="headerlink" href="#CodeIgniter\Model::setValidationMessage" title="永久链接至目标"></a></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">参数<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>$field</strong> (<span><code class="xref php php-obj docutils literal notranslate"><span class="pre">string</span></code></span>) – </p></li>
<li><p><strong>$fieldMessages</strong> (<span><code class="xref php php-obj docutils literal notranslate"><span class="pre">array</span></code></span>) – </p></li>
</ul>
</dd>
</dl>
<p>此函数设置字段错误信息。</p>
<p>使用示例：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="nv">$fieldName</span>              <span class="o">=</span> <span class="s1">&#39;name&#39;</span><span class="p">;</span>
<span class="nv">$fieldValidationMessage</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;required&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Your name is required here&#39;</span><span class="p">,</span>
<span class="p">];</span>
<span class="nv">$model</span><span class="o">-&gt;</span><span class="na">setValidationMessage</span><span class="p">(</span><span class="nv">$fieldName</span><span class="p">,</span> <span class="nv">$fieldValidationMessage</span><span class="p">);</span>
</pre></div>
</div>
</dd></dl>

<dl class="php method">
<dt class="sig sig-object php" id="CodeIgniter\Model::setValidationMessages">
<span class="sig-prename descclassname"><span class="pre">CodeIgniter\Model::</span></span><span class="sig-name descname"><span class="pre">setValidationMessages</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="pre">$fieldMessages</span></em><span class="sig-paren">)</span><a class="headerlink" href="#CodeIgniter\Model::setValidationMessages" title="永久链接至目标"></a></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">参数<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>$fieldMessages</strong> (<span><code class="xref php php-obj docutils literal notranslate"><span class="pre">array</span></code></span>) – </p></li>
</ul>
</dd>
</dl>
<p>此函数设置字段信息。</p>
<p>使用示例：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="nv">$fieldValidationMessage</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="s1">&#39;required&#39;</span>   <span class="o">=&gt;</span> <span class="s1">&#39;Your baby name is missing.&#39;</span><span class="p">,</span>
        <span class="s1">&#39;min_length&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Too short, man!&#39;</span><span class="p">,</span>
    <span class="p">],</span>
<span class="p">];</span>
<span class="nv">$model</span><span class="o">-&gt;</span><span class="na">setValidationMessages</span><span class="p">(</span><span class="nv">$fieldValidationMessage</span><span class="p">);</span>
</pre></div>
</div>
</dd></dl>

</section>
<section id="id27">
<h4><a class="toc-backref" href="#id93" role="doc-backlink">获取验证结果</a><a class="headerlink" href="#id27" title="此标题的永久链接"></a></h4>
<p>当调用 <code class="docutils literal notranslate"><span class="pre">insert()</span></code>、<code class="docutils literal notranslate"><span class="pre">update()</span></code> 或 <code class="docutils literal notranslate"><span class="pre">save()</span></code> 方法时，数据会被验证。如果验证失败，模型返回布尔值 <strong>false</strong>。</p>
</section>
<section id="model-getting-validation-errors">
<span id="id28"></span><h4><a class="toc-backref" href="#id94" role="doc-backlink">获取验证错误</a><a class="headerlink" href="#model-getting-validation-errors" title="此标题的永久链接"></a></h4>
<p>使用 <code class="docutils literal notranslate"><span class="pre">errors()</span></code> 方法获取验证错误：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">if</span> <span class="p">(</span><span class="nv">$model</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">(</span><span class="nv">$data</span><span class="p">)</span> <span class="o">===</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">view</span><span class="p">(</span><span class="s1">&#39;updateUser&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;errors&#39;</span> <span class="o">=&gt;</span> <span class="nv">$model</span><span class="o">-&gt;</span><span class="na">errors</span><span class="p">()]);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>返回包含字段名及其关联错误的数组，可用于在表单顶部显示所有错误或单独显示：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$errors</span><span class="p">))</span><span class="o">:</span> <span class="cp">?&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;alert alert-danger&quot;</span><span class="p">&gt;</span>
    <span class="cp">&lt;?php</span> <span class="k">foreach</span> <span class="p">(</span><span class="nv">$errors</span> <span class="k">as</span> <span class="nv">$field</span> <span class="o">=&gt;</span> <span class="nv">$error</span><span class="p">)</span><span class="o">:</span> <span class="cp">?&gt;</span>
        <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span><span class="cp">&lt;?</span><span class="o">=</span> <span class="nx">esc</span><span class="p">(</span><span class="nv">$error</span><span class="p">)</span> <span class="cp">?&gt;</span><span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
    <span class="cp">&lt;?php</span> <span class="k">endforeach</span> <span class="cp">?&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">endif</span> <span class="cp">?&gt;</span>
</pre></div>
</div>
</section>
<section id="id29">
<h4><a class="toc-backref" href="#id95" role="doc-backlink">检索验证规则</a><a class="headerlink" href="#id29" title="此标题的永久链接"></a></h4>
<p>可通过访问 <code class="docutils literal notranslate"><span class="pre">validationRules</span></code> 属性检索模型的验证规则：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="nv">$rules</span> <span class="o">=</span> <span class="nv">$model</span><span class="o">-&gt;</span><span class="na">validationRules</span><span class="p">;</span>
</pre></div>
</div>
<p>也可通过调用访问方法直接检索规则子集（带选项）：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="nv">$rules</span> <span class="o">=</span> <span class="nv">$model</span><span class="o">-&gt;</span><span class="na">getValidationRules</span><span class="p">(</span><span class="nv">$options</span><span class="p">);</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">$options</span></code> 参数是包含一个元素的关联数组，其键为 <code class="docutils literal notranslate"><span class="pre">'except'</span></code> 或 <code class="docutils literal notranslate"><span class="pre">'only'</span></code>，值为相关字段名数组：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="c1">// get the rules for all but the &quot;username&quot; field</span>
<span class="nv">$rules</span> <span class="o">=</span> <span class="nv">$model</span><span class="o">-&gt;</span><span class="na">getValidationRules</span><span class="p">([</span><span class="s1">&#39;except&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]]);</span>
<span class="c1">// get the rules for only the &quot;city&quot; and &quot;state&quot; fields</span>
<span class="nv">$rules</span> <span class="o">=</span> <span class="nv">$model</span><span class="o">-&gt;</span><span class="na">getValidationRules</span><span class="p">([</span><span class="s1">&#39;only&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;city&#39;</span><span class="p">,</span> <span class="s1">&#39;state&#39;</span><span class="p">]]);</span>
</pre></div>
</div>
</section>
<section id="id30">
<h4><a class="toc-backref" href="#id96" role="doc-backlink">验证占位符</a><a class="headerlink" href="#id30" title="此标题的永久链接"></a></h4>
<p>模型提供简单方法来替换规则中基于传入数据的部分。这在 <code class="docutils literal notranslate"><span class="pre">is_unique</span></code> 验证规则中特别有用。占位符是由花括号包围的字段名（或数组键），会被匹配传入字段的 <strong>值</strong> 替换。示例：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">namespace</span> <span class="nx">App\Models</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">CodeIgniter\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">MyModel</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="c1">// ...</span>

    <span class="k">protected</span> <span class="nv">$validationRules</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;id&#39;</span>    <span class="o">=&gt;</span> <span class="s1">&#39;max_length[19]|is_natural_no_zero&#39;</span><span class="p">,</span>
        <span class="s1">&#39;email&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;required|max_length[254]|valid_email|is_unique[users.email,id,{id}]&#39;</span><span class="p">,</span>
    <span class="p">];</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>自 v4.3.5 起，必须为占位符字段（<code class="docutils literal notranslate"><span class="pre">id</span></code>）设置验证规则。</p>
</div>
<p>在此规则集中，声明电子邮件地址在数据库中应唯一，除了 id 匹配占位符值的行。假设表单 POST 数据如下：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="nv">$_POST</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;id&#39;</span>    <span class="o">=&gt;</span> <span class="mi">4</span><span class="p">,</span>
    <span class="s1">&#39;email&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;foo@example.com&#39;</span><span class="p">,</span>
<span class="p">];</span>
</pre></div>
</div>
<p>则 <code class="docutils literal notranslate"><span class="pre">{id}</span></code> 占位符会被替换为数字 <strong>4</strong>，生成修订后的规则：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">namespace</span> <span class="nx">App\Models</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">CodeIgniter\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">MyModel</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="c1">// ...</span>

    <span class="k">protected</span> <span class="nv">$validationRules</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;id&#39;</span>    <span class="o">=&gt;</span> <span class="s1">&#39;max_length[19]|is_natural_no_zero&#39;</span><span class="p">,</span>
        <span class="s1">&#39;email&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;required|max_length[254]|valid_email|is_unique[users.email,id,4]&#39;</span><span class="p">,</span>
    <span class="p">];</span>
<span class="p">}</span>
</pre></div>
</div>
<p>因此在校验电子邮件唯一性时，会忽略数据库中 <code class="docutils literal notranslate"><span class="pre">id=4</span></code> 的行。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>自 v4.3.5 起，如果占位符（<code class="docutils literal notranslate"><span class="pre">id</span></code>）值未通过验证，占位符不会被替换。</p>
</div>
<p>只要注意动态键不与表单数据冲突，这也可用于在运行时创建更动态的规则。</p>
</section>
</section>
<section id="id31">
<h3><a class="toc-backref" href="#id97" role="doc-backlink">保护字段</a><a class="headerlink" href="#id31" title="此标题的永久链接"></a></h3>
<p>为防止大规模赋值攻击，Model 类 <strong>要求</strong> 在 <a class="reference internal" href="#allowedfields">$allowedFields</a> 类属性中列出所有可在插入和更新时修改的字段名。超出这些字段的数据会在触及数据库前被移除。这能有效防止时间戳或主键被修改。</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">namespace</span> <span class="nx">App\Models</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">CodeIgniter\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">MyModel</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="c1">// ...</span>

    <span class="k">protected</span> <span class="nv">$allowedFields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;email&#39;</span><span class="p">,</span> <span class="s1">&#39;address&#39;</span><span class="p">];</span>
<span class="p">}</span>
</pre></div>
</div>
<p>有时需要在测试、迁移或种子数据时修改这些元素。此时可开关保护：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="nv">$model</span><span class="o">-&gt;</span><span class="na">protect</span><span class="p">(</span><span class="k">false</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="na">insert</span><span class="p">(</span><span class="nv">$data</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="na">protect</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
</pre></div>
</div>
</section>
<section id="id32">
<h3><a class="toc-backref" href="#id98" role="doc-backlink">运行时返回类型变更</a><a class="headerlink" href="#id32" title="此标题的永久链接"></a></h3>
<p>可通过类属性 <a class="reference internal" href="#returntype">$returnType</a> 指定使用 <strong>find*()</strong> 方法时数据的返回格式。有时可能需要不同格式的数据。模型提供方法实现这一点。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>这些方法仅改变下一次 <strong>find*()</strong> 方法调用的返回类型，之后会重置为默认值。</p>
</div>
<section id="asarray">
<h4><a class="toc-backref" href="#id99" role="doc-backlink">asArray()</a><a class="headerlink" href="#asarray" title="此标题的永久链接"></a></h4>
<p>将下一次 <strong>find*()</strong> 方法的数据作为关联数组返回：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="nv">$users</span> <span class="o">=</span> <span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">asArray</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="s1">&#39;active&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">findAll</span><span class="p">();</span>
</pre></div>
</div>
</section>
<section id="asobject">
<h4><a class="toc-backref" href="#id100" role="doc-backlink">asObject()</a><a class="headerlink" href="#asobject" title="此标题的永久链接"></a></h4>
<p>将下一次 <strong>find*()</strong> 方法的数据作为标准对象或自定义类实例返回：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="c1">// Return as standard objects</span>
<span class="nv">$users</span> <span class="o">=</span> <span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">asObject</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="s1">&#39;active&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">findAll</span><span class="p">();</span>

<span class="c1">// Return as custom class instances</span>
<span class="nv">$users</span> <span class="o">=</span> <span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">asObject</span><span class="p">(</span><span class="s1">&#39;User&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="s1">&#39;active&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">findAll</span><span class="p">();</span>
</pre></div>
</div>
</section>
</section>
<section id="id33">
<h3><a class="toc-backref" href="#id101" role="doc-backlink">处理大量数据</a><a class="headerlink" href="#id33" title="此标题的永久链接"></a></h3>
<p>处理大量数据时可能存在内存不足风险。可使用 chunk() 方法获取小块数据进行处理。第一个参数是单块检索的行数，第二个参数是处理每行数据的闭包。</p>
<p>此方法适用于定时任务、数据导出等大型任务。</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">chunk</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="k">static</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$data</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// do something.</span>
    <span class="c1">// $data is a single row of data.</span>
<span class="p">});</span>
</pre></div>
</div>
</section>
</section>
<section id="model-events-callbacks">
<span id="id34"></span><h2><a class="toc-backref" href="#id102" role="doc-backlink">使用查询构建器</a><a class="headerlink" href="#model-events-callbacks" title="此标题的永久链接"></a></h2>
<section id="id35">
<h3><a class="toc-backref" href="#id103" role="doc-backlink">获取模型的查询构建器</a><a class="headerlink" href="#id35" title="此标题的永久链接"></a></h3>
<p>CodeIgniter 模型有一个针对模型数据库连接的查询构建器实例。可随时访问此 <strong>共享</strong> 实例：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="nv">$builder</span> <span class="o">=</span> <span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">builder</span><span class="p">();</span>
</pre></div>
</div>
<p>此构建器已配置模型的 <a class="reference internal" href="#table">$table</a>。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>获取查询构建器实例后，可调用 <a class="reference internal" href="../database/query_builder.html"><span class="doc">查询构建器</span></a> 的方法。但由于查询构建器不是模型，不能调用模型的方法。</p>
</div>
</section>
<section id="id36">
<h3><a class="toc-backref" href="#id104" role="doc-backlink">获取其他表的查询构建器</a><a class="headerlink" href="#id36" title="此标题的永久链接"></a></h3>
<p>如需访问其他表，可获取另一个查询构建器实例。传递表名作为参数，但注意这会返回 <strong>非共享</strong> 实例：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="nv">$groupBuilder</span> <span class="o">=</span> <span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">builder</span><span class="p">(</span><span class="s1">&#39;groups&#39;</span><span class="p">);</span>
</pre></div>
</div>
</section>
<section id="id37">
<h3><a class="toc-backref" href="#id105" role="doc-backlink">混合使用查询构建器和模型方法</a><a class="headerlink" href="#id37" title="此标题的永久链接"></a></h3>
<p>可在同一链式调用中混合使用查询构建器方法和模型的 CRUD 方法，实现优雅操作：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="nv">$users</span> <span class="o">=</span> <span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="s1">&#39;active&#39;</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="na">orderBy</span><span class="p">(</span><span class="s1">&#39;last_login&#39;</span><span class="p">,</span> <span class="s1">&#39;asc&#39;</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="na">findAll</span><span class="p">();</span>
</pre></div>
</div>
<p>此例中，操作的是模型持有的查询构建器共享实例。</p>
<div class="admonition important">
<p class="admonition-title">重要</p>
<p>模型并非查询构建器的完美接口。模型和查询构建器是不同目的的独立类，不应期望返回相同数据。</p>
</div>
<p>如果查询构建器返回结果，则原样返回。此时结果可能与模型方法返回的不同，且可能不符合预期。不会触发模型事件。</p>
<p>为避免意外行为，请勿在方法链末尾使用返回结果的查询构建器方法并指定模型方法。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>也可无缝访问模型的数据库连接：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="nv">$userName</span> <span class="o">=</span> <span class="nv">$userModel</span><span class="o">-&gt;</span><span class="na">escape</span><span class="p">(</span><span class="nv">$name</span><span class="p">);</span>
</pre></div>
</div>
</div>
</section>
</section>
<section id="model-events">
<span id="id38"></span><h2><a class="toc-backref" href="#id106" role="doc-backlink">模型事件</a><a class="headerlink" href="#model-events" title="此标题的永久链接"></a></h2>
<p>在模型执行的多个节点可指定多个回调方法。这些方法可用于规范化数据、哈希密码、保存关联实体等。</p>
<p>以下执行节点可通过类属性设置回调：</p>
<ul class="simple">
<li><p><a class="reference internal" href="#beforeinsert">$beforeInsert</a>, <a class="reference internal" href="#afterinsert">$afterInsert</a></p></li>
<li><p><a class="reference internal" href="#beforeupdate">$beforeUpdate</a>, <a class="reference internal" href="#afterupdate">$afterUpdate</a></p></li>
<li><p><a class="reference internal" href="#beforefind">$beforeFind</a>, <a class="reference internal" href="#afterfind">$afterFind</a></p></li>
<li><p><a class="reference internal" href="#beforedelete">$beforeDelete</a>, <a class="reference internal" href="#afterdelete">$afterDelete</a></p></li>
<li><p><a class="reference internal" href="#beforeinsertbatch">$beforeInsertBatch</a>, <a class="reference internal" href="#afterinsertbatch">$afterInsertBatch</a></p></li>
<li><p><a class="reference internal" href="#beforeupdatebatch">$beforeUpdateBatch</a>, <a class="reference internal" href="#afterupdatebatch">$afterUpdateBatch</a></p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p><code class="docutils literal notranslate"><span class="pre">$beforeInsertBatch</span></code>、<code class="docutils literal notranslate"><span class="pre">$afterInsertBatch</span></code>、<code class="docutils literal notranslate"><span class="pre">$beforeUpdateBatch</span></code> 和 <code class="docutils literal notranslate"><span class="pre">$afterUpdateBatch</span></code> 自 v4.3.0 起可用。</p>
</div>
<section id="id39">
<h3><a class="toc-backref" href="#id107" role="doc-backlink">定义回调</a><a class="headerlink" href="#id39" title="此标题的永久链接"></a></h3>
<p>首先在模型中创建新类方法作为回调。</p>
<p>此方法始终接收 <code class="docutils literal notranslate"><span class="pre">$data</span></code> 数组作为唯一参数。</p>
<p><code class="docutils literal notranslate"><span class="pre">$data</span></code> 数组的具体内容因事件而异，但始终包含键名为 <code class="docutils literal notranslate"><span class="pre">data</span></code> 的主要数据。对于 <strong>insert*()</strong> 或 <strong>update*()</strong> 方法，这是要插入/更新到数据库的键值对。主 <code class="docutils literal notranslate"><span class="pre">$data</span></code> 数组还包含传递给方法的其他值，详见 <a class="reference internal" href="#id41">事件参数</a>。</p>
<p>回调方法必须返回原始 <code class="docutils literal notranslate"><span class="pre">$data</span></code> 数组以便其他回调使用完整信息。</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">namespace</span> <span class="nx">App\Models</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">CodeIgniter\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">MyModel</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="c1">// ...</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="nf">hashPassword</span><span class="p">(</span><span class="k">array</span> <span class="nv">$data</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;password&#39;</span><span class="p">]))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nv">$data</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nv">$data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;password_hash&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">password_hash</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;password&#39;</span><span class="p">],</span> <span class="nx">PASSWORD_DEFAULT</span><span class="p">);</span>
        <span class="nb">unset</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;password&#39;</span><span class="p">]);</span>

        <span class="k">return</span> <span class="nv">$data</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="id40">
<h3><a class="toc-backref" href="#id108" role="doc-backlink">指定运行的回调</a><a class="headerlink" href="#id40" title="此标题的永久链接"></a></h3>
<p>通过将方法名添加到相应的类属性（<a class="reference internal" href="#beforeinsert">$beforeInsert</a>、<a class="reference internal" href="#afterupdate">$afterUpdate</a> 等）来指定回调运行时机。单个事件可添加多个回调并按序处理。同一回调可用于多个事件：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">namespace</span> <span class="nx">App\Models</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">CodeIgniter\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">MyModel</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="c1">// ...</span>

    <span class="k">protected</span> <span class="nv">$beforeInsert</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;hashPassword&#39;</span><span class="p">];</span>
    <span class="k">protected</span> <span class="nv">$beforeUpdate</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;hashPassword&#39;</span><span class="p">];</span>

    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>此外，每个模型可通过设置 <a class="reference internal" href="#allowcallbacks">$allowCallbacks</a> 属性全局允许（默认）或禁止回调：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">namespace</span> <span class="nx">App\Models</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">CodeIgniter\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">MyModel</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="c1">// ...</span>

    <span class="k">protected</span> <span class="nv">$allowCallbacks</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>

    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>也可使用 <code class="docutils literal notranslate"><span class="pre">allowCallbacks()</span></code> 方法临时更改单个模型调用的设置：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="nv">$model</span><span class="o">-&gt;</span><span class="na">allowCallbacks</span><span class="p">(</span><span class="k">false</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="c1">// No callbacks triggered</span>
<span class="nv">$model</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="c1">// Callbacks subject to original property value</span>
</pre></div>
</div>
</section>
<section id="id41">
<h3><a class="toc-backref" href="#id109" role="doc-backlink">事件参数</a><a class="headerlink" href="#id41" title="此标题的永久链接"></a></h3>
<p>各事件传递给回调的 <code class="docutils literal notranslate"><span class="pre">$data</span></code> 参数内容如下：</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>事件</p></th>
<th class="head"><p>$data 内容</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>beforeInsert</p></td>
<td><p><strong>data</strong> = 要插入的键值对。如果向 <code class="docutils literal notranslate"><span class="pre">insert()</span></code> 传递对象或 Entity 类，会先转换为数组。</p></td>
</tr>
<tr class="row-odd"><td><p>afterInsert</p></td>
<td><p><strong>id</strong> = 新行的主键，失败时为 0。
<strong>data</strong> = 要插入的键值对。
<strong>result</strong> = 通过查询构建器使用的 <code class="docutils literal notranslate"><span class="pre">insert()</span></code> 方法结果。</p></td>
</tr>
<tr class="row-even"><td><p>beforeUpdate</p></td>
<td><p><strong>id</strong> = 传递给 <code class="docutils literal notranslate"><span class="pre">update()</span></code> 方法的主键数组。
<strong>data</strong> = 要更新的键值对。如果向 <code class="docutils literal notranslate"><span class="pre">update()</span></code> 传递对象或 Entity 类，会先转换为数组。</p></td>
</tr>
<tr class="row-odd"><td><p>afterUpdate</p></td>
<td><p><strong>id</strong> = 传递给 <code class="docutils literal notranslate"><span class="pre">update()</span></code> 方法的主键数组。
<strong>data</strong> = 要更新的键值对。
<strong>result</strong> = 通过查询构建器使用的 <code class="docutils literal notranslate"><span class="pre">update()</span></code> 方法结果。</p></td>
</tr>
<tr class="row-even"><td><p>beforeFind</p></td>
<td><p>调用 <strong>方法</strong> 的名称，是否请求 <strong>单例</strong>，以及以下附加字段：</p></td>
</tr>
<tr class="row-odd"><td><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">first()</span></code></p></li>
</ul>
</td>
<td><p>无附加字段</p></td>
</tr>
<tr class="row-even"><td><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">find()</span></code></p></li>
</ul>
</td>
<td><p><strong>id</strong> = 要搜索行的主键。</p></td>
</tr>
<tr class="row-odd"><td><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">findAll()</span></code></p></li>
</ul>
</td>
<td><p><strong>limit</strong> = 要查找的行数。
<strong>offset</strong> = 搜索期间跳过的行数。</p></td>
</tr>
<tr class="row-even"><td><p>afterFind</p></td>
<td><p>同 <strong>beforeFind</strong>，但包含结果数据行（无结果时为 null）。</p></td>
</tr>
<tr class="row-odd"><td><p>beforeDelete</p></td>
<td><p><strong>id</strong> = 传递给 <code class="docutils literal notranslate"><span class="pre">delete()</span></code> 方法的主键。
<strong>purge</strong> = 是否硬删除软删除行的布尔值。</p></td>
</tr>
<tr class="row-even"><td><p>afterDelete</p></td>
<td><p><strong>id</strong> = 传递给 <code class="docutils literal notranslate"><span class="pre">delete()</span></code> 方法的主键。
<strong>purge</strong> = 是否硬删除软删除行的布尔值。
<strong>result</strong> = 查询构建器上 <code class="docutils literal notranslate"><span class="pre">delete()</span></code> 调用的结果。
<strong>data</strong> = 未使用。</p></td>
</tr>
<tr class="row-odd"><td><p>beforeInsertBatch</p></td>
<td><p><strong>data</strong> = 要插入的值的关联数组。如果向 <code class="docutils literal notranslate"><span class="pre">insertBatch()</span></code> 传递对象或 Entity 类，会先转换为数组。</p></td>
</tr>
<tr class="row-even"><td><p>afterInsertBatch</p></td>
<td><p><strong>data</strong> = 要插入的值的关联数组。
<strong>result</strong> = 通过查询构建器使用的 <code class="docutils literal notranslate"><span class="pre">insertbatch()</span></code> 方法结果。</p></td>
</tr>
<tr class="row-odd"><td><p>beforeUpdateBatch</p></td>
<td><p><strong>data</strong> = 要更新的值的关联数组。如果向 <code class="docutils literal notranslate"><span class="pre">updateBatch()</span></code> 传递对象或 Entity 类，会先转换为数组。</p></td>
</tr>
<tr class="row-even"><td><p>afterUpdateBatch</p></td>
<td><p><strong>data</strong> = 要更新的键值对。
<strong>result</strong> = 通过查询构建器使用的 <code class="docutils literal notranslate"><span class="pre">updateBatch()</span></code> 方法结果。</p></td>
</tr>
</tbody>
</table>
</section>
<section id="id42">
<h3><a class="toc-backref" href="#id110" role="doc-backlink">修改 Find* 数据</a><a class="headerlink" href="#id42" title="此标题的永久链接"></a></h3>
<p><code class="docutils literal notranslate"><span class="pre">beforeFind</span></code> 和 <code class="docutils literal notranslate"><span class="pre">afterFind</span></code> 方法都可以返回修改后的数据集来覆盖模型的正常响应。对于 <code class="docutils literal notranslate"><span class="pre">afterFind</span></code>，返回数组中 <code class="docutils literal notranslate"><span class="pre">data</span></code> 的任何修改都会自动传递回调用上下文。为了让 <code class="docutils literal notranslate"><span class="pre">beforeFind</span></code> 拦截查找工作流，它还必须返回一个额外的布尔值 <code class="docutils literal notranslate"><span class="pre">returnData</span></code>：</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">namespace</span> <span class="nx">App\Models</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">CodeIgniter\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">MyModel</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="c1">// ...</span>

    <span class="k">protected</span> <span class="nv">$beforeFind</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;checkCache&#39;</span><span class="p">];</span>

    <span class="c1">// ...</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="nf">checkCache</span><span class="p">(</span><span class="k">array</span> <span class="nv">$data</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// Check if the requested item is already in our cache</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$item</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getCachedItem</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]))</span> <span class="p">{</span>
            <span class="nv">$data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>       <span class="o">=</span> <span class="nv">$item</span><span class="p">;</span>
            <span class="nv">$data</span><span class="p">[</span><span class="s1">&#39;returnData&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>

            <span class="k">return</span> <span class="nv">$data</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// ...</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="id43">
<h2><a class="toc-backref" href="#id111" role="doc-backlink">手动创建模型</a><a class="headerlink" href="#id43" title="此标题的永久链接"></a></h2>
<p>你不需要继承任何特殊类来为应用程序创建模型。你只需要获取数据库连接的实例即可开始使用。这允许你绕过 CodeIgniter 模型开箱即用的功能，创建完全自定义的体验。</p>
<div class="highlight-html+php notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">namespace</span> <span class="nx">App\Models</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">CodeIgniter\Database\ConnectionInterface</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">UserModel</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="nv">$db</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nx">ConnectionInterface</span> <span class="nv">$db</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">db</span> <span class="o">=</span> <span class="nv">$db</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="页脚">
        <a href="index.html" class="btn btn-neutral float-left" title="数据建模" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> 上一页</a>
        <a href="entities.html" class="btn btn-neutral float-right" title="使用实体类" accesskey="n" rel="next">下一页 <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2019-2025 CodeIgniter 基金会.
      <span class="lastupdated">最后更新于 2025-02-19.
      </span></p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用的 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a> 开发.
  
<jinja2.runtime.BlockReference object at 0x7fa45efb5bd0>

<div style="margin-top: 16px;">
  <p>由 <a href="https://codeigniter.org.cn">CodeIgniter 中国开发者社区</a>翻译并制作</p>
  <p style="margin-bottom: 0;">
    <a href="https://github.com/CodeIgniter-Chinese/codeigniter4-user-guide" target="_blank">Github 简体中文翻译</a>
    ·
    <a href="https://codeigniter-chinese.github.io/codeigniter4-user-guide/codeigniter_user_guide.zip">离线版压缩包下载</a>
    ·
    <a href="https://codeigniter-chinese.github.io/codeigniter4-user-guide/CodeIgniter.pdf">PDF 版下载</a>
  </p>
</div>


</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(false);
      });
  </script> 

</body>
</html>